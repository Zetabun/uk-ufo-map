<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UK UFO / Alien Sightings Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Leaflet.heat (density layer) -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<!-- PapaParse (CSV) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- noUiSlider -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

  <style>
    :root{
      --bg:#0b0f19;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:rgba(255,255,255,.08);
      --accent:#60a5fa;
      --danger:#ef4444;
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      position:sticky;top:0;z-index:10;
    }
    header .left{display:flex;flex-direction:column;gap:2px}
    header h1{font-size:16px;margin:0;letter-spacing:.2px}
    header p{font-size:12px;margin:0;color:var(--muted)}
    header .right{display:flex;gap:8px;align-items:center}
    .btn{
      appearance:none;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);
      padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px;
    }
    .btn:hover{background:rgba(255,255,255,.07)}
    .wrap{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 58px)}
    #panel{
      border-right:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      padding:14px;
      height:calc(100vh - 58px);
      overflow-y:auto;
      overflow-x:hidden;
      min-height:0;
      -webkit-overflow-scrolling:touch;
    }
    #map{height:100%;width:100%;position:relative;z-index:0;background:var(--bg)}
    .card{background:rgba(17,24,39,.7);border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1;min-width:120px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select{
      width:100%;padding:9px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);color:var(--text);outline:none;
    }
    input::placeholder{color:#6b7280}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{border:1px solid var(--border);border-radius:14px;padding:10px;background:rgba(0,0,0,.18)}
    .kpi .big{font-size:18px;font-weight:700}
    .kpi .small{font-size:12px;color:var(--muted)}
    .status{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:#f59e0b}
    .dot.bad{background:var(--danger)}
    #list{max-height:48vh;overflow:auto;padding-right:4px}
    .item{padding:10px;border:1px solid var(--border);border-radius:14px;background:rgba(0,0,0,.18);margin-bottom:10px;cursor:pointer}
    .item:hover{background:rgba(0,0,0,.28)}
    .item .title{font-weight:650;font-size:13px;margin:0 0 4px 0}
    .item .meta{font-size:12px;color:var(--muted);margin:0}
    .pill{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);margin-right:6px}
    .slider-wrap{padding:6px 2px 2px}
    .slider-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:8px}
    .progress{
      height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid var(--border)
    }
    .progress > div{height:100%;width:0;background:linear-gradient(90deg, var(--accent), #a78bfa)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    .smallbtn{font-size:11px;padding:6px 8px;border-radius:10px}
	
	/* Make Leaflet popups readable (force light-theme text) */
.leaflet-popup-content-wrapper,
.leaflet-popup-tip {
  background: #ffffff !important;
  color: #111827 !important;
}

.leaflet-popup-content{ color:#111827 !important; }
.leaflet-popup-content *{ color:#111827 !important; }.leaflet-popup-content a {
  color: #1d4ed8 !important;
  text-decoration: underline;
  word-break: break-word;
}

.leaflet-popup-content b,
.leaflet-popup-content strong {
  color: #111827 !important;
}

.leaflet-popup-close-button {
  color: #111827 !important;
}

html, body {
  height: 100%;
  margin: 0;
  overflow: hidden;
}
	
/* Slimmer year-range slider (noUiSlider) */
#yearSlider {
  margin-top: 10px;
  margin-bottom: 6px;
}

#yearSlider .noUi-target {
  border: none;
  box-shadow: none;
  height: 8px;              /* track height */
  border-radius: 999px;
}

#yearSlider .noUi-base,
#yearSlider .noUi-connects {
  height: 8px;
  border-radius: 999px;
}

#yearSlider .noUi-connect {
  border-radius: 999px;
}

#yearSlider .noUi-handle {
  width: 18px;              /* handle size */
  height: 18px;
  right: -9px;              /* keeps it centered */
  top: -5px;                /* vertical align to track */
  border-radius: 999px;
  border: 2px solid rgba(255,255,255,0.35);
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
}

#yearSlider .noUi-handle:before,
#yearSlider .noUi-handle:after {
  display: none;            /* removes the two little bars */
}

#yearSlider .noUi-touch-area {
  border-radius: 999px;
}
	
	
/* --- Leaflet popup: modern card styling --- */
.leaflet-popup-content-wrapper{
  border-radius: 18px !important;
  padding: 0 !important;
  box-shadow: 0 18px 50px rgba(0,0,0,0.22) !important;
  border: 1px solid rgba(0,0,0,0.08) !important;
}

.leaflet-popup-tip{
  box-shadow: 0 12px 30px rgba(0,0,0,0.18) !important;
}

.leaflet-popup-content{
  margin: 0 !important;
  width: 360px !important;       /* consistent size */
  max-width: 360px !important;
  font-family: inherit;
  color: #111827;
}

/* Scroll inside popup instead of giant bubbles */
.leaflet-popup-content .popup-inner{
  padding: 16px 16px 14px 16px;
  max-height: 70vh;
  overflow: auto;
}

/* Headings + spacing */
.leaflet-popup-content h3{
  margin: 0 0 6px 0;
  font-size: 18px;
  line-height: 1.2;
  letter-spacing: -0.01em;
}

.leaflet-popup-content .popup-date{
  color: #6b7280;
  font-size: 13px;
  margin: 0 0 12px 0;
}

/* Section labels */
.leaflet-popup-content .k{
  font-weight: 700;
}

/* Subtle divider */
.leaflet-popup-content .divider{
  height: 1px;
  background: rgba(0,0,0,0.08);
  margin: 12px 0;
}

/* Nicer source links */
.leaflet-popup-content a{
  color: #1d4ed8;
  text-decoration: none;
}
.leaflet-popup-content a:hover{
  text-decoration: underline;
}

/* Little tag pills */
.leaflet-popup-content .tags{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin: 8px 0 10px;
}
.leaflet-popup-content .tag{
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 999px;
  background: rgba(0,0,0,0.05);
  border: 1px solid rgba(0,0,0,0.06);
  color: #111827;
}

/* Read more pill (in popup tag row) */
.leaflet-popup-content a.tag.tag-readmore{
  background: rgba(29,78,216,.12);
  border: 1px solid rgba(29,78,216,.30);
  color: #1d4ed8;
  font-weight: 800;
  cursor: pointer;
}
.leaflet-popup-content a.tag.tag-readmore:hover{
  background: rgba(29,78,216,.18);
  text-decoration: none;
}

/* --- Dark dropdowns (select + options) --- */
select, option {
  background: #0b1220;
  color: #e5e7eb;
}

select {
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 14px;
  padding: 10px 12px;
  outline: none;
  box-shadow: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

/* Custom arrow (so it still looks like a dropdown) */
.select-wrap {
  position: relative;
}
.select-wrap::after {
  content: "▾";
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: rgba(229,231,235,0.8);
  font-size: 14px;
}

/* Hover / focus */
select:hover {
  border-color: rgba(255,255,255,0.22);
}
select:focus {
  border-color: rgba(96,165,250,0.7);
  box-shadow: 0 0 0 4px rgba(96,165,250,0.12);
}


/* --- iOS-style toggles --- */
.toggle-row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0}
.toggle-row .label{font-size:12px;color:var(--muted);line-height:1.2}
.switch{position:relative;display:inline-block;width:44px;height:26px;flex:0 0 auto}
.switch input{opacity:0;width:0;height:0}
.slider{
  position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;
  background:rgba(255,255,255,.12);transition:.2s;border-radius:999px;border:1px solid var(--border)
}
.slider:before{
  position:absolute;content:"";height:22px;width:22px;left:2px;top:1px;
  background:white;transition:.2s;border-radius:999px;box-shadow:0 8px 20px rgba(0,0,0,.35)
}
.switch input:checked + .slider{background:rgba(96,165,250,.45);border-color:rgba(96,165,250,.55)}
.switch input:checked + .slider:before{transform:translateX(18px)}
.layer-hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:6px}


/* --- POI bubbles (airports / bases) --- */
.poi-icon{
  width: 30px;
  height: 30px;
  border-radius: 999px;
  position: relative;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 15px;
  box-shadow: 0 12px 28px rgba(0,0,0,.38);
  border: 1px solid rgba(255,255,255,.22);
  background: rgba(17,24,39,.9);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  transform: translateZ(0);
}
.poi-icon::before{
  content:"";
  position:absolute;
  inset:-6px;
  border-radius: 999px;
  background: radial-gradient(circle at 50% 50%, rgba(96,165,250,.35), rgba(96,165,250,0) 62%);
  filter: blur(0.5px);
  opacity: .85;
  pointer-events:none;
}
.poi-airport::before{
  background: radial-gradient(circle at 50% 50%, rgba(34,197,94,.35), rgba(34,197,94,0) 62%);
}
.poi-base::before{
  background: radial-gradient(circle at 50% 50%, rgba(239,68,68,.35), rgba(239,68,68,0) 62%);
}
/* Gentle pulse ring */
.poi-icon::after{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius: 999px;
  border: 2px solid rgba(255,255,255,.14);
  animation: poiPulse 2.6s ease-in-out infinite;
  pointer-events:none;
}
@keyframes poiPulse{
  0%{ transform: scale(1); opacity:.65; }
  70%{ transform: scale(1.35); opacity:0; }
  100%{ transform: scale(1.35); opacity:0; }
}
/* Tooltip styling */
.leaflet-tooltip.poi-tip{
  background: rgba(17,24,39,.94);
  color: #e5e7eb;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 999px;
  padding: 6px 10px;
  box-shadow: 0 12px 30px rgba(0,0,0,.38);
  font-size: 12px;
}
.leaflet-tooltip.poi-tip:before{
  border-top-color: rgba(17,24,39,.94);
}

/* Cluster bubbles for POIs */
.poi-cluster{
  width: 34px;
  height: 34px;
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 800;
  color: #0b0f19;
  border: 1px solid rgba(255,255,255,.22);
  box-shadow: 0 14px 34px rgba(0,0,0,.42);
}
.poi-cluster.airports{ background: rgba(34,197,94,.9); }
.poi-cluster.bases{ background: rgba(239,68,68,.9); }


/* --- POI popup (airports / bases) --- */
.leaflet-popup.poi-popup .leaflet-popup-content-wrapper{
  background: rgba(17,24,39,.96);
  color: #e5e7eb;
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 14px;
  box-shadow: 0 18px 48px rgba(0,0,0,.55);
  padding: 8px 10px;
}
.leaflet-popup.poi-popup .leaflet-popup-content{
  margin: 0;
  line-height: 1.25;
  font-size: 13px;
  min-width: 160px;
  max-width: 260px;
}
.leaflet-popup.poi-popup .leaflet-popup-tip{
  background: rgba(17,24,39,.96);
  border: 1px solid rgba(255,255,255,.14);
}
.leaflet-popup.poi-popup .leaflet-popup-close-button{
  color: rgba(229,231,235,.9);
  width: 28px;
  height: 28px;
  font-size: 18px;
  padding: 2px 6px 0 0;
}
.leaflet-popup.poi-popup .leaflet-popup-close-button:hover{
  color: #fff;
}
.poi-popup-title{
  font-weight: 800;
  font-size: 14px;
  margin: 0 0 2px 0;
}
.poi-popup-sub{
  font-size: 12px;
  color: rgba(229,231,235,.78);
}


/* Popup layout helpers */
.poi-popup-wrap{
  display:flex;
  flex-direction:column;
  gap: 6px;
  padding: 2px 4px 2px 2px;
}
.poi-popup-meta{
  font-size: 11px;
  color: rgba(229,231,235,.65);
}
.poi-popup-actions{
  display:flex;
  gap: 8px;
  margin-top: 2px;
}
.poi-popup-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding: 7px 10px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 700;
  text-decoration: none;
  color: #e5e7eb;
  background: rgba(59,130,246,.18);
  border: 1px solid rgba(59,130,246,.35);
}
.poi-popup-btn:hover{
  background: rgba(59,130,246,.28);
}
.poi-popup-btn.secondary{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
}
.poi-popup-btn.secondary:hover{
  background: rgba(255,255,255,.10);
}
/* Give the close button room so it doesn't overlap content */
.leaflet-popup.poi-popup .leaflet-popup-content-wrapper{
  padding: 10px 36px 10px 12px;
}


/* --- POI popup sizing + override (ensure it actually applies) --- */
.leaflet-popup.poi-popup .leaflet-popup-content-wrapper,
.leaflet-popup.poi-popup .leaflet-popup-tip{
  background: rgba(17,24,39,.96) !important;
}
.leaflet-popup.poi-popup .leaflet-popup-content-wrapper{
  color: #e5e7eb !important;
  border: 1px solid rgba(255,255,255,.14) !important;
  border-radius: 14px !important;
  box-shadow: 0 18px 48px rgba(0,0,0,.55) !important;
  padding: 12px 40px 12px 14px !important; /* room for close button */
  max-width: 260px !important;
}
.leaflet-popup.poi-popup .leaflet-popup-content{
  margin: 0 !important;
  width: auto !important;
  max-width: 230px !important;
}
.leaflet-popup.poi-popup a{
  color: inherit;
}
.poi-popup-wrap{
  max-width: 230px;
}
.poi-popup-title{
  font-size: 16px;
  font-weight: 900;
  letter-spacing: .2px;
}
.poi-popup-sub{
  margin-top: 2px;
}
.poi-popup-actions{
  margin-top: 8px;
}
.poi-popup-btn{
  width: 100%;
  white-space: nowrap;
}


/* --- POI popup (light, match case popups) --- */
.leaflet-popup.poi-popup .leaflet-popup-content-wrapper,
.leaflet-popup.poi-popup .leaflet-popup-tip{
  background: #ffffff !important;
}
.leaflet-popup.poi-popup .leaflet-popup-content-wrapper{
  color: #111827 !important;
  border: 1px solid rgba(17,24,39,.14) !important;
  box-shadow: 0 18px 48px rgba(0,0,0,.20) !important;
}
.leaflet-popup.poi-popup .leaflet-popup-close-button{
  color: #111827 !important;
}
.leaflet-popup.poi-popup .poi-popup-sub,
.leaflet-popup.poi-popup .poi-popup-meta{
  color: rgba(17,24,39,.70) !important;
}
.leaflet-popup.poi-popup .poi-popup-btn{
  background: rgba(29,78,216,.10) !important;
  border: 1px solid rgba(29,78,216,.28) !important;
  color: #111827 !important;
}
.leaflet-popup.poi-popup .poi-popup-btn:hover{
  background: rgba(29,78,216,.16) !important;
}


    /* =========================
       iOS Grey theme (LEFT PANEL)
       ========================= */
    :root{
      --ios-bg:#f2f2f7;
      --ios-card:#ffffff;
      --ios-card2:#f7f7fa;
      --ios-text:#1c1c1e;
      --ios-muted:#6e6e73;
      --ios-border:rgba(60,60,67,0.18);
      --ios-border2:rgba(60,60,67,0.10);
      --ios-accent:#007aff;
      --ios-danger:#ff3b30;
      --ios-ok:#34c759;
      --ios-warn:#ff9f0a;
    }

    /* Only restyle the left sidebar/panel */
    #panel{
      background: var(--ios-bg);
      /* Default to dark text for light surfaces inside the panel */
      color: var(--ios-text);
      border-right: 1px solid var(--ios-border);
    }

    /* Cards + surfaces */
    #panel .card{
      background: rgba(17,24,39,.92);
      border: 1px solid var(--border);
      box-shadow: 0 10px 28px rgba(0,0,0,0.06);
      /* Cards in the panel are dark in this theme, so force light text */
      color: var(--text);
    }
    #panel .kpi{
      background: var(--ios-card2);
      border: 1px solid var(--border);
      /* KPI tiles are light, so force dark text */
      color: var(--ios-text);
    }
    #panel .kpi .big{ color: var(--ios-text); }
    #panel .item{
      background: var(--ios-card2);
      border: 1px solid var(--border);
      /* Result items are light, so force dark text */
      color: var(--ios-text);
    }
    #panel .item .title{ color: var(--ios-text); }
    #panel .item:hover{ background: #ededf3; }

    /* Text */
    #panel label,
    #panel .hint,
    #panel .status,
    #panel .kpi .small,
    #panel .item .meta,
    #panel .layer-hint{
      color: var(--ios-muted);
    }
    #panel a{ color: var(--ios-accent); }
    #panel a:hover{ text-decoration: underline; }

    /* Inputs */
    #panel input,
    #panel select{
      background: rgba(17,24,39,.92);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.5);
    }
    #panel input::placeholder{ color: rgba(110,110,115,0.75); }

    /* Override the global "dark dropdowns" so selects inside the panel are light */
    #panel select,
    #panel option{
      background: rgba(17,24,39,.92) !important;
      color: var(--text) !important;
    }
    #panel select:hover{ border-color: var(--ios-border); }
    #panel select:focus,
    #panel input:focus{
      border-color: rgba(0,122,255,0.55);
      box-shadow: 0 0 0 4px rgba(0,122,255,0.15);
    }

    /* Pills */
    #panel .pill{
      color: var(--ios-muted);
      border: 1px solid var(--border);
      background: rgba(60,60,67,0.06);
    }

    /* Status dots */
    #panel .dot.ok{ background: var(--ios-ok); }
    #panel .dot.warn{ background: var(--ios-warn); }
    #panel .dot.bad{ background: var(--ios-danger); }

    /* Progress */
    #panel .progress{
      background: rgba(60,60,67,0.10);
      border: 1px solid var(--border);
    }
    #panel .progress > div{
      background: linear-gradient(90deg, var(--ios-accent), #5ac8fa);
    }

    /* Slider (noUiSlider) – keep it slim, make it iOS-y */
    #panel #yearSlider .noUi-target{
      background: rgba(60,60,67,0.12);
    }
    #panel #yearSlider .noUi-connect{
      background: var(--ios-accent);
    }
    #panel #yearSlider .noUi-handle{
      background: rgba(17,24,39,.92);
      border: 2px solid rgba(0,122,255,0.35);
      box-shadow: 0 10px 26px rgba(0,0,0,0.14);
    }

    /* iOS-style toggles – match the light panel */
    #panel .slider{
      background: rgba(60,60,67,0.16);
      border: 1px solid var(--border);
    }
    #panel .slider:before{
      background: #ffffff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.18);
    }
    #panel .switch input:checked + .slider{
      background: rgba(0,122,255,0.85);
      border-color: rgba(0,122,255,0.45);
    }

    /* Header inside cards – slightly crisper */
    #panel .card > div[style*="font-weight:700"],
    #panel .card > div[style*="font-weight:650"],
    #panel .card > div[style*="font-weight:800"]{
      color: var(--text);
    }


    /* Mobile drawer (collapsible left panel) */
    #panelToggle{display:none}
    #panelOverlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      z-index:19;
    }

    /* Small edge tab to open/close the drawer on mobile */
    #panelTab{display:none}
    body.panel-open #panelOverlay{display:block}
    @media (max-width: 960px){
      header{display:none}
      .wrap{height:100vh}
      #panelToggle{display:none}
      .wrap{grid-template-columns:1fr}
      #panelTab{
        display:flex;
        position:fixed;
        left:0;
        top:50%;
        transform:translateY(-50%);
        width:34px;
        height:56px;
        align-items:center;
        justify-content:center;
        border:1px solid var(--border);
        background:rgba(17,24,39,.92);
        color:var(--text);
        font-size:20px;
        line-height:1;
        padding:0;
        z-index:21;
        border-radius:0 14px 14px 0;
        box-shadow: 0 10px 28px rgba(0,0,0,0.12);
        cursor:pointer;
        transition:left .25s ease, transform .25s ease;
        user-select:none;
        -webkit-tap-highlight-color: transparent;
      }
      #panelTab:active{ transform:translateY(-50%) scale(0.98); }
      #panel{
        position:fixed;
        background: rgba(17,24,39,.96);
        left:0;
        top:0;
        width:min(360px, 88vw);
        height:100vh;
        transform:translateX(-110%);
        transition:transform .25s ease;
        z-index:20;
        box-shadow: 12px 0 30px rgba(0,0,0,.35);
      }
      body.panel-open #panel{transform:translateX(0)}
    }

/* Read more button (highlighted cases) */
.leaflet-popup-content .readmore-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 6px 10px;
  margin-left: 8px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 800;
  text-decoration: none;
  color: #1d4ed8;
  background: rgba(59,130,246,.10);
  border: 1px solid rgba(59,130,246,.28);
  white-space: nowrap;
}
.leaflet-popup-content .readmore-btn:hover{
  background: rgba(59,130,246,.16);
}
.leaflet-popup-content .summary{
  margin-top: 10px;
}


/* --- Help tooltip for Heatmap toggle --- */
.help-wrap{
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.help-icon{
  width: 18px;
  height: 18px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  line-height: 1;
  font-size: 12px;
  font-weight: 900;
  cursor: pointer;
  user-select: none;
  border: 1px solid rgba(0,122,255,0.35);
  background: rgba(0,122,255,0.12);
  color: var(--ios-accent);
}
.help-icon:hover{ background: rgba(0,122,255,0.18); }
.help-icon:focus{
  outline: none;
  box-shadow: 0 0 0 4px rgba(0,122,255,0.18);
}
.help-bubble{
  position: absolute;
  left: 0;
  top: calc(100% + 10px);
  width: min(320px, 72vw);
  padding: 10px 12px;
  border-radius: 12px;
  background: #ffffff;
  color: #111827;
  border: 1px solid rgba(17,24,39,0.14);
  box-shadow: 0 16px 40px rgba(0,0,0,0.18);
  font-size: 12px;
  line-height: 1.35;
  z-index: 5;
  display: none;
}
.help-bubble::before{
  content: "";
  position: absolute;
  top: -6px;
  left: 34px;
  width: 12px;
  height: 12px;
  background: #ffffff;
  border-left: 1px solid rgba(17,24,39,0.14);
  border-top: 1px solid rgba(17,24,39,0.14);
  transform: rotate(45deg);
}
.help-bubble.is-open{ display: block; }


.popup-actions{ display:flex; gap:10px; align-items:center; margin-top:10px; }
.popup-btn{
  appearance:none; border:1px solid rgba(17,24,39,0.14);
  background:#ffffff; color:#111827;
  padding:6px 10px; border-radius:999px;
  font-weight:700; font-size:12px; cursor:pointer;
}
.popup-btn:hover{ background:#f9fafb; }
.popup-images{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px; margin-top:12px; }
.popup-images a{ display:block; border-radius:12px; overflow:hidden; border:1px solid rgba(17,24,39,0.12); background:#0b1220; }
.popup-images img{ width:100%; height:auto; display:block; max-width:100%; }
.popup-images .single{ grid-column: 1 / -1; }
</style>
</head>

<body>
<header>
  <div class="left">
    <h1>UK UFO / “Alien” Sightings (Curated)</h1>
    <p>Data source: <strong>GOV.UK where possible</strong>. Sources are provided per case.</p>
  </div>
  <div class="right">
    <button class="btn" id="panelToggle" aria-controls="panel" aria-expanded="false">Filters</button>
    <button class="btn" id="fitBtn">Fit to markers</button>
    <button class="btn" id="resetBtn">Reset filters</button>
  </div>
</header>

<div id="panelOverlay" hidden></div>

<button id="panelTab" class="panel-tab" aria-controls="panel" aria-expanded="false" aria-label="Show filters">›</button>

<div class="wrap">
  <aside id="panel">
    <div class="card">
      <div class="kpis">
        <div class="kpi">
          <div class="big" id="kpiTotal">—</div>
          <div class="small">Records loaded</div>
        </div>
        <div class="kpi">
          <div class="big" id="kpiShown">—</div>
          <div class="small">Matching filters</div>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="status">
        <span class="dot warn" id="statusDot"></span>
        <span id="statusText">Loading cases…</span>
      </div>
      <div style="height:10px"></div>
      <div class="progress" title="Load progress">
        <div id="progBar"></div>
      </div>
      <div style="height:10px"></div>
      <div class="hint">
        This website indexes every MoD / GOV UFO report from 1997 until the MoD closed its dedicated UFO desk in 2009. Other cases are also listed with varying levels of evidence and reputability. Use the filters below to fine tune your search.
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label for="search">Search</label>
          <input id="search" placeholder="e.g., Rendlesham, Warwick, triangle…" />
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row">
        <div>
          <label for="region">Region</label>
          <select id="region">
            <option value="">All</option>
          </select>
        </div>
        <div>
          <label for="minCred">Min credibility</label>
          <select id="minCred">
            <option value="1" selected>1+</option>
            <option value="2">2+</option>
            <option value="3">3+</option>
            <option value="4">4+</option>
            <option value="5">5</option>
          </select>
        </div>
        <div>
          <label for="encounter">Encounter</label>
          <select id="encounter">
            <option value="">All</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>

<div style="height:12px"></div>
      <label>Year range</label>
      <div class="slider-wrap"><div id="yearSlider"></div></div>
      <div class="slider-meta"><span id="yearMin">—</span><span id="yearMax">—</span></div>
    </div>

    <div class="card" id="layersCard">
      <div style="font-weight:700;margin-bottom:6px">Map layers</div>

      <div class="toggle-row">
        <div>
          <div style="font-weight:650;font-size:13px">UFO sightings</div>
          <div class="label">Show UFO sighting reports</div>
        </div>
        <label class="switch" title="Toggle UFO sightings">
          <input type="checkbox" id="toggleUfo" checked>
          <span class="slider"></span>
        </label>
      </div>


      <div class="toggle-row">
        <div>
          <div style="font-weight:650;font-size:13px">Crop circles</div>
          <div class="label">Show crop circle reports</div>
        </div>
        <label class="switch" title="Toggle crop circles">
          <input type="checkbox" id="toggleCrop">
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-row">
        <div>
          <div style="font-weight:650;font-size:13px">Airports</div>
          <div class="label">Show major UK airports</div>
        </div>
        <label class="switch" title="Toggle airports">
          <input type="checkbox" id="toggleAirports">
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-row">
        <div>
          <div style="font-weight:650;font-size:13px">Military bases</div>
          <div class="label">Show RAF/Army/Navy bases</div>
        </div>
        <label class="switch" title="Toggle military bases">
          <input type="checkbox" id="toggleBases">
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-row">
        <div>
          <div class="help-wrap">
  <div style="font-weight:650;font-size:13px">Heatmap</div>
  <button type="button" class="help-icon" id="heatmapHelpBtn" aria-label="Heatmap info" aria-expanded="false">?</button>
  <div class="help-bubble" id="heatmapHelpBubble" role="tooltip">
    Reports with generalised locations such as "London" may cause a cluster on the heatmap. Keep this in mind when viewing the data.
  </div>
</div>
          <div class="label">Show sightings as a heatmap (hides markers)</div>
        </div>
        <label class="switch" title="Toggle density heatmap">
          <input type="checkbox" id="toggleDensity">
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-row">
        <div>
          <div style="font-weight:650;font-size:13px">Flight heatmap</div>
          <div class="label">Show flight corridor density (historic sample)</div>
        </div>
        <label class="switch" title="Toggle flight heatmap">
          <input type="checkbox" id="toggleFlightHeat">
          <span class="slider"></span>
        </label>
      </div>

      
<div class="layer-hint">These layers are optional references and won’t affect your sightings filters.</div>
    </div>


    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:baseline">
        <div style="flex:1">
          <div style="font-weight:700;margin-bottom:6px">Highlights</div>
          <div class="hint" id="resultsHint">Tap an item to zoom and open its popup.</div>
        </div>
      </div>
      <div style="height:8px"></div>
      <div id="list"></div>
    </div>


    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">Make it more interesting (ideas)</div>
      <div class="hint">
        • Add a “case page” route (e.g. <span class="pill">/case/rendlesham</span>) with longer write‑ups and images.<br/>
        • Add “witness types” icons and a “case strength” score breakdown.<br/>
        • Add a timeline “play” mode that animates sightings by year.<br/>
        • Add an “investigation view” showing MoD/National Archives file references and document thumbnails.
      </div>
    </div>
  </aside>

  <main>
    <div id="map"></div>
  </main>
</div>

<script>
(function(){
  // ==== CONFIG ====
  // Your published Google Sheets CSV URL (Publish to the web → CSV):
  const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7sia344gHoW613Mc1jQSYR4w_rMv2CcDtc-v1eJrbggnWrdu0FpgRIMMtwCOXULgmoU7UEUHNK-Ib/pub?output=csv';

  // Crop circles (published sheet). Same format as above (Publish to the web → CSV).
  // Provided by you:
  // - Edit URL: https://docs.google.com/spreadsheets/d/1lmqNopiw2ReeESFSdKvvzmkxLxLmpzKezMr7Wbpvs-E/edit?gid=907879389
  // - Published URL: https://docs.google.com/spreadsheets/d/e/2PACX-1vQIfJZFzjhP3ql51I1Oj7e6egKr7DnMyEX64tUVmFYxIuTYDVMnm_g8dv9JAx49PdDhhMGgTzhJHgI1/pubhtml
  // Note: for published Google Sheets, swapping `pubhtml` -> `pub?output=csv` gives a CSV feed.
  const CROP_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQIfJZFzjhP3ql51I1Oj7e6egKr7DnMyEX64tUVmFYxIuTYDVMnm_g8dv9JAx49PdDhhMGgTzhJHgI1/pub?output=csv';

  const els = {
    statusDot: document.getElementById('statusDot'),
    statusText: document.getElementById('statusText'),
    progBar: document.getElementById('progBar'),
    kpiTotal: document.getElementById('kpiTotal'),
    kpiShown: document.getElementById('kpiShown'),
    region: document.getElementById('region'),
    minCred: document.getElementById('minCred'),
    search: document.getElementById('search'),
    list: document.getElementById('list'),
    fitBtn: document.getElementById('fitBtn'),
    resetBtn: document.getElementById('resetBtn'),
    yearSlider: document.getElementById('yearSlider'),
    yearMin: document.getElementById('yearMin'),
    yearMax: document.getElementById('yearMax'),
    encounter: document.getElementById('encounter'),
    toggleAirports: document.getElementById('toggleAirports'),
    toggleBases: document.getElementById('toggleBases'),
    toggleFlightPaths: document.getElementById('toggleFlightPaths'),
    toggleFlightHeat: document.getElementById('toggleFlightHeat'),
    toggleDensity: document.getElementById('toggleDensity'),
    toggleUfo: document.getElementById('toggleUfo'),
    toggleCrop: document.getElementById('toggleCrop')
  };
// Heatmap help tooltip
const heatmapHelpBtn = document.getElementById('heatmapHelpBtn');
const heatmapHelpBubble = document.getElementById('heatmapHelpBubble');

function setHeatmapHelpOpen(open){
  if(!heatmapHelpBtn || !heatmapHelpBubble) return;
  heatmapHelpBubble.classList.toggle('is-open', !!open);
  heatmapHelpBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
}

if(heatmapHelpBtn && heatmapHelpBubble){
  heatmapHelpBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    const isOpen = heatmapHelpBubble.classList.contains('is-open');
    setHeatmapHelpOpen(!isOpen);
  });

  heatmapHelpBubble.addEventListener('click', (e) => {
    // Allow selecting/copying text without closing
    e.stopPropagation();
  });

  document.addEventListener('click', () => setHeatmapHelpOpen(false));
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape') setHeatmapHelpOpen(false);
  });
}


  // Map
  const map = L.map('map', { zoomControl: true }).setView([54.5, -3.0], 6);
  // Pane for flight paths so lines sit above tiles/markers and stay visible
  map.createPane('flightPathsPane');
  map.getPane('flightPathsPane').style.zIndex = 450;
  map.getPane('flightPathsPane').style.pointerEvents = 'auto';
  // Base tiles (use OSM by default; keep CARTO as a fallback)
  const osmTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  });

  const cartoTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    subdomains: 'abcd',
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
  });

  // Start with OSM (more reliable in locked-down environments)
  osmTiles.addTo(map);

  // If you prefer CARTO aesthetics, uncomment the next line:
  // cartoTiles.addTo(map);


  // Mobile: collapsible filter panel (off-canvas drawer)
  const mqPanel = window.matchMedia('(max-width: 960px)');
  const panelToggleBtn = document.getElementById('panelToggle');
  const panelOverlay = document.getElementById('panelOverlay');
  const panelTabBtn = document.getElementById('panelTab');

  function setPanelOpen(isOpen){
    if(!mqPanel.matches){
      // Desktop: panel is always visible, no overlay
      document.body.classList.remove('panel-open');
      if(panelOverlay) panelOverlay.setAttribute('hidden','');
      if(panelToggleBtn) panelToggleBtn.setAttribute('aria-expanded','true');
      if(panelTabBtn){
        panelTabBtn.setAttribute('aria-expanded','true');
        panelTabBtn.style.left = '0px';
      }
      return;
    }

    if(isOpen){
      document.body.classList.add('panel-open');
      if(panelOverlay) panelOverlay.removeAttribute('hidden');
      if(panelToggleBtn) panelToggleBtn.setAttribute('aria-expanded','true');
      if(panelTabBtn){
        panelTabBtn.textContent = '‹';
        panelTabBtn.setAttribute('aria-expanded','true');
        panelTabBtn.setAttribute('aria-label','Hide filters');
        const w = document.getElementById('panel')?.getBoundingClientRect?.().width || 0;
        panelTabBtn.style.left = Math.max(0, Math.round(w - 1)) + 'px';
      }
    } else {
      document.body.classList.remove('panel-open');
      if(panelOverlay) panelOverlay.setAttribute('hidden','');
      if(panelToggleBtn) panelToggleBtn.setAttribute('aria-expanded','false');
      if(panelTabBtn){
        panelTabBtn.textContent = '›';
        panelTabBtn.setAttribute('aria-expanded','false');
        panelTabBtn.setAttribute('aria-label','Show filters');
        panelTabBtn.style.left = '0px';
      }
    }

    // Leaflet needs this after layout changes (drawer transition)
    window.setTimeout(() => {
      try { map.invalidateSize(); } catch (e) {}
    }, 280);
  }

  // Default: open on mobile so users can start filtering immediately; on desktop the panel is always visible
  setPanelOpen(mqPanel.matches);

  if(panelToggleBtn){
    panelToggleBtn.addEventListener('click', () => {
      const open = document.body.classList.contains('panel-open');
      setPanelOpen(!open);
    });
  }
  if(panelTabBtn){
    panelTabBtn.addEventListener('click', () => {
      const open = document.body.classList.contains('panel-open');
      setPanelOpen(!open);
    });
  }
  if(panelOverlay){
    panelOverlay.addEventListener('click', () => setPanelOpen(false));
  }
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape') setPanelOpen(false);
  });
  mqPanel.addEventListener('change', () => setPanelOpen(false));


  const cluster = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 50 });
  const heatLayer = (L.heatLayer ? L.heatLayer([], { radius: 18, blur: 22, maxZoom: 12, minOpacity: 0.25 }) : null);
  let lastShownLatLngs = [];

  function isDensityOn(){
    return !!(els.toggleDensity && els.toggleDensity.checked);
  }

  function applyDensityMode(){
    if(!heatLayer) return;
    const on = isDensityOn();
    if(on){
      if(map.hasLayer(cluster)) map.removeLayer(cluster);
      if(!map.hasLayer(heatLayer)) map.addLayer(heatLayer);
    } else {
      if(map.hasLayer(heatLayer)) map.removeLayer(heatLayer);
      if(!map.hasLayer(cluster)) map.addLayer(cluster);
    }
  }

  map.addLayer(cluster);

  // Optional reference layers
  // Optional reference layers (clustered so they don't overwhelm the map)
  const airportsLayer = L.markerClusterGroup({
    showCoverageOnHover: false,
    spiderfyOnMaxZoom: true,
    disableClusteringAtZoom: 9,
    maxClusterRadius: 50,
    iconCreateFunction: (cluster) => L.divIcon({
      html: `<div class="poi-cluster airports">${cluster.getChildCount()}</div>`,
      className: '',
      iconSize: [34,34]
    })
  });

  const basesLayer = L.markerClusterGroup({
    showCoverageOnHover: false,
    spiderfyOnMaxZoom: true,
    disableClusteringAtZoom: 9,
    maxClusterRadius: 55,
    iconCreateFunction: (cluster) => L.divIcon({
      html: `<div class="poi-cluster bases">${cluster.getChildCount()}</div>`,
      className: '',
      iconSize: [34,34]
    })
  });


  // Historic flight corridors (reference layer)
  // Source: Wingbits public ADS-B sample (24h) processed into simplified corridor polylines.
  const FLIGHT_PATHS_GEOJSON = {"type":"FeatureCollection","properties":{"requested_start":"2025-05-14","requested_days":7,"days_found":["2025-05-14"],"bbox":[-11.0,49.0,3.5,61.5],"tracks_used":2500,"corridors":120},"features":[{"type":"Feature","properties":{"name":"Historic corridor 1","weight":45,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.6,49.0],[2.8000000000000003,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 2","weight":21,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.6,49.0],[2.9000000000000004,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 3","weight":12,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.5,51.5],[-0.5,51.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 4","weight":11,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.6,49.0],[2.6,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 5","weight":6,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.6,49.0],[3.5,49.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 6","weight":5,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.7000000000000002,52.5],[-1.7000000000000002,52.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 7","weight":4,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.4,51.5],[-0.5,51.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 8","weight":4,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.6,49.0],[3.4000000000000004,49.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 9","weight":4,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.5,49.0],[2.6,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 10","weight":3,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[1.3,49.0],[3.5,51.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 11","weight":3,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.5,51.5],[3.4000000000000004,51.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 12","weight":3,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.5,51.5],[3.5,51.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 13","weight":3,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.4,51.5],[-0.4,51.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 14","weight":3,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.4,51.5],[3.4000000000000004,51.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 15","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.6,49.0],[2.7,49.0],[2.6,49.0],[2.7,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 16","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.7000000000000002,52.5],[-1.7000000000000002,52.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 17","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.5,49.0],[3.1,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 18","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-2.2,57.2],[-2.2,57.300000000000004],[-1.3,57.5],[3.4000000000000004,58.6]]}},{"type":"Feature","properties":{"name":"Historic corridor 19","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-2.4000000000000004,53.5],[-2.4000000000000004,53.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 20","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-8.5,51.800000000000004],[-8.1,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 21","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[0.1,51.7],[0.2,51.7]]}},{"type":"Feature","properties":{"name":"Historic corridor 22","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.5,49.0],[2.5,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 23","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,50.0],[2.6,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 24","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.5,49.0],[2.7,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 25","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.4000000000000001,54.5],[-1.4000000000000001,54.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 26","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.2,51.2],[1.2000000000000002,51.2],[3.4000000000000004,50.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 27","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.6,49.0],[2.8000000000000003,49.0],[2.6,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 28","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.5,49.0],[3.4000000000000004,49.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 29","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.4000000000000004,49.1],[0.2,51.0],[-0.5,51.1],[-0.2,51.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 30","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.1,49.0],[2.5,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 31","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[1.6,49.0],[3.5,51.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 32","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-6.300000000000001,53.400000000000006],[-6.2,53.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 33","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.2,51.2],[1.8,51.1],[3.4000000000000004,50.7]]}},{"type":"Feature","properties":{"name":"Historic corridor 34","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.4,51.5],[-0.5,51.5],[-0.4,51.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 35","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.8,52.5],[-1.7000000000000002,52.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 36","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-2.3000000000000003,53.400000000000006],[-2.3000000000000003,53.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 37","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[1.2000000000000002,49.0],[3.5,51.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 38","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,50.0],[2.7,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 39","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-2.9000000000000004,52.7],[-2.8000000000000003,52.800000000000004]]}},{"type":"Feature","properties":{"name":"Historic corridor 40","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.4000000000000004,49.400000000000006],[2.1,49.1],[2.1,49.0],[2.6,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 41","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,50.1],[2.8000000000000003,49.400000000000006],[2.2,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 42","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,49.6],[2.3000000000000003,49.400000000000006],[2.2,49.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 43","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.4000000000000004,49.400000000000006],[2.0,49.1],[2.1,49.0],[2.5,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 44","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[1.9000000000000001,49.0],[3.5,51.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 45","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,50.7],[3.4000000000000004,50.7],[3.5,50.7]]}},{"type":"Feature","properties":{"name":"Historic corridor 46","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.5,49.0],[3.3000000000000003,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 47","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,49.7],[3.0,49.300000000000004],[2.8000000000000003,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 48","weight":2,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.4,51.5],[-0.4,51.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 49","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,49.900000000000006],[2.0,50.2],[0.5,51.0],[0.0,51.300000000000004],[-0.5,51.300000000000004],[-0.9,51.400000000000006],[-0.5,51.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 50","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-4.4,55.900000000000006],[-4.2,55.900000000000006],[-4.1000000000000005,55.5],[-1.0,51.800000000000004],[-0.1,50.5],[1.7000000000000002,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 51","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.4000000000000001,51.900000000000006],[-1.3,51.800000000000004],[-1.3,51.6]]}},{"type":"Feature","properties":{"name":"Historic corridor 52","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.5,49.800000000000004],[-0.5,51.5],[-0.30000000000000004,51.400000000000006],[-0.4,51.300000000000004],[-2.4000000000000004,49.300000000000004],[-2.4000000000000004,49.2],[-2.2,49.2],[-2.0,49.300000000000004],[-0.5,51.5],[-0.4,51.5],[-0.4,51.400000000000006],[1.2000000000000002,49.6],[1.0,50.800000000000004],[0.0,51.300000000000004],[-0.4,51.5],[0.0,51.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 53","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.4,51.900000000000006],[-0.2,51.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 54","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-10.8,55.300000000000004],[-10.0,55.0],[-7.4,54.300000000000004],[-5.5,53.6],[-2.9000000000000004,53.1],[-1.0,51.900000000000006],[-0.6000000000000001,51.7],[-0.7000000000000001,51.800000000000004],[-0.6000000000000001,51.6],[-0.6000000000000001,51.7],[-0.6000000000000001,51.6],[-0.9,51.6],[-0.8,51.6],[-0.9,51.5],[-0.9,51.6],[-0.8,51.5],[-0.9,51.5],[-0.5,51.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 55","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-2.3000000000000003,53.400000000000006],[-2.8000000000000003,52.400000000000006],[-2.8000000000000003,51.900000000000006],[-2.3000000000000003,53.400000000000006],[0.9,52.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 56","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.3000000000000003,51.400000000000006],[1.7000000000000002,52.0],[0.7000000000000001,52.2],[-0.1,52.300000000000004],[0.2,52.2],[-0.1,52.2],[0.1,52.300000000000004],[-0.1,52.2],[0.1,52.300000000000004],[-0.2,52.1],[0.0,52.300000000000004],[-0.2,52.1],[-0.1,52.300000000000004],[-0.4,52.0],[-0.2,52.2],[-0.8,51.800000000000004],[-0.4,52.0],[-0.8,51.800000000000004],[-0.4,52.0],[-0.8,51.800000000000004],[-0.4,51.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 57","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-5.0,50.400000000000006],[-5.1000000000000005,50.5],[-5.0,50.400000000000006],[-5.1000000000000005,50.400000000000006],[-5.0,50.5],[-5.1000000000000005,50.5],[-5.0,50.400000000000006],[-5.0,50.5],[-5.1000000000000005,50.5],[-5.0,50.400000000000006],[-5.1000000000000005,50.400000000000006],[-5.1000000000000005,50.5],[-5.0,50.5],[-5.1000000000000005,50.5],[-5.0,50.5],[-5.1000000000000005,50.400000000000006],[-5.0,50.5],[-5.0,50.5],[-5.0,50.5],[-5.1000000000000005,50.400000000000006],[-5.1000000000000005,50.5],[-5.0,50.5],[-5.1000000000000005,50.400000000000006],[-5.1000000000000005,50.5],[-5.0,50.5],[-5.1000000000000005,50.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 58","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.30000000000000004,49.0],[-1.8,49.5],[-3.3000000000000003,50.1],[-5.0,50.5],[-5.0,50.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 59","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.4000000000000004,49.0],[2.1,50.0],[0.0,51.300000000000004],[-0.8,51.400000000000006],[-0.6000000000000001,51.300000000000004],[-0.8,51.400000000000006],[-0.6000000000000001,51.400000000000006],[-0.7000000000000001,51.400000000000006],[-0.5,51.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 60","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.2000000000000002,49.0],[-1.4000000000000001,49.5],[-0.9,50.800000000000004],[-0.4,52.0],[-1.1,53.1],[-1.5,53.400000000000006],[-1.8,54.0],[-1.7000000000000002,54.7],[-2.0,54.900000000000006],[-1.9000000000000001,55.0],[-1.7000000000000002,55.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 61","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.2,49.0],[1.1,50.5],[0.1,51.0],[-0.5,51.1],[-0.2,51.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 62","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.0,51.5],[-1.0,51.5],[-1.4000000000000001,52.0],[-1.1,51.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 63","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,53.5],[3.0,53.6],[3.1,53.800000000000004]]}},{"type":"Feature","properties":{"name":"Historic corridor 64","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-3.4000000000000004,56.0],[-3.2,56.1],[-2.9000000000000004,56.0],[-3.0,55.5],[-3.5,54.900000000000006],[-2.8000000000000003,54.0],[-2.9000000000000004,52.6],[-3.3000000000000003,51.5],[-3.4000000000000004,50.400000000000006],[-3.2,49.900000000000006],[-2.8000000000000003,49.5],[-2.8000000000000003,49.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 65","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.4000000000000004,52.0],[2.4000000000000004,51.900000000000006],[0.2,52.300000000000004],[-0.2,52.2],[-0.2,52.0],[-0.7000000000000001,51.900000000000006],[-0.4,51.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 66","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.3000000000000003,51.300000000000004],[1.6,52.0],[0.4,52.0],[0.2,52.0],[0.0,51.800000000000004],[0.2,51.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 67","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[0.2,49.1],[0.2,49.400000000000006],[-1.2000000000000002,49.400000000000006],[-1.5,49.300000000000004]]}},{"type":"Feature","properties":{"name":"Historic corridor 68","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.5,49.0],[2.7,49.0],[3.2,49.400000000000006],[2.1,49.1],[2.5,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 69","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-2.4000000000000004,52.800000000000004],[-2.4000000000000004,52.900000000000006],[-2.6,53.300000000000004],[-2.7,53.800000000000004],[-1.5,54.300000000000004],[-2.0,53.900000000000006],[-2.0,53.6],[-1.8,53.5],[-1.6,53.1],[-2.1,52.800000000000004]]}},{"type":"Feature","properties":{"name":"Historic corridor 70","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-2.9000000000000004,53.300000000000004],[-2.8000000000000003,53.400000000000006],[-2.9000000000000004,53.5],[-2.8000000000000003,53.5],[-1.0,53.400000000000006],[3.4000000000000004,52.7]]}},{"type":"Feature","properties":{"name":"Historic corridor 71","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.4000000000000004,51.2],[2.8000000000000003,51.300000000000004],[-1.5,51.7],[-4.5,52.400000000000006],[-10.9,53.2]]}},{"type":"Feature","properties":{"name":"Historic corridor 72","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.8000000000000003,51.6],[0.8,52.0],[0.2,51.800000000000004],[0.30000000000000004,51.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 73","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-2.7,52.0],[-2.1,52.1],[-2.3000000000000003,52.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 74","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-2.7,51.400000000000006],[3.2,50.900000000000006],[2.4000000000000004,51.400000000000006],[-2.7,51.400000000000006],[-1.5,51.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 75","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[0.30000000000000004,51.900000000000006],[0.5,51.900000000000006],[2.3000000000000003,51.0],[3.4000000000000004,50.6]]}},{"type":"Feature","properties":{"name":"Historic corridor 76","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.5,51.5],[-0.4,51.400000000000006],[-0.7000000000000001,51.400000000000006],[-0.8,51.400000000000006],[-0.6000000000000001,51.400000000000006],[-2.0,51.800000000000004],[-11.0,52.7]]}},{"type":"Feature","properties":{"name":"Historic corridor 77","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-8.5,51.800000000000004],[-8.4,51.800000000000004],[-6.2,51.900000000000006],[-3.1,51.6],[0.1,52.0],[3.5,52.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 78","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,51.400000000000006],[3.0,51.6],[1.7000000000000002,51.7],[-0.9,51.5],[-0.5,51.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 79","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[0.5,51.400000000000006],[0.9,51.300000000000004],[0.8,51.2],[0.8,51.300000000000004],[1.0,51.300000000000004],[0.5,51.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 80","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.1,49.5],[2.6,49.400000000000006],[2.1,49.400000000000006],[2.3000000000000003,49.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 81","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[1.4000000000000001,49.0],[2.9000000000000004,50.2],[3.5,50.800000000000004]]}},{"type":"Feature","properties":{"name":"Historic corridor 82","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,50.300000000000004],[3.4000000000000004,50.300000000000004]]}},{"type":"Feature","properties":{"name":"Historic corridor 83","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.2000000000000002,53.800000000000004],[-1.0,53.7],[-1.1,53.7]]}},{"type":"Feature","properties":{"name":"Historic corridor 84","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.6,52.2],[-1.4000000000000001,52.2],[-1.3,52.300000000000004],[-1.4000000000000001,52.2],[-1.3,52.2],[-1.4000000000000001,52.1],[-1.3,52.1],[-1.5,52.300000000000004],[-1.9000000000000001,52.2],[-2.6,52.6]]}},{"type":"Feature","properties":{"name":"Historic corridor 85","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.4,51.900000000000006],[-0.2,51.900000000000006],[2.5,53.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 86","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.4000000000000004,51.6],[-0.9,52.7],[-5.5,53.7],[-10.5,55.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 87","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.3,49.1],[-1.3,49.400000000000006],[-1.0,50.800000000000004],[-0.4,51.800000000000004],[-1.6,53.2],[-1.8,53.7],[-1.5,53.7],[-1.7000000000000002,53.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 88","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-2.3000000000000003,53.400000000000006],[-2.2,53.400000000000006],[-3.6,53.6],[-5.2,53.7],[-5.4,53.6],[-8.200000000000001,51.0],[-8.9,49.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 89","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,52.0],[1.9000000000000001,51.900000000000006],[1.2000000000000002,52.1],[0.30000000000000004,52.1],[0.0,51.800000000000004],[0.0,51.800000000000004],[0.2,51.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 90","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.9000000000000004,53.0],[-1.8,53.5],[-6.300000000000001,53.400000000000006],[-6.2,53.400000000000006],[-5.2,52.0],[-0.9,50.900000000000006],[1.1,49.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 91","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,49.300000000000004],[2.1,50.300000000000004],[-1.0,51.5],[-5.4,52.1],[-7.6000000000000005,52.5],[-8.9,52.5],[-9.200000000000001,52.6],[-8.9,52.7]]}},{"type":"Feature","properties":{"name":"Historic corridor 92","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-6.2,53.400000000000006],[-5.5,51.800000000000004],[-4.7,50.5],[-4.9,50.400000000000006],[-4.800000000000001,50.5],[-4.6000000000000005,50.400000000000006],[-4.7,50.300000000000004],[-5.0,50.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 93","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-4.4,55.900000000000006],[-4.2,55.900000000000006],[-4.2,55.6],[-3.8000000000000003,55.1],[-2.9000000000000004,53.0],[-3.0,52.0],[-2.8000000000000003,51.6],[-3.0,51.400000000000006],[-3.0,51.400000000000006],[-2.7,51.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 94","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[1.5,49.0],[1.6,49.300000000000004],[3.5,51.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 95","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.4000000000000004,49.300000000000004],[0.1,51.300000000000004],[-0.8,51.400000000000006],[-0.7000000000000001,51.5],[-0.4,51.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 96","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.8000000000000003,51.300000000000004],[2.0,51.400000000000006],[-0.2,51.2],[1.5,51.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 97","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.3000000000000003,49.2],[2.4000000000000004,49.1],[2.4000000000000004,49.2]]}},{"type":"Feature","properties":{"name":"Historic corridor 98","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-10.9,55.400000000000006],[-2.3000000000000003,52.7],[-0.6000000000000001,51.6],[-0.8,51.5],[-0.4,51.5],[-0.4,51.400000000000006],[-0.8,51.300000000000004],[-2.4000000000000004,51.900000000000006],[-9.200000000000001,52.7]]}},{"type":"Feature","properties":{"name":"Historic corridor 99","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-2.9000000000000004,53.300000000000004],[-3.2,54.300000000000004],[-4.2,55.2]]}},{"type":"Feature","properties":{"name":"Historic corridor 100","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[2.1,51.7],[-0.9,51.5],[1.7000000000000002,51.2]]}},{"type":"Feature","properties":{"name":"Historic corridor 101","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,49.300000000000004],[1.6,50.800000000000004],[0.6000000000000001,51.1],[-1.5,52.900000000000006],[-2.5,53.2],[-2.3000000000000003,53.300000000000004]]}},{"type":"Feature","properties":{"name":"Historic corridor 102","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-2.1,49.0],[-1.1,50.7],[-0.8,50.800000000000004],[-0.1,50.900000000000006],[-0.2,51.0],[-0.6000000000000001,51.1],[-0.2,51.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 103","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[1.0,52.1],[0.6000000000000001,51.900000000000006],[0.5,51.800000000000004],[0.7000000000000001,51.800000000000004],[1.1,52.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 104","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-3.9000000000000004,52.2],[-3.6,52.300000000000004],[-3.6,52.300000000000004],[-3.8000000000000003,52.400000000000006],[-3.6,52.400000000000006],[-3.7,52.5],[-3.9000000000000004,52.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 105","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-3.2,49.0],[-3.8000000000000003,49.7],[-3.6,50.800000000000004],[-3.3000000000000003,51.2],[-3.0,51.300000000000004],[-3.0,51.400000000000006],[-2.7,51.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 106","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-6.2,53.400000000000006],[-6.0,53.400000000000006],[-5.7,52.5],[-3.0,51.7],[-1.3,51.0],[-0.2,50.5],[1.7000000000000002,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 107","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.4000000000000004,51.300000000000004],[0.0,51.5],[0.2,51.6]]}},{"type":"Feature","properties":{"name":"Historic corridor 108","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.4000000000000004,49.300000000000004],[2.2,49.900000000000006],[0.1,51.0],[-0.1,51.2],[0.4,50.900000000000006],[-0.30000000000000004,51.400000000000006],[0.0,51.900000000000006],[0.30000000000000004,52.1],[0.30000000000000004,52.0],[0.0,51.800000000000004],[0.2,51.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 109","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,58.5],[-2.2,57.300000000000004],[-3.6,56.300000000000004],[-3.8000000000000003,55.900000000000006],[-3.7,55.800000000000004],[-3.4000000000000004,55.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 110","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.8,51.5],[3.3000000000000003,50.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 111","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,51.300000000000004],[1.4000000000000001,51.7],[1.9000000000000001,51.6],[0.1,51.6],[-0.8,51.5],[-0.5,51.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 112","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.0,49.0],[-1.1,49.6],[-0.8,50.800000000000004],[0.1,52.0],[0.2,52.0],[0.0,51.800000000000004],[0.2,51.900000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 113","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.4000000000000004,51.900000000000006],[2.2,51.5],[2.2,51.5],[2.4000000000000004,51.5],[1.4000000000000001,51.400000000000006],[1.3,51.300000000000004],[1.6,51.400000000000006],[0.4,50.900000000000006],[0.30000000000000004,51.1],[-0.1,51.0],[-0.5,51.0],[-0.5,51.1],[-0.2,51.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 114","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,49.400000000000006],[2.1,49.1],[2.0,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 115","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,49.2],[1.9000000000000001,50.0],[1.3,50.300000000000004],[0.1,51.0],[-0.5,51.1],[-0.2,51.1]]}},{"type":"Feature","properties":{"name":"Historic corridor 116","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[3.5,49.2],[2.6,49.1],[1.7000000000000002,49.1],[1.6,49.0]]}},{"type":"Feature","properties":{"name":"Historic corridor 117","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-0.4,51.5],[-0.30000000000000004,51.7],[-0.4,52.0],[-1.1,52.5],[-2.0,53.2],[-2.4000000000000004,53.1],[-2.6,53.2],[-2.3000000000000003,53.400000000000006]]}},{"type":"Feature","properties":{"name":"Historic corridor 118","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-10.0,50.400000000000006],[-6.300000000000001,50.5],[-0.4,51.5]]}},{"type":"Feature","properties":{"name":"Historic corridor 119","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.6,49.0],[-1.8,49.800000000000004],[-1.7000000000000002,50.400000000000006],[-2.1,50.7],[-1.9000000000000001,50.800000000000004]]}},{"type":"Feature","properties":{"name":"Historic corridor 120","weight":1,"source":"wingbits sample"},"geometry":{"type":"LineString","coordinates":[[-1.3,49.1],[-1.4000000000000001,49.6],[-1.0,50.400000000000006],[-0.9,52.2],[-1.6,53.2],[-1.7000000000000002,53.5],[-1.5,53.7],[-1.7000000000000002,53.900000000000006]]}}]};
  // Style and render (as GeoJSON so it's easy to replace later)
  // Sleek "cased" flight paths: soft glow underlay + crisp top line
  const flightPathsGlow = L.geoJSON(FLIGHT_PATHS_GEOJSON, {
    pane: 'flightPathsPane',
    style: () => ({
      color: 'rgba(59, 130, 246, 0.22)',  // glow underlay
      weight: 6,
      opacity: 1,
      dashArray: '8 10',
      lineCap: 'round',
      lineJoin: 'round'
    }),
    interactive: false
  });

  const flightPathsLine = L.geoJSON(FLIGHT_PATHS_GEOJSON, {
    pane: 'flightPathsPane',
    style: () => ({
      color: 'rgba(59, 130, 246, 0.95)',   // crisp top
      weight: 2.2,
      opacity: 1,
      dashArray: '8 10',
      lineCap: 'round',
      lineJoin: 'round'
    }),
    onEachFeature: (feature, layer) => {
      const name = (feature && feature.properties && feature.properties.name) ? feature.properties.name : 'Flight path';
      layer.bindTooltip(name, { sticky: true, opacity: 0.9 });
    }
  });

  // Flight paths heatmap (derived from corridor polylines)
  // Uses Leaflet.heat and stays visible when zoomed (maxZoom set to map max).
  const flightHeatLayer = (L.heatLayer ? (function(){
    function buildFlightHeatPoints(geo){
      const pts = [];

      // Clip flight heatmap to UK-ish bounds to avoid drifting into France/near continent
      const UK_CLIP = {minLat:49.7, maxLat:61.3, minLon:-8.9, maxLon:2.3};
      function inUk(lat, lon){
        return lat>=UK_CLIP.minLat && lat<=UK_CLIP.maxLat && lon>=UK_CLIP.minLon && lon<=UK_CLIP.maxLon;
      }
      if(!geo || !geo.features) return pts;

      // Find max weight for normalization
      let maxW = 1;
      for(const f of geo.features){
        const w = (f && f.properties && typeof f.properties.weight === 'number') ? f.properties.weight : 1;
        if(w > maxW) maxW = w;
      }

      const stepDeg = 0.15; // controls smoothness vs. point count
      for(const f of geo.features){
        if(!f || !f.geometry) continue;
        const wRaw = (f.properties && typeof f.properties.weight === 'number') ? f.properties.weight : 1;
        const intensity = Math.max(0.15, Math.min(1, wRaw / maxW)); // keep faint but visible

        if(f.geometry.type === 'LineString' && Array.isArray(f.geometry.coordinates)){
          const coords = f.geometry.coordinates;
          for(let i=0;i<coords.length;i++){
            const c = coords[i];
            if(!Array.isArray(c) || c.length < 2) continue;
            const lon = c[0], lat = c[1];
            if(inUk(lat, lon)) pts.push([lat, lon, intensity]);

            // Densify segments a little (adds intermediate points between vertices)
            if(i < coords.length - 1){
              const n = coords[i+1];
              if(Array.isArray(n) && n.length >= 2){
                const lon2 = n[0], lat2 = n[1];
                const dLon = lon2 - lon, dLat = lat2 - lat;
                const dist = Math.sqrt(dLon*dLon + dLat*dLat);
                const steps = Math.min(12, Math.max(0, Math.floor(dist / stepDeg)));
                for(let s=1; s<=steps; s++){
                  const t = s/(steps+1);
                  const ilat = lat + dLat*t, ilon = lon + dLon*t;
                  if(inUk(ilat, ilon)) pts.push([ilat, ilon, intensity]);
                }
              }
            }
          }
        }
      }
      return pts;
    }

    const points = buildFlightHeatPoints(FLIGHT_PATHS_GEOJSON);
    return L.heatLayer(points, {
      radius: 22,
      blur: 20,
      maxZoom: 18,
      minOpacity: 0.20,
      // Custom gradient so it doesn't look like the sightings heatmap
      gradient: {
        0.00: 'rgba(34,211,238,0.0)',
        0.25: 'rgba(34,211,238,0.65)',
        0.55: 'rgba(139,92,246,0.85)',
        0.80: 'rgba(236,72,153,0.92)',
        1.00: 'rgba(251,191,36,0.98)'
      }
    });
  })() : null);



  // Minimal curated sets (major airports + key bases). You can add/remove items anytime.
  const AIRPORTS = [
    { name: "London Heathrow (LHR)", lat: 51.4700, lon: -0.4543 },
    { name: "London Gatwick (LGW)", lat: 51.1537, lon: -0.1821 },
    { name: "London Stansted (STN)", lat: 51.8850, lon: 0.2350 },
    { name: "London Luton (LTN)", lat: 51.8747, lon: -0.3683 },
    { name: "London City (LCY)", lat: 51.5053, lon: 0.0553 },
    { name: "Manchester (MAN)", lat: 53.3537, lon: -2.2750 },
    { name: "Birmingham (BHX)", lat: 52.4539, lon: -1.7480 },
    { name: "Bristol (BRS)", lat: 51.3827, lon: -2.7191 },
    { name: "Liverpool John Lennon (LPL)", lat: 53.3336, lon: -2.8497 },
    { name: "Newcastle (NCL)", lat: 55.0375, lon: -1.6917 },
    { name: "Leeds Bradford (LBA)", lat: 53.8659, lon: -1.6606 },
    { name: "Edinburgh (EDI)", lat: 55.9500, lon: -3.3725 },
    { name: "Glasgow (GLA)", lat: 55.8719, lon: -4.4331 },
    { name: "Aberdeen (ABZ)", lat: 57.2019, lon: -2.1978 },
    { name: "Belfast International (BFS)", lat: 54.6575, lon: -6.2158 },
    { name: "Cardiff (CWL)", lat: 51.3967, lon: -3.3433 }
  ];

  const BASES = [
    { name: "RAF Brize Norton", lat: 51.7500, lon: -1.5830 },
    { name: "RAF Fairford", lat: 51.6820, lon: -1.7900 },
    { name: "RAF Lakenheath", lat: 52.4090, lon: 0.5610 },
    { name: "RAF Mildenhall", lat: 52.3610, lon: 0.4860 },
    { name: "RAF Coningsby", lat: 53.0930, lon: -0.1660 },
    { name: "RAF Marham", lat: 52.6500, lon: 0.5500 },
    { name: "RAF Lossiemouth", lat: 57.7050, lon: -3.3390 },
    { name: "RAF Leeming", lat: 54.2950, lon: -1.5330 },
    { name: "RAF Valley (Anglesey)", lat: 53.2520, lon: -4.5350 },
    { name: "RAF Shawbury", lat: 52.7980, lon: -2.6680 },
    { name: "RAF Waddington", lat: 53.1670, lon: -0.5240 },
    { name: "Army: Salisbury Plain Training Area", lat: 51.2000, lon: -1.8000 },
    { name: "HMNB Portsmouth", lat: 50.8010, lon: -1.1100 },
    { name: "HMNB Clyde (Faslane)", lat: 56.0520, lon: -4.8250 },
    { name: "Cawdor Barracks (Brawdy, Pembrokeshire)", lat: 51.8770, lon: -5.1230 },
    { name: "MOD St Athan", lat: 51.4040, lon: -3.4350 }
  ];

  function makePoiIcon(emoji, kind){
    const cls = kind === 'airport' ? 'poi-icon poi-airport' : 'poi-icon poi-base';
    return L.divIcon({
      className: '',
      html: `<div class="${cls}">${emoji}</div>`,
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });
  }

  const airportIcon = makePoiIcon("✈️", "airport");
  const baseIcon = makePoiIcon("🛡️", "base");

  function buildPoiLayers(){
    airportsLayer.clearLayers();
    basesLayer.clearLayers();

    const esc = (str) => String(str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));

    AIRPORTS.forEach(a => {
      const mk = L.marker([a.lat, a.lon], { icon: airportIcon, title: a.name })
        .bindPopup(`<div class="poi-popup-wrap"><div class="poi-popup-title">${esc(a.name)}</div><div class="poi-popup-sub">Airport</div><div class="poi-popup-meta">Lat ${Number(a.lat).toFixed(4)}, Lon ${Number(a.lon).toFixed(4)}</div><div class="poi-popup-actions"><a class="poi-popup-btn" href="https://www.google.com/maps?q=${encodeURIComponent(a.lat + ',' + a.lon)}" target="_blank" rel="noopener">Open in Google Maps</a></div></div>`, { className: 'poi-popup', closeButton: true, autoPanPadding: [18,18], maxWidth: 260 })
        .bindTooltip(esc(a.name), { className: 'poi-tip', direction: 'top', offset: [0, -10], opacity: 0.95 });
      airportsLayer.addLayer(mk);
    });

    BASES.forEach(b => {
      const mk = L.marker([b.lat, b.lon], { icon: baseIcon, title: b.name })
        .bindPopup(`<div class="poi-popup-wrap"><div class="poi-popup-title">${esc(b.name)}</div><div class="poi-popup-sub">Military base</div><div class="poi-popup-meta">Lat ${Number(b.lat).toFixed(4)}, Lon ${Number(b.lon).toFixed(4)}</div><div class="poi-popup-actions"><a class="poi-popup-btn" href="https://www.google.com/maps?q=${encodeURIComponent(b.lat + ',' + b.lon)}" target="_blank" rel="noopener">Open in Google Maps</a></div></div>`, { className: 'poi-popup', closeButton: true, autoPanPadding: [18,18], maxWidth: 260 })
        .bindTooltip(esc(b.name), { className: 'poi-tip', direction: 'top', offset: [0, -10], opacity: 0.95 });
      basesLayer.addLayer(mk);
    });
  }

  buildPoiLayers();

  // Fix occasional "map misalignment" (Leaflet needs a resize invalidate after layout settles)
  function fixMapSizeSoon(){
    setTimeout(() => { try { map.invalidateSize(true); } catch(e){} }, 50);
    setTimeout(() => { try { map.invalidateSize(true); } catch(e){} }, 300);
    setTimeout(() => { try { map.invalidateSize(true); } catch(e){} }, 900);
  }
  window.addEventListener('resize', () => fixMapSizeSoon());


  // State
  let ufoRecords = [];
  let cropRecords = [];
  let cropLoaded = false;

  // `records` is the ACTIVE dataset used for rendering (based on toggles).
  // `recordsAll` is everything currently loaded (used for slider range / totals).
  let records = [];
  let recordsAll = [];

  let markersById = new Map();
  let currentYearMin = 1900, currentYearMax = 2100;

  // UK-ish bounds (used to detect swapped coordinates / bad geocodes)
  const UK_SOFT_BOUNDS = { minLat: 45.0, maxLat: 65.0, minLon: -12.0, maxLon: 6.0 };

  function isWithinBounds(lat, lon, b){
    return Number.isFinite(lat) && Number.isFinite(lon) &&
           lat >= b.minLat && lat <= b.maxLat && lon >= b.minLon && lon <= b.maxLon;
  }

  // If a row has lat/lon swapped (common), detect and fix it.
  function normaliseCoords(lat, lon){
    const la = Number(lat), lo = Number(lon);
    if(!Number.isFinite(la) || !Number.isFinite(lo)) return { lat: la, lon: lo, fixed: false };

    // Correct if it looks swapped: lat is UK-ish longitude range and lon is UK-ish latitude range
    if(la >= UK_SOFT_BOUNDS.minLon && la <= UK_SOFT_BOUNDS.maxLon &&
       lo >= UK_SOFT_BOUNDS.minLat && lo <= UK_SOFT_BOUNDS.maxLat){
      return { lat: lo, lon: la, fixed: true };
    }
    return { lat: la, lon: lo, fixed: false };
  }

  function setStatus(type, text){
    els.statusDot.classList.remove('ok','warn','bad');
    els.statusDot.classList.add(type);
    els.statusText.textContent = text;
  }
  function setProgress(done, total){
    const pct = total ? Math.round((done/total)*100) : 0;
    els.progBar.style.width = pct + '%';
  }

  function safeYear(dateStr){
    if(!dateStr) return null;
    const s = String(dateStr).trim();

    // 4-digit year (preferred)
    let m = s.match(/\b(18\d{2}|19\d{2}|20\d{2})\b/);
    if(m) return parseInt(m[1], 10);

    // Try common numeric date formats with 2-digit year, e.g. 1/2/07, 01-02-07, 2007 already handled above.
    m = s.match(/(?:^|\b)(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})(?:\b|$)/);
    if(m){
      const yy = parseInt(m[3], 10);
      if(Number.isFinite(yy)){
        // Pivot: 00-29 => 2000-2029, else 1930-1999
        return (yy <= 29) ? (2000 + yy) : (1900 + yy);
      }
    }

    // Fallback: any 2-digit year token at the end, e.g. "Jan 05" / "05"
    m = s.match(/(?:\b|\D)(\d{2})(?:\s*)$/);
    if(m){
      const yy = parseInt(m[1], 10);
      if(Number.isFinite(yy)){
        return (yy <= 29) ? (2000 + yy) : (1900 + yy);
      }
    }

    return null;
  }

  function parseSources(src){
    if(!src) return [];
    return String(src)
      .split(/[\n;,|]+/)
      .map(s=>s.trim())
      .filter(Boolean);
  }

  function parseVideos(v){
    if(!v) return [];
    return String(v)
      .split(/[\n;,|]+/)
      .map(s=>s.trim())
      .filter(Boolean);
  }


  
  // Case-insensitive, trimmed header lookup (handles 'Weather ', 'weather summary', etc.)
  function getField(row, names){
    if(!row) return '';
    const keys = Object.keys(row);
    for(const n of names){
      const target = String(n).trim().toLowerCase();
      // direct
      for(const k of keys){
        if(String(k).trim().toLowerCase() === target){
          return row[k];
        }
      }
    }
    return '';
  }


  function buildCombinedLocation(row){
    // Try to assemble a human-readable location from common column names if 'Location' isn't present.
    const parts = [];

    // Place / site style fields
    const place = getField(row, ['Place','place','Site','site','Field','field','Farm','farm','Name of field','name of field','Nearest field','nearest field','Location name','location name']);
    if(place) parts.push(String(place).trim());

    // Town / village / nearest settlement
    const town = getField(row, ['Town','town','Village','village','Nearest town','nearest town','Nearest village','nearest village','City','city','Locality','locality','Near','near']);
    if(town) parts.push(String(town).trim());

    // County / region
    const county = getField(row, ['County','county','Region','region','Area','area','District','district']);
    if(county) parts.push(String(county).trim());

    // Country
    const country = getField(row, ['Country','country']);
    if(country) parts.push(String(country).trim());

    // De-dup + join
    const uniq = Array.from(new Set(parts.filter(Boolean)));
    return uniq.join(', ');
  }

  function buildCropType(row){
    // Crop circle "type" varies a lot in spreadsheets; try common naming patterns.
    return getField(row, [
      'Type','type',
      'Formation type','Formation Type','formation type',
      'Category','category',
      'Shape','shape',
      'Pattern','pattern',
      'Design','design',
      'Style','style',
      'Pictogram','pictogram',
      'Pictogram type','Pictogram Type','pictogram type'
    ]);
  }
      }
    }
    return '';
  }

function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"']/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[s]));
  }

  function isTruthyYes(v){
    const raw = String(v || '').trim().toLowerCase();
    // Accept values like: "yes", "yes (featured)", "y", "true", "1"
    if(['y','yes','true','1'].includes(raw)) return true;
    if(raw.startsWith('yes')) return true;
    if(raw.startsWith('y')) return true;
    if(raw.includes('yes')) return true;
    return false;
  }

    function makePopupHTML(r){
    const sources = parseSources(r.sources);
    const videos = parseVideos(r.videos);

    const sourcesBlock = sources.length
      ? `<div style="font-weight:800;margin-bottom:6px">Sources</div>
         ${sources.map((u,i) => {
            const label = `Source ${i+1}`;
            const isUrl = looksLikeUrl(u);
            return `<div style="margin:4px 0">
              ${isUrl
                ? `<a href="${escapeHtml(u)}" target="_blank" rel="noopener">${label}</a>`
                : `<span>${escapeHtml(u)}</span>`
              }
            </div>`;
          }).join('')}`
      : '';

    const videosBlock = videos.length
      ? `<div style="font-weight:800;margin-bottom:6px">${(r.type === 'crop') ? 'Media' : 'Videos'}</div>
         ${videos.map((u,i) => {
            const label = `${(r.type === 'crop') ? 'Media' : 'Video'} ${i+1}`;
            const isUrl = looksLikeUrl(u);
            return `<div style="margin:4px 0">
              ${isUrl
                ? `<a href="${escapeHtml(u)}" target="_blank" rel="noopener">${label}</a>`
                : `<span>${escapeHtml(u)}</span>`
              }
            </div>`;
          }).join('')}`
      : '';

    const isFeatured = isTruthyYes(r.highlight);

    // Prefer a provided "slug" column; otherwise derive from the case title.
    function slugify(v){
      return String(v || '')
        .trim()
        .toLowerCase()
        .replace(/['"]/g,'')
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/^-+|-+$/g,'');
    }
    // Prefer a provided "slug" column; otherwise derive from the case title.
    // You can override specific cases via the alias map below.
    const aliasSlugs = {
      'rendlesham forest incident': 'rendlesham'
    };
    const baseTitle = (r.case || '').toString().trim().toLowerCase();
    const slug = (r.slug && String(r.slug).trim())
      ? String(r.slug).trim().toLowerCase()
      : (aliasSlugs[baseTitle] || slugify(r.case || 'case'));
    const readMoreHref = `case/${encodeURIComponent(slug)}/`;
    const readMoreTag = isFeatured ? ` <a class="tag tag-readmore" href="${readMoreHref}">Read more</a>` : '';

    let linksHtml = '';
    if(sources.length || videos.length){
      if(sources.length && videos.length){
        linksHtml = `<div class="divider"></div>
          <div style="display:flex;gap:14px;align-items:flex-start">
            <div style="flex:1;min-width:0">${sourcesBlock}</div>
            <div style="flex:1;min-width:0">${videosBlock}</div>
          </div>`;
      }else if(sources.length){
        linksHtml = `<div class="divider"></div>${sourcesBlock}`;
      }else{
        linksHtml = `<div class="divider"></div>${videosBlock}`;
      }
    }

    const tags = `
      <div class="tags">
        <span class="tag">${r.type === 'crop' ? 'Crop circle' : 'UFO sighting'}</span>
        ${r.region ? `<span class="tag">${escapeHtml(r.region)}</span>` : ''}
        ${Number.isFinite(Number(r.cred)) ? `<span class="tag">Credibility: ${escapeHtml(String(r.cred))}</span>` : ''}
        ${r.status ? `<span class="tag">${escapeHtml(r.status)}</span>` : ''}
        ${r.type !== 'crop' ? (() => {
          const raw = String(r.encounter || '').trim().toLowerCase();
          const isYes = ['yes','y','true','1'].includes(raw);
          const enc = raw ? (isYes ? 'Yes' : 'No') : 'No';
          return `<span class="tag">Encounter: ${enc}</span>`;
        })() : ''}
        ${readMoreTag}
      </div>`;

    const weatherBlock = (r.weather && String(r.weather).trim())
      ? `<div style="margin:10px 0 12px;padding:10px 12px;border:1px solid rgba(0,0,0,.08);border-radius:14px;background:#f9fafb">
           <div style="font-weight:800;margin-bottom:6px">Weather</div>
           <div style="font-size:13px;line-height:1.35">${escapeHtml(r.weather)}</div>
           ${r.weather_source ? `<div style="font-size:11px;color:#6b7280;margin-top:6px">Source: ${escapeHtml(r.weather_source)}</div>` : ''}
         </div>`
      : '';

    return `
      <div class="popup-inner">
        <h3>${escapeHtml(r.case)}</h3>
        <p class="popup-date">${escapeHtml(r.date || '')}${r.time ? ` • ${escapeHtml(r.time)}` : ''}</p>
        ${tags}
        ${weatherBlock}
        <div style="font-size:13px;line-height:1.45">
          <div><span class="k">Location:</span> ${escapeHtml(r.location || '—')}</div>
          ${r.type !== 'crop' ? `<div style="margin-top:8px"><span class="k">Witness:</span> ${escapeHtml(r.witness || '—')}</div>` : ''}
          <div style="margin-top:8px"><span class="k">${r.type === 'crop' ? 'Type' : 'Evidence'}:</span> ${escapeHtml(r.evidence || '—')}</div>
          ${r.summary ? `<div class="summary">${escapeHtml(r.summary)}</div>` : ''}
          ${r.why ? `<div style="margin-top:10px;color:#6b7280">${escapeHtml(r.why)}</div>` : ''}
          ${r.type === 'crop' ? (buildCropImagesHTML(r) + buildCropExtraDetailsHTML(r)) : ''}
          ${linksHtml}
        </div>
      </div>
    `;
  }

  function markerColorByRecord(r){
    // Crop circles get a distinct colour so they can be spotted at a glance.
    if(r && r.type === 'crop') return '#a78bfa';

    const c = Number((r && r.cred) || 0);
    if(c >= 4) return '#22c55e';
    if(c >= 3) return '#60a5fa';
    return '#f59e0b';
  }

  function makeCircleMarker(lat, lon, r){
    const color = markerColorByRecord(r);
    return L.circleMarker([lat, lon], {
      radius: 7,
      weight: 2,
      color: color,
      fillColor: color,
      fillOpacity: 0.25
    });
  }

  function clearMarkers(){
    cluster.clearLayers();
    markersById.clear();
    if(heatLayer) heatLayer.setLatLngs([]);
  }

  function matchesFilters(r){
    const q = els.search.value.trim().toLowerCase();
    const reg = els.region.value;
    const minCred = parseInt(els.minCred.value, 10);
    const y = Number(r.year);
    const enc = (els.encounter && els.encounter.value) ? els.encounter.value : '';

    if(els.toggleCrop && !els.toggleCrop.checked && r.type === 'crop') return false;

    if(q){
      const hay = [r.case,r.location,r.region,r.summary,r.witness,r.evidence,r.status,r.weather].join(' ').toLowerCase();
      if(!hay.includes(q)) return false;
    }
    if(reg && (r.region || '') !== reg) return false;
    if((r.cred || 0) < minCred) return false;
    if(!Number.isFinite(y)) return false;
    if(y < currentYearMin || y > currentYearMax) return false;

    if(enc && r.type !== 'crop'){
      const raw = String(r.encounter || '').trim().toLowerCase();
      const isYes = ['yes','y','true','1'].includes(raw);
      const rowEnc = raw ? (isYes ? 'yes' : 'no') : 'no';
      if(rowEnc !== enc) return false;
    }

    return true;
  }

  function syncActiveRecords(){
    const showUfo = !!(els.toggleUfo && els.toggleUfo.checked);
    const showCrop = !!(els.toggleCrop && els.toggleCrop.checked);
    records = [
      ...(showUfo ? ufoRecords : []),
      ...((showCrop && cropLoaded) ? cropRecords : [])
    ];
  }

  function recomputeYearSliderRange(){
  // Use everything that is currently loaded (UFO always loaded; crop only once enabled)
  const loaded = [...ufoRecords, ...(cropLoaded ? cropRecords : [])];
  const years = loaded.map(r => r.year).filter(Boolean);
  const minY = years.length ? Math.min(...years) : 1950;
  const maxY = years.length ? Math.max(...years) : new Date().getFullYear();
  initYearSlider(minY, maxY);
}


  function render(){
    syncActiveRecords();

    clearMarkers();
    if(els.list) els.list.innerHTML = '';

    const shown = records.filter(matchesFilters);
    els.kpiShown.textContent = shown.length;

    for(const r of shown){
      if(!Number.isFinite(r.lat) || !Number.isFinite(r.lon)) continue;

      if(isDensityOn()){
        // Weight: credibility (1..5) mapped to 0.6..1.2 so higher-cred cases glow a bit more
        const w = Math.max(0.6, Math.min(1.2, (Number(r.cred || 1) / 5) * 1.2));
        // Leaflet.heat accepts [lat, lng, intensity]
        heatLayer && heatLayer.addLatLng([r.lat, r.lon, w]);
      } else {
        const m = makeCircleMarker(r.lat, r.lon, r);
        m.bindPopup(makePopupHTML(r), { maxWidth: 420 });
        m.on('click', () => highlightListItem(r.id));
        cluster.addLayer(m);
        markersById.set(r.id, m);
      }
    }

    lastShownLatLngs = shown.filter(r => Number.isFinite(r.lat) && Number.isFinite(r.lon)).map(r => [r.lat, r.lon]);
    applyDensityMode();

    const featured = shown.filter(r => isTruthyYes(r.highlight));

    // List: show highlighted cases only (featured)
    for(const r of featured.slice(0, 1000)){
      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.id = r.id;
      div.innerHTML = `
        <p class="title">${escapeHtml(r.case)}</p>
        <p class="meta">${escapeHtml(r.location)} • ${escapeHtml(r.date || '')}</p>
        ${r.weather ? `<p class="meta" style="margin-top:6px; color:#6b7280">Weather: ${escapeHtml(r.weather).slice(0, 90)}${(String(r.weather).length>90?'…':'')}</p>` : ''}
        <div style="margin-top:8px">
          <span class="pill">${escapeHtml(r.region || '—')}</span>
          <span class="pill">Cred: ${escapeHtml(String(r.cred || '—'))}</span>
          <span class="pill">${escapeHtml(r.status || '—')}</span>
        </div>
      `;
      div.addEventListener('click', () => {
        const mk = markersById.get(r.id);
        if(mk){
          const targetZoom = Math.max(map.getZoom(), 12);
          // If marker clustering is enabled, ensure the marker is visible before opening its popup
          if (cluster && typeof cluster.zoomToShowLayer === 'function') {
            cluster.zoomToShowLayer(mk, () => {
              map.flyTo(mk.getLatLng(), targetZoom, { animate: true, duration: 0.6 });
              mk.openPopup();
              highlightListItem(r.id);
            });
          } else {
            map.flyTo(mk.getLatLng(), targetZoom, { animate: true, duration: 0.6 });
            mk.openPopup();
            highlightListItem(r.id);
          }
        }
      });
      els.list.appendChild(div);
    }

    if(shown.length === 0){
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.textContent = 'No results match your filters.';
      els.list.appendChild(empty);
    } else if(featured.length === 0){
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.textContent = 'No highlighted cases in the current selection.';
      els.list.appendChild(empty);
    }
  }

function highlightListItem(id){
  const el = els.list.querySelector(`.item[data-id="${id}"]`);
  if(!el) return;

  // Scroll ONLY inside the results container (prevents page jumping)
  const container = els.list; // this is the scrollable area
  const top = el.offsetTop - (container.clientHeight / 2) + (el.clientHeight / 2);

  container.scrollTo({
    top: Math.max(0, top),
    behavior: 'smooth'
  });
}


  function fitToMarkers(){
    const density = isDensityOn();
    const layers = density ? [] : cluster.getLayers();
    const llArr = density ? lastShownLatLngs : null;

    if(density){
      if(!llArr || !llArr.length) return;
    } else {
      if(!layers.length) return;
    }

    // If a few outliers are far outside the UK, they can blow up bounds and trigger a false warning.
    // So we fit to UK-ish points first, and only warn if most markers look non-UK.
    const within = [];
    let outsideCount = 0;

    for(const lyr of (isDensityOn() ? lastShownLatLngs.map(ll => ({getLatLng:()=>({lat:ll[0],lng:ll[1]})})) : layers)){
      if(!lyr || !lyr.getLatLng) continue;
      const ll = lyr.getLatLng();
      if(isWithinBounds(ll.lat, ll.lng, UK_SOFT_BOUNDS)){
        within.push(lyr);
      } else {
        outsideCount += 1;
      }
    }

    const total = within.length + outsideCount;

    // Nothing usable to fit
    if(!within.length){
      setStatus('warn', 'Loaded data, but none of the plotted coordinates look UK-based. Check your lat/lon columns (or rely on Location geocoding).');
      map.setView([54.5, -3.0], 6);
      return;
    }

    // Warn only if a majority look outside the UK (swapped coords / wrong units / bad geocodes).
    if(total && (outsideCount / total) > 0.5){
      setStatus('warn', 'Data loaded, but many marker coordinates look outside the UK. Check your lat/lon columns (or rely on Location geocoding).');
    }

    const group = L.featureGroup(within);
    const b = group.getBounds();
    map.fitBounds(b.pad(0.2));
  }


  function initYearSlider(minY, maxY){
  currentYearMin = minY;
  currentYearMax = maxY;

  // Create once; later we update the range without destroying to avoid edge-case breakage.
  if(!els.yearSlider.noUiSlider){
    noUiSlider.create(els.yearSlider, {
      start: [minY, maxY],
      connect: true,
      step: 1,
      range: { min: minY, max: maxY },
      format: { to: v => Math.round(v), from: v => parseInt(v,10) }
    });

    els.yearSlider.noUiSlider.on('update', (values) => {
      currentYearMin = parseInt(values[0],10);
      currentYearMax = parseInt(values[1],10);
      els.yearMin.textContent = currentYearMin;
      els.yearMax.textContent = currentYearMax;
      render();
    });
  } else {
    // If it already exists, update the bounds and clamp current values.
    const s = els.yearSlider.noUiSlider;
    const cur = s.get().map(v => parseInt(v,10));
    const clamped = [
      Math.max(minY, Math.min(maxY, cur[0])),
      Math.max(minY, Math.min(maxY, cur[1]))
    ];
    s.updateOptions({ range: { min: minY, max: maxY } }, false);
    s.set(clamped);
  }

  els.yearMin.textContent = currentYearMin;
  els.yearMax.textContent = currentYearMax;
}


  function populateRegionOptions(){
    const set = new Set(recordsAll.map(r => r.region).filter(Boolean));
    const regions = Array.from(set).sort();
    els.region.innerHTML = '<option value="">All</option>' + regions.map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join('');
  }


  function looksLikeUrl(s){
    const v = String(s || '').trim();
    return /^https?:\/\//i.test(v);
  }

  function extractUrlsFromValue(val){
    const v = String(val || '').trim();
    if(!v) return [];
    const m = v.match(/https?:\/\/[^\s)\]}>"']+/gi);
    return m ? m.map(x => x.trim()) : [];
  }

  function harvestLinksFromRaw(raw){
    if(!raw) return [];
    const out = [];
    for(const [k, v] of Object.entries(raw)){
      const key = String(k || '');
      const isLikelyLinkField = /(source|sources|reference|references|ref|website|url|link|links)/i.test(key);
      if(isLikelyLinkField){
        out.push(...extractUrlsFromValue(v));
      }
    }
    // Also collect any obvious URLs anywhere in the row (helps when the sheet uses unconventional headers)
    for(const v of Object.values(raw)){
      out.push(...extractUrlsFromValue(v));
    }
    // unique
    return Array.from(new Set(out));
  }

  
  function parseImageUrls(value){
    if(!value) return [];
    const v = String(value).trim();
    if(!v) return [];
    // Prefer explicit URLs; fall back to splitting common delimiters.
    const urls = extractUrlsFromValue(v);
    if(urls.length) return urls;
    // If someone pasted direct links without protocol, ignore rather than guessing.
    return v.split(/[\n,;|]+/g).map(s => s.trim()).filter(Boolean).filter(s => /^https?:\/\//i.test(s));
  }

  function buildCropImagesHTML(r){
    const imgs = parseImageUrls(r && r.images);
    if(!imgs.length) return '';
    const max = 6;
    const shown = imgs.slice(0, max);
    const items = shown.map((u, i) => {
      const cls = (shown.length === 1) ? 'single' : '';
      const safe = escapeHtml(u);
      return `<a class="${cls}" href="${safe}" target="_blank" rel="noopener">
                <img loading="lazy" src="${safe}" alt="Crop circle image ${i+1}">
              </a>`;
    }).join('');
    const more = (imgs.length > max) ? `<div style="margin-top:8px;color:#6b7280;font-size:12px">+${imgs.length-max} more image(s) in sheet</div>` : '';
    return `<div style="margin-top:12px">
              <div style="font-weight:800;margin-bottom:6px">Images</div>
              <div class="popup-images">${items}</div>
              ${more}
            </div>`;
  }

function buildCropExtraDetailsHTML(r){
    const raw = r && r._raw ? r._raw : null;
    if(!raw) return '';
    const hiddenKeys = new Set([
      'lat','latitude','lon','lng','long','longitude',
      'date','date (local)','seen','time','date_iso','date iso','iso date',
      'year','region','location',
      'title','name','formation','crop circle','case',
      'summary','description','notes','details',
      'type','category','shape','pattern',
      'status','verified','credibility','credibility (1-5)','rating','cred',
      'sources','source','links','link','url','videos','video','photo','image','images',
      'slug','highlights','highlight','why','why considered reputable',
      'weather','weather summary','historical weather','historic weather','weather source','weather data source'
    ].map(x => x.toLowerCase()));

    const rows = [];
    for(const [k, v0] of Object.entries(raw)){
      const kNorm = String(k || '').trim().toLowerCase();
      if(!kNorm || hiddenKeys.has(kNorm)) continue;
      const v = String(v0 ?? '').trim();
      if(!v) continue;

      // Make a nicer label
      const label = String(k || '').trim().replace(/_/g,' ');
      // Linkify URLs
      const urls = extractUrlsFromValue(v);
      let valueHtml = '';
      if(urls.length){
        valueHtml = urls.map((u,i)=>`<a href="${escapeHtml(u)}" target="_blank" rel="noopener">Link ${i+1}</a>`).join(' • ');
        // If there's non-url text too, include it
        const nonUrl = v.replace(/https?:\/\/[^\s)\]}>"']+/gi,'').replace(/[,;|]+/g,' ').trim();
        if(nonUrl) valueHtml = `${escapeHtml(nonUrl)}<div style="margin-top:4px">${valueHtml}</div>`;
      }else{
        valueHtml = escapeHtml(v);
      }

      rows.push(`<div style="margin-top:8px"><span class="k">${escapeHtml(label)}:</span> ${valueHtml}</div>`);
    }

    if(!rows.length) return '';
    return `<details style="margin-top:12px">
      <summary style="cursor:pointer;font-weight:800;color:#111827">More details</summary>
      <div style="margin-top:8px;font-size:13px;line-height:1.45">${rows.join('')}</div>
      <div class="popup-actions">
        <button type="button" class="popup-btn" data-action="details-collapse">Collapse</button>
        <button type="button" class="popup-btn" data-action="popup-close">Close</button>
      </div>
    </details>`;
  }

  // Accept these coordinate headers:
  //  - lat/lon  (preferred)
  //  - Latitude/Longitude
  //  - Lat/Long  (your current sheet)
  function normaliseRow(r, idx, type){
    const latRaw = getField(r, ['lat','latitude','Lat','LAT']);
    const lonRaw = getField(r, ['lon','longitude','Long','LONG','lng','Lng']);

    const out = {
      id: `${type || 'ufo'}-${idx}`,
      type: (type || 'ufo'),
      _raw: r,

      // Title fields
      case: (type === 'crop')
        ? (getField(r, ['Title','title','Name','name','Formation','formation','Crop Circle','crop circle','Case','case']) || 'Crop circle')
        : (getField(r, ['Case','case']) || 'UFO sighting'),

      // Date/time fields
      date: getField(r, ['Date','date','Date (local)','date (local)','Seen','seen']),
      time: getField(r, ['Time','time']),
      date_iso: getField(r, ['Date_ISO','date_iso','Date ISO','Date (ISO)','ISO Date','Date ISO (UTC)','date iso']),

      location: (getField(r, ['Location','location']) || buildCombinedLocation(r)),
      region: getField(r, ['Region','region']),
      witness: getField(r, ['Witness profile','Witness','witness','Witnesses','witnesses']),
      evidence: (type === 'crop')
        ? (buildCropType(r) || '')
        : getField(r, ['Evidence','evidence']),
      images: (type === 'crop') ? getField(r, ['Images','images','Image','image','Photos','photos','Photo','photo','Pictures','pictures','Picture','picture']) : null,
      summary: getField(r, ['Summary','summary','Description','description','Notes','notes','Details','details']),
      status: getField(r, ['Status','status','Verified','verified']),
      highlight: getField(r, ['Highlights','Highlight','highlights','highlight']),
      slug: getField(r, ['Slug','slug']),
      // Default credibility for crop circles if column missing.
      cred: Number(getField(r, ['Credibility (1-5)','Credibility','credibility','Rating','rating','Cred','cred']) || (type === 'crop' ? 3 : 0)),
      why: getField(r, ['Why considered reputable','Why','why']),
      // Weather columns (support your new naming variations)
     weather: (() => {
  const w = String(getField(r, ['Weather','weather','Weather summary','Weather Summary','Historical weather','Historic weather','Weather (historic)','Weather (historical)']) || '').trim();
  // If it looks like a date/date-range, ignore it (prevents Date_ISO being shown as Weather)
  if (/^\d{4}-\d{2}(-\d{2})?(?:\s+to\s+\d{4}-\d{2}(-\d{2})?)?$/i.test(w)) return '';
  if (/^\d{1,2}\/\d{1,2}\/\d{4}(?:\s+to\s+\d{1,2}\/\d{1,2}\/\d{4})?$/i.test(w)) return '';
  return w;
})(),

      weather_source: getField(r, ['Weather source','weather source','Weather Source','Weather data source','Weather Data Source']),
      // Link fields (crop circles often have photo/source links rather than videos)
      sources: getField(r, ['Sources','sources','Source','source','URL','url','Link','link','Links','links']),
      videos: getField(r, ['Videos','videos','Video','video','Video links','video links','Photo','photo','Image','image','Images','images','Photo link','photo link','Image link','image link']),

      // Only applies to UFO sightings. Crop circles ignore this filter.
      encounter: (type === 'crop') ? '' : getField(r, ['Encounter','encounter']),

      year: safeYear(getField(r, ['Date_ISO','date_iso','Date','date','Year','year'])),
      lat: Number(latRaw),
      lon: Number(lonRaw)
    };

    // For crop circles, pull any URLs buried in other columns into the sources list
    if(type === 'crop'){
      const harvested = harvestLinksFromRaw(r);
      const existing = Array.from(new Set(parseSources(out.sources)));
      const merged = Array.from(new Set([...existing, ...harvested]));
      out.sources = merged.join('\n');
    }

    const fixed = normaliseCoords(out.lat, out.lon);
    out.lat = fixed.lat;
    out.lon = fixed.lon;

    return out;
  }

  // ==== Optional fallback geocoding (only if lat/lon missing) ====
  // Uses OpenStreetMap Nominatim. Please be considerate (rate-limited + cached).
  const GEO_CACHE_KEY = 'uk_anomaly_geo_cache_v2';
  const GEO_DELAY_MS = 1100; // ~1 req/sec
  const GEO_EMAIL = ''; // optional

  function loadGeoCache(){
    try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || '{}'); }
    catch { return {}; }
  }
  function saveGeoCache(cache){
    try { localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache)); } catch {}
  }
  function cacheKeyForLocation(loc){
    return String(loc || '').trim().toLowerCase();
  }
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  async function geocodeLocation(loc){
    const q = String(loc || '').trim();
    if(!q) return null;

    const params = new URLSearchParams({ format: 'json', q, limit: '1', addressdetails: '0' });
    if (GEO_EMAIL) params.set('email', GEO_EMAIL);

    const url = 'https://nominatim.openstreetmap.org/search?' + params.toString();
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if(!res.ok) throw new Error('Geocoding HTTP ' + res.status);
    const data = await res.json();
    if(!Array.isArray(data) || !data.length) return null;

    const hit = data[0];
    const lat = Number(hit.lat);
    const lon = Number(hit.lon);
    if(!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
    return { lat, lon };
  }

  async function geocodeMissingCoords(list){
    const arr = list || recordsAll;
    const cache = loadGeoCache();

    // Apply cache first
    for(const r of arr){
      if(Number.isFinite(r.lat) && Number.isFinite(r.lon)) continue;
      const key = cacheKeyForLocation(r.location);
      if(key && cache[key]){
        r.lat = Number(cache[key].lat);
        r.lon = Number(cache[key].lon);
      }
    }

    const queue = arr.filter(r => (!Number.isFinite(r.lat) || !Number.isFinite(r.lon)) && String(r.location || '').trim());
    if(!queue.length) return;

    setStatus('warn', `Geocoding ${queue.length} location(s)… (cached where possible)`);
    setProgress(0, queue.length);

    let done = 0;
    for(const r of queue){
      try{
        const key = cacheKeyForLocation(r.location);
        if(key && cache[key]){
          r.lat = Number(cache[key].lat);
          r.lon = Number(cache[key].lon);
        } else {
          const got = await geocodeLocation(r.location);
          if(got){
            r.lat = got.lat;
            r.lon = got.lon;
            if(key) cache[key] = got;
            saveGeoCache(cache);
          }
          await sleep(GEO_DELAY_MS);
        }
      } catch(e){
        console.warn('Geocode failed for:', r.location, e);
        await sleep(GEO_DELAY_MS);
      } finally {
        done += 1;
        setProgress(done, queue.length);
        render();
      }
    }

    const stillMissing = arr.filter(r => !Number.isFinite(r.lat) || !Number.isFinite(r.lon)).length;
    if(stillMissing){
      setStatus('warn', `Loaded ${arr.length} rows. ${stillMissing} still missing lat/lon (won’t plot).`);
    } else {
      setStatus('ok', `Loaded ${arr.length} rows. Ready.`);
    }
  }

function parseCsvToRows(csvUrl){
  const url = csvUrl + (csvUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (results) => resolve(Array.isArray(results.data) ? results.data : []),
      error: (err) => reject(err)
    });
  });
}
     async function loadUfoDataset(){
    setStatus('warn','Loading UFO sightings…');
    setProgress(0, 1);

    const ufoRaw = await parseCsvToRows(SHEET_CSV_URL).finally(() => setProgress(1, 1));
    ufoRecords = (ufoRaw || []).map((row, idx) => normaliseRow(row, idx, 'ufo'))
      .filter(r => (r.case || r.location || r.summary));

    recordsAll = [...ufoRecords, ...(cropLoaded ? cropRecords : [])];
    els.kpiTotal.textContent = recordsAll.length;

    // Initialise slider from what's loaded right now (UFO by default).
    const years = recordsAll.map(r => r.year).filter(Boolean);
    const minY = years.length ? Math.min(...years) : 1950;
    const maxY = years.length ? Math.max(...years) : new Date().getFullYear();
    initYearSlider(minY, maxY);

    populateRegionOptions();

    const missingCoords = recordsAll.filter(r => !Number.isFinite(r.lat) || !Number.isFinite(r.lon)).length;
    if(missingCoords){
      setStatus('warn', `Loaded ${recordsAll.length} rows (UFO: ${ufoRecords.length}). ${missingCoords} missing lat/lon (won't plot) — using Location geocoding as a fallback.`);
    } else {
      setStatus('ok', `Loaded ${recordsAll.length} rows (UFO: ${ufoRecords.length}). Ready.`);
    }

    render();
    fitToMarkers();
    fixMapSizeSoon();

    // Fallback: geocode rows missing lat/lon (rate-limited + cached)
    await geocodeMissingCoords(ufoRecords);
  }

  async function loadCropDataset(){
    setStatus('warn','Loading crop circles…');
    setProgress(0, 1);

    const cropRaw = await parseCsvToRows(CROP_CSV_URL).finally(() => setProgress(1, 1));
    cropRecords = (cropRaw || []).map((row, idx) => normaliseRow(row, idx, 'crop'))
      .filter(r => (r.case || r.location || r.summary));

    cropLoaded = true;
    recordsAll = [...ufoRecords, ...cropRecords];
    els.kpiTotal.textContent = recordsAll.length;

    // Expand slider range (if needed) to include crop circle years, while keeping the user's current selection.
    recomputeYearSliderRange();
    populateRegionOptions();

    const missingCoords = cropRecords.filter(r => !Number.isFinite(r.lat) || !Number.isFinite(r.lon)).length;
    if(missingCoords){
      setStatus('warn', `Loaded crop circles (${cropRecords.length}). ${missingCoords} missing lat/lon (won't plot) — using Location geocoding as a fallback.`);
    } else {
      setStatus('ok', `Loaded crop circles (${cropRecords.length}).`);
    }

    render();

    // Fallback: geocode rows missing lat/lon (rate-limited + cached)
    await geocodeMissingCoords(cropRecords);
  }


  ['input','change'].forEach(evt => {
    els.search.addEventListener(evt, () => render());
    els.region.addEventListener(evt, () => render());
    els.minCred.addEventListener(evt, () => render());
    if(els.encounter) els.encounter.addEventListener(evt, () => render());
  });

  els.fitBtn.addEventListener('click', () => { fitToMarkers(); fixMapSizeSoon(); });
  els.resetBtn.addEventListener('click', () => {
    els.search.value = '';
    els.region.value = '';
    els.minCred.value = '1';
    if(els.encounter) els.encounter.value = '';
    if(els.toggleUfo) els.toggleUfo.checked = true;
    if(els.toggleCrop) els.toggleCrop.checked = false;
    const slider = els.yearSlider.noUiSlider;
    if(slider){
      const r = slider.options.range;
      slider.set([r.min, r.max]);
    }
    render();
    fitToMarkers();
  });


  // Layer toggles (airports / bases)
  function syncLayerToggles(){
    if(els.toggleAirports){
      if(els.toggleAirports.checked){
        airportsLayer.addTo(map);
        updatePoiTooltipMode();
      } else {
        map.removeLayer(airportsLayer);
      }
    }
    if(els.toggleBases){
      if(els.toggleBases.checked){
        basesLayer.addTo(map);
        updatePoiTooltipMode();
      } else {
        map.removeLayer(basesLayer);
      }
    }
    if(els.toggleFlightPaths){
      if(els.toggleFlightPaths.checked){
        flightPathsGlow.addTo(map);
        flightPathsLine.addTo(map);
      } else {
        map.removeLayer(flightPathsGlow);
        map.removeLayer(flightPathsLine);
      }
    }

    if(els.toggleFlightHeat && flightHeatLayer){
      if(els.toggleFlightHeat.checked){
        flightHeatLayer.addTo(map);
      } else {
        map.removeLayer(flightHeatLayer);
      }
    }
  }

  // Make POI labels "stick" only when zoomed in (reduces clutter when zoomed out)
  function updatePoiTooltipMode(){
    const z = map.getZoom();
    const permanent = z >= 10;
    const upd = (layer) => {
      if(!layer) return;
      layer.eachLayer(mk => {
        if(!mk || !mk.getTooltip) return;
        const tt = mk.getTooltip();
        if(!tt) return;
        // Leaflet tooltips don't support toggling permanent directly; rebind when mode changes.
        const name = (tt.getContent && tt.getContent()) ? tt.getContent() : '';
        mk.unbindTooltip();
        mk.bindTooltip(name, { className: 'poi-tip', direction: 'top', offset: [0, -10], opacity: 0.95, permanent });
      });
    };
    if(map.hasLayer(airportsLayer)) upd(airportsLayer);
    if(map.hasLayer(basesLayer)) upd(basesLayer);
  }
  map.on('zoomend', () => updatePoiTooltipMode());


  if(els.toggleAirports) els.toggleAirports.addEventListener('change', syncLayerToggles);
  if(els.toggleBases) els.toggleBases.addEventListener('change', syncLayerToggles);
  if(els.toggleFlightPaths) els.toggleFlightPaths.addEventListener('change', syncLayerToggles);
  if(els.toggleFlightHeat) els.toggleFlightHeat.addEventListener('change', syncLayerToggles);
  if(els.toggleDensity) els.toggleDensity.addEventListener('change', () => { render(); });
  if(els.toggleUfo) els.toggleUfo.addEventListener('change', () => { render(); });

  if(els.toggleCrop) els.toggleCrop.addEventListener('change', async () => {
    if(els.toggleCrop.checked && !cropLoaded){
      try {
        await loadCropDataset();
      } catch(err){
        console.error(err);
        setStatus('bad', (err && err.message) ? err.message : String(err));
        // revert toggle if load fails
        els.toggleCrop.checked = false;
      }
    }
    render();
  });



  // Popup controls (collapse details / close popup)
  map.getContainer().addEventListener('click', (ev) => {
    const btn = ev.target && ev.target.closest ? ev.target.closest('[data-action]') : null;
    if(!btn) return;
    const action = btn.getAttribute('data-action');
    if(action === 'popup-close'){
      ev.preventDefault();
      map.closePopup();
      return;
    }
    if(action === 'details-collapse'){
      ev.preventDefault();
      const details = btn.closest('details');
      if(details) details.removeAttribute('open');
      return;
    }
  });

  loadUfoDataset().catch(err => {
    console.error(err);
    setStatus('bad', (err && err.message) ? err.message : String(err));
  });
})();
</script>

</body>
</html>