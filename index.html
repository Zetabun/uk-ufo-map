<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UK UFO / Alien Sightings Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Leaflet.heat (density layer) -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<!-- PapaParse (CSV) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- noUiSlider -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

  <style>
    :root{
      --bg:#0b0f19;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:rgba(255,255,255,.08);
      --accent:#60a5fa;
      --danger:#ef4444;
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      position:sticky;top:0;z-index:10;
    }
    header .left{display:flex;flex-direction:column;gap:2px}
    header h1{font-size:16px;margin:0;letter-spacing:.2px}
    header p{font-size:12px;margin:0;color:var(--muted)}
    header .right{display:flex;gap:8px;align-items:center}
    .btn{
      appearance:none;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);
      padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px;
    }
    .btn:hover{background:rgba(255,255,255,.07)}
    .wrap{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 58px)}
    #panel{
      border-right:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      padding:14px;
      height:calc(100vh - 58px);
      overflow-y:auto;
      overflow-x:hidden;
      min-height:0;
      -webkit-overflow-scrolling:touch;
    }
    #map{height:100%;width:100%;position:relative;z-index:0}
    .card{background:rgba(17,24,39,.7);border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1;min-width:120px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select{
      width:100%;padding:9px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);color:var(--text);outline:none;
    }
    input::placeholder{color:#6b7280}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{border:1px solid var(--border);border-radius:14px;padding:10px;background:rgba(0,0,0,.18)}
    .kpi .big{font-size:18px;font-weight:700}
    .kpi .small{font-size:12px;color:var(--muted)}
    .status{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:#f59e0b}
    .dot.bad{background:var(--danger)}
    #list{max-height:48vh;overflow:auto;padding-right:4px}
    .item{padding:10px;border:1px solid var(--border);border-radius:14px;background:rgba(0,0,0,.18);margin-bottom:10px;cursor:pointer}
    .item:hover{background:rgba(0,0,0,.28)}
    .item .title{font-weight:650;font-size:13px;margin:0 0 4px 0}
    .item .meta{font-size:12px;color:var(--muted);margin:0}
    .pill{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);margin-right:6px}
    .slider-wrap{padding:6px 2px 2px}
    .slider-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:8px}
    .progress{
      height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid var(--border)
    }
    .progress > div{height:100%;width:0;background:linear-gradient(90deg, var(--accent), #a78bfa)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    .smallbtn{font-size:11px;padding:6px 8px;border-radius:10px}
	
	/* Make Leaflet popups readable (force light-theme text) */
.leaflet-popup-content-wrapper,
.leaflet-popup-tip {
  background: #ffffff !important;
  color: #111827 !important;
}

.leaflet-popup-content{ color:#111827 !important; }
.leaflet-popup-content *{ color:#111827 !important; }.leaflet-popup-content a {
  color: #1d4ed8 !important;
  text-decoration: underline;
  word-break: break-word;
}

.leaflet-popup-content b,
.leaflet-popup-content strong {
  color: #111827 !important;
}

.leaflet-popup-close-button {
  color: #111827 !important;
}

html, body {
  height: 100%;
  margin: 0;
  overflow: hidden;
}
	
/* Slimmer year-range slider (noUiSlider) */
#yearSlider {
  margin-top: 10px;
  margin-bottom: 6px;
}

#yearSlider .noUi-target {
  border: none;
  box-shadow: none;
  height: 8px;              /* track height */
  border-radius: 999px;
}

#yearSlider .noUi-base,
#yearSlider .noUi-connects {
  height: 8px;
  border-radius: 999px;
}

#yearSlider .noUi-connect {
  border-radius: 999px;
}

#yearSlider .noUi-handle {
  width: 18px;              /* handle size */
  height: 18px;
  right: -9px;              /* keeps it centered */
  top: -5px;                /* vertical align to track */
  border-radius: 999px;
  border: 2px solid rgba(255,255,255,0.35);
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
}

#yearSlider .noUi-handle:before,
#yearSlider .noUi-handle:after {
  display: none;            /* removes the two little bars */
}

#yearSlider .noUi-touch-area {
  border-radius: 999px;
}
	
	
/* --- Leaflet popup: modern card styling --- */
.leaflet-popup-content-wrapper{
  border-radius: 18px !important;
  padding: 0 !important;
  box-shadow: 0 18px 50px rgba(0,0,0,0.22) !important;
  border: 1px solid rgba(0,0,0,0.08) !important;
}

.leaflet-popup-tip{
  box-shadow: 0 12px 30px rgba(0,0,0,0.18) !important;
}

.leaflet-popup-content{
  margin: 0 !important;
  width: 360px !important;       /* consistent size */
  max-width: 360px !important;
  font-family: inherit;
  color: #111827;
}

/* Scroll inside popup instead of giant bubbles */
.leaflet-popup-content .popup-inner{
  padding: 16px 16px 14px 16px;
  max-height: 70vh;
  overflow: auto;
}

/* Headings + spacing */
.leaflet-popup-content h3{
  margin: 0 0 6px 0;
  font-size: 18px;
  line-height: 1.2;
  letter-spacing: -0.01em;
}

.leaflet-popup-content .popup-date{
  color: #6b7280;
  font-size: 13px;
  margin: 0 0 12px 0;
}

/* Section labels */
.leaflet-popup-content .k{
  font-weight: 700;
}

/* Subtle divider */
.leaflet-popup-content .divider{
  height: 1px;
  background: rgba(0,0,0,0.08);
  margin: 12px 0;
}

/* Nicer source links */
.leaflet-popup-content a{
  color: #1d4ed8;
  text-decoration: none;
}
.leaflet-popup-content a:hover{
  text-decoration: underline;
}

/* Little tag pills */
.leaflet-popup-content .tags{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin: 8px 0 10px;
}
.leaflet-popup-content .tag{
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 999px;
  background: rgba(0,0,0,0.05);
  border: 1px solid rgba(0,0,0,0.06);
  color: #111827;
}

/* Read more pill (in popup tag row) */
.leaflet-popup-content a.tag.tag-readmore{
  background: rgba(29,78,216,.12);
  border: 1px solid rgba(29,78,216,.30);
  color: #1d4ed8;
  font-weight: 800;
  cursor: pointer;
}
.leaflet-popup-content a.tag.tag-readmore:hover{
  background: rgba(29,78,216,.18);
  text-decoration: none;
}

/* --- Dark dropdowns (select + options) --- */
select, option {
  background: #0b1220;
  color: #e5e7eb;
}

select {
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 14px;
  padding: 10px 12px;
  outline: none;
  box-shadow: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

/* Custom arrow (so it still looks like a dropdown) */
.select-wrap {
  position: relative;
}
.select-wrap::after {
  content: "‚ñæ";
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: rgba(229,231,235,0.8);
  font-size: 14px;
}

/* Hover / focus */
select:hover {
  border-color: rgba(255,255,255,0.22);
}
select:focus {
  border-color: rgba(96,165,250,0.7);
  box-shadow: 0 0 0 4px rgba(96,165,250,0.12);
}


/* --- iOS-style toggles --- */
.toggle-row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0}
.toggle-row .label{font-size:12px;color:var(--muted);line-height:1.2}
.switch{position:relative;display:inline-block;width:44px;height:26px;flex:0 0 auto}
.switch input{opacity:0;width:0;height:0}
.slider{
  position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;
  background:rgba(255,255,255,.12);transition:.2s;border-radius:999px;border:1px solid var(--border)
}
.slider:before{
  position:absolute;content:"";height:22px;width:22px;left:2px;top:1px;
  background:white;transition:.2s;border-radius:999px;box-shadow:0 8px 20px rgba(0,0,0,.35)
}
.switch input:checked + .slider{background:rgba(96,165,250,.45);border-color:rgba(96,165,250,.55)}
.switch input:checked + .slider:before{transform:translateX(18px)}
.layer-hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:6px}


/* --- POI bubbles (airports / bases) --- */
.poi-icon{
  width: 30px;
  height: 30px;
  border-radius: 999px;
  position: relative;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 15px;
  box-shadow: 0 12px 28px rgba(0,0,0,.38);
  border: 1px solid rgba(255,255,255,.22);
  background: rgba(17,24,39,.9);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  transform: translateZ(0);
}
.poi-icon::before{
  content:"";
  position:absolute;
  inset:-6px;
  border-radius: 999px;
  background: radial-gradient(circle at 50% 50%, rgba(96,165,250,.35), rgba(96,165,250,0) 62%);
  filter: blur(0.5px);
  opacity: .85;
  pointer-events:none;
}
.poi-airport::before{
  background: radial-gradient(circle at 50% 50%, rgba(34,197,94,.35), rgba(34,197,94,0) 62%);
}
.poi-base::before{
  background: radial-gradient(circle at 50% 50%, rgba(239,68,68,.35), rgba(239,68,68,0) 62%);
}
/* Gentle pulse ring */
.poi-icon::after{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius: 999px;
  border: 2px solid rgba(255,255,255,.14);
  animation: poiPulse 2.6s ease-in-out infinite;
  pointer-events:none;
}
@keyframes poiPulse{
  0%{ transform: scale(1); opacity:.65; }
  70%{ transform: scale(1.35); opacity:0; }
  100%{ transform: scale(1.35); opacity:0; }
}
/* Tooltip styling */
.leaflet-tooltip.poi-tip{
  background: rgba(17,24,39,.94);
  color: #e5e7eb;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 999px;
  padding: 6px 10px;
  box-shadow: 0 12px 30px rgba(0,0,0,.38);
  font-size: 12px;
}
.leaflet-tooltip.poi-tip:before{
  border-top-color: rgba(17,24,39,.94);
}

/* Cluster bubbles for POIs */
.poi-cluster{
  width: 34px;
  height: 34px;
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 800;
  color: #0b0f19;
  border: 1px solid rgba(255,255,255,.22);
  box-shadow: 0 14px 34px rgba(0,0,0,.42);
}
.poi-cluster.airports{ background: rgba(34,197,94,.9); }
.poi-cluster.bases{ background: rgba(239,68,68,.9); }


/* --- POI popup (airports / bases) --- */
.leaflet-popup.poi-popup .leaflet-popup-content-wrapper{
  background: rgba(17,24,39,.96);
  color: #e5e7eb;
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 14px;
  box-shadow: 0 18px 48px rgba(0,0,0,.55);
  padding: 8px 10px;
}
.leaflet-popup.poi-popup .leaflet-popup-content{
  margin: 0;
  line-height: 1.25;
  font-size: 13px;
  min-width: 160px;
  max-width: 260px;
}
.leaflet-popup.poi-popup .leaflet-popup-tip{
  background: rgba(17,24,39,.96);
  border: 1px solid rgba(255,255,255,.14);
}
.leaflet-popup.poi-popup .leaflet-popup-close-button{
  color: rgba(229,231,235,.9);
  width: 28px;
  height: 28px;
  font-size: 18px;
  padding: 2px 6px 0 0;
}
.leaflet-popup.poi-popup .leaflet-popup-close-button:hover{
  color: #fff;
}
.poi-popup-title{
  font-weight: 800;
  font-size: 14px;
  margin: 0 0 2px 0;
}
.poi-popup-sub{
  font-size: 12px;
  color: rgba(229,231,235,.78);
}


/* Popup layout helpers */
.poi-popup-wrap{
  display:flex;
  flex-direction:column;
  gap: 6px;
  padding: 2px 4px 2px 2px;
}
.poi-popup-meta{
  font-size: 11px;
  color: rgba(229,231,235,.65);
}
.poi-popup-actions{
  display:flex;
  gap: 8px;
  margin-top: 2px;
}
.poi-popup-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding: 7px 10px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 700;
  text-decoration: none;
  color: #e5e7eb;
  background: rgba(59,130,246,.18);
  border: 1px solid rgba(59,130,246,.35);
}
.poi-popup-btn:hover{
  background: rgba(59,130,246,.28);
}
.poi-popup-btn.secondary{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
}
.poi-popup-btn.secondary:hover{
  background: rgba(255,255,255,.10);
}
/* Give the close button room so it doesn't overlap content */
.leaflet-popup.poi-popup .leaflet-popup-content-wrapper{
  padding: 10px 36px 10px 12px;
}


/* --- POI popup sizing + override (ensure it actually applies) --- */
.leaflet-popup.poi-popup .leaflet-popup-content-wrapper,
.leaflet-popup.poi-popup .leaflet-popup-tip{
  background: rgba(17,24,39,.96) !important;
}
.leaflet-popup.poi-popup .leaflet-popup-content-wrapper{
  color: #e5e7eb !important;
  border: 1px solid rgba(255,255,255,.14) !important;
  border-radius: 14px !important;
  box-shadow: 0 18px 48px rgba(0,0,0,.55) !important;
  padding: 12px 40px 12px 14px !important; /* room for close button */
  max-width: 260px !important;
}
.leaflet-popup.poi-popup .leaflet-popup-content{
  margin: 0 !important;
  width: auto !important;
  max-width: 230px !important;
}
.leaflet-popup.poi-popup a{
  color: inherit;
}
.poi-popup-wrap{
  max-width: 230px;
}
.poi-popup-title{
  font-size: 16px;
  font-weight: 900;
  letter-spacing: .2px;
}
.poi-popup-sub{
  margin-top: 2px;
}
.poi-popup-actions{
  margin-top: 8px;
}
.poi-popup-btn{
  width: 100%;
  white-space: nowrap;
}


/* --- POI popup (light, match case popups) --- */
.leaflet-popup.poi-popup .leaflet-popup-content-wrapper,
.leaflet-popup.poi-popup .leaflet-popup-tip{
  background: #ffffff !important;
}
.leaflet-popup.poi-popup .leaflet-popup-content-wrapper{
  color: #111827 !important;
  border: 1px solid rgba(17,24,39,.14) !important;
  box-shadow: 0 18px 48px rgba(0,0,0,.20) !important;
}
.leaflet-popup.poi-popup .leaflet-popup-close-button{
  color: #111827 !important;
}
.leaflet-popup.poi-popup .poi-popup-sub,
.leaflet-popup.poi-popup .poi-popup-meta{
  color: rgba(17,24,39,.70) !important;
}
.leaflet-popup.poi-popup .poi-popup-btn{
  background: rgba(29,78,216,.10) !important;
  border: 1px solid rgba(29,78,216,.28) !important;
  color: #111827 !important;
}
.leaflet-popup.poi-popup .poi-popup-btn:hover{
  background: rgba(29,78,216,.16) !important;
}


    /* =========================
       iOS Grey theme (LEFT PANEL)
       ========================= */
    :root{
      --ios-bg:#f2f2f7;
      --ios-card:#ffffff;
      --ios-card2:#f7f7fa;
      --ios-text:#1c1c1e;
      --ios-muted:#6e6e73;
      --ios-border:rgba(60,60,67,0.18);
      --ios-border2:rgba(60,60,67,0.10);
      --ios-accent:#007aff;
      --ios-danger:#ff3b30;
      --ios-ok:#34c759;
      --ios-warn:#ff9f0a;
    }

    /* Only restyle the left sidebar/panel */
    #panel{
      background: var(--ios-bg);
      /* Default to dark text for light surfaces inside the panel */
      color: var(--ios-text);
      border-right: 1px solid var(--ios-border);
    }

    /* Cards + surfaces */
    #panel .card{
      background: rgba(17,24,39,.92);
      border: 1px solid var(--border);
      box-shadow: 0 10px 28px rgba(0,0,0,0.06);
      /* Cards in the panel are dark in this theme, so force light text */
      color: var(--text);
    }
    #panel .kpi{
      background: var(--ios-card2);
      border: 1px solid var(--border);
      /* KPI tiles are light, so force dark text */
      color: var(--ios-text);
    }
    #panel .kpi .big{ color: var(--ios-text); }
    #panel .item{
      background: var(--ios-card2);
      border: 1px solid var(--border);
      /* Result items are light, so force dark text */
      color: var(--ios-text);
    }
    #panel .item .title{ color: var(--ios-text); }
    #panel .item:hover{ background: #ededf3; }

    /* Text */
    #panel label,
    #panel .hint,
    #panel .status,
    #panel .kpi .small,
    #panel .item .meta,
    #panel .layer-hint{
      color: var(--ios-muted);
    }
    #panel a{ color: var(--ios-accent); }
    #panel a:hover{ text-decoration: underline; }

    /* Inputs */
    #panel input,
    #panel select{
      background: rgba(17,24,39,.92);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.5);
    }
    #panel input::placeholder{ color: rgba(110,110,115,0.75); }

    /* Override the global "dark dropdowns" so selects inside the panel are light */
    #panel select,
    #panel option{
      background: rgba(17,24,39,.92) !important;
      color: var(--text) !important;
    }
    #panel select:hover{ border-color: var(--ios-border); }
    #panel select:focus,
    #panel input:focus{
      border-color: rgba(0,122,255,0.55);
      box-shadow: 0 0 0 4px rgba(0,122,255,0.15);
    }

    /* Pills */
    #panel .pill{
      color: var(--ios-muted);
      border: 1px solid var(--border);
      background: rgba(60,60,67,0.06);
    }

    /* Status dots */
    #panel .dot.ok{ background: var(--ios-ok); }
    #panel .dot.warn{ background: var(--ios-warn); }
    #panel .dot.bad{ background: var(--ios-danger); }

    /* Progress */
    #panel .progress{
      background: rgba(60,60,67,0.10);
      border: 1px solid var(--border);
    }
    #panel .progress > div{
      background: linear-gradient(90deg, var(--ios-accent), #5ac8fa);
    }

    /* Slider (noUiSlider) ‚Äì keep it slim, make it iOS-y */
    #panel #yearSlider .noUi-target{
      background: rgba(60,60,67,0.12);
    }
    #panel #yearSlider .noUi-connect{
      background: var(--ios-accent);
    }
    #panel #yearSlider .noUi-handle{
      background: rgba(17,24,39,.92);
      border: 2px solid rgba(0,122,255,0.35);
      box-shadow: 0 10px 26px rgba(0,0,0,0.14);
    }

    /* iOS-style toggles ‚Äì match the light panel */
    #panel .slider{
      background: rgba(60,60,67,0.16);
      border: 1px solid var(--border);
    }
    #panel .slider:before{
      background: #ffffff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.18);
    }
    #panel .switch input:checked + .slider{
      background: rgba(0,122,255,0.85);
      border-color: rgba(0,122,255,0.45);
    }

    /* Header inside cards ‚Äì slightly crisper */
    #panel .card > div[style*="font-weight:700"],
    #panel .card > div[style*="font-weight:650"],
    #panel .card > div[style*="font-weight:800"]{
      color: var(--text);
    }


    /* Mobile drawer (collapsible left panel) */
    #panelToggle{display:none}
    #panelOverlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      z-index:19;
    }

    /* Small edge tab to open/close the drawer on mobile */
    #panelTab{display:none}
    body.panel-open #panelOverlay{display:block}
    @media (max-width: 960px){
      header{display:none}
      .wrap{height:100vh}
      #panelToggle{display:none}
      .wrap{grid-template-columns:1fr}
      #panelTab{
        display:flex;
        position:fixed;
        left:0;
        top:50%;
        transform:translateY(-50%);
        width:34px;
        height:56px;
        align-items:center;
        justify-content:center;
        border:1px solid var(--border);
        background:rgba(17,24,39,.92);
        color:var(--text);
        font-size:20px;
        line-height:1;
        padding:0;
        z-index:21;
        border-radius:0 14px 14px 0;
        box-shadow: 0 10px 28px rgba(0,0,0,0.12);
        cursor:pointer;
        transition:left .25s ease, transform .25s ease;
        user-select:none;
        -webkit-tap-highlight-color: transparent;
      }
      #panelTab:active{ transform:translateY(-50%) scale(0.98); }
      #panel{
        position:fixed;
        background: rgba(17,24,39,.96);
        left:0;
        top:0;
        width:min(360px, 88vw);
        height:100vh;
        transform:translateX(-110%);
        transition:transform .25s ease;
        z-index:20;
        box-shadow: 12px 0 30px rgba(0,0,0,.35);
      }
      body.panel-open #panel{transform:translateX(0)}
    }

/* Read more button (highlighted cases) */
.leaflet-popup-content .readmore-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 6px 10px;
  margin-left: 8px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 800;
  text-decoration: none;
  color: #1d4ed8;
  background: rgba(59,130,246,.10);
  border: 1px solid rgba(59,130,246,.28);
  white-space: nowrap;
}
.leaflet-popup-content .readmore-btn:hover{
  background: rgba(59,130,246,.16);
}
.leaflet-popup-content .summary{
  margin-top: 10px;
}


/* --- Help tooltip for Heatmap toggle --- */
.help-wrap{
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.help-icon{
  width: 18px;
  height: 18px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  line-height: 1;
  font-size: 12px;
  font-weight: 900;
  cursor: pointer;
  user-select: none;
  border: 1px solid rgba(0,122,255,0.35);
  background: rgba(0,122,255,0.12);
  color: var(--ios-accent);
}
.help-icon:hover{ background: rgba(0,122,255,0.18); }
.help-icon:focus{
  outline: none;
  box-shadow: 0 0 0 4px rgba(0,122,255,0.18);
}
.help-bubble{
  position: absolute;
  left: 0;
  top: calc(100% + 10px);
  width: min(320px, 72vw);
  padding: 10px 12px;
  border-radius: 12px;
  background: #ffffff;
  color: #111827;
  border: 1px solid rgba(17,24,39,0.14);
  box-shadow: 0 16px 40px rgba(0,0,0,0.18);
  font-size: 12px;
  line-height: 1.35;
  z-index: 5;
  display: none;
}
.help-bubble::before{
  content: "";
  position: absolute;
  top: -6px;
  left: 34px;
  width: 12px;
  height: 12px;
  background: #ffffff;
  border-left: 1px solid rgba(17,24,39,0.14);
  border-top: 1px solid rgba(17,24,39,0.14);
  transform: rotate(45deg);
}
.help-bubble.is-open{ display: block; }

</style>
</head>

<body>
<header>
  <div class="left">
    <h1>UK UFO / ‚ÄúAlien‚Äù Sightings (Curated)</h1>
    <p>Data source: <strong>GOV.UK where possible</strong>. Sources are provided per case.</p>
  </div>
  <div class="right">
    <button class="btn" id="panelToggle" aria-controls="panel" aria-expanded="false">Filters</button>
    <button class="btn" id="fitBtn">Fit to markers</button>
    <button class="btn" id="resetBtn">Reset filters</button>
  </div>
</header>

<div id="panelOverlay" hidden></div>

<button id="panelTab" class="panel-tab" aria-controls="panel" aria-expanded="false" aria-label="Show filters">‚Ä∫</button>

<div class="wrap">
  <aside id="panel">
    <div class="card">
      <div class="kpis">
        <div class="kpi">
          <div class="big" id="kpiTotal">‚Äî</div>
          <div class="small">Records loaded</div>
        </div>
        <div class="kpi">
          <div class="big" id="kpiShown">‚Äî</div>
          <div class="small">Matching filters</div>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="status">
        <span class="dot warn" id="statusDot"></span>
        <span id="statusText">Loading cases‚Ä¶</span>
      </div>
      <div style="height:10px"></div>
      <div class="progress" title="Load progress">
        <div id="progBar"></div>
      </div>
      <div style="height:10px"></div>
      <div class="hint">
        This website indexes every MoD / GOV UFO report from 1997 until the MoD closed its dedicated UFO desk in 2009. Other cases are also listed with varying levels of evidence and reputability. Use the filters below to fine tune your search.
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label for="search">Search</label>
          <input id="search" placeholder="e.g., Rendlesham, Warwick, triangle‚Ä¶" />
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row">
        <div>
          <label for="region">Region</label>
          <select id="region">
            <option value="">All</option>
          </select>
        </div>
        <div>
          <label for="minCred">Min credibility</label>
          <select id="minCred">
            <option value="1" selected>1+</option>
            <option value="2">2+</option>
            <option value="3">3+</option>
            <option value="4">4+</option>
            <option value="5">5</option>
          </select>
        </div>
        <div>
          <label for="encounter">Encounter</label>
          <select id="encounter">
            <option value="">All</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>

<div style="height:12px"></div>
      <label>Year range</label>
      <div class="slider-wrap"><div id="yearSlider"></div></div>
      <div class="slider-meta"><span id="yearMin">‚Äî</span><span id="yearMax">‚Äî</span></div>
    </div>

    <div class="card" id="layersCard">
      <div style="font-weight:700;margin-bottom:6px">Map layers</div>

      <div class="toggle-row">
        <div>
          <div style="font-weight:650;font-size:13px">Airports</div>
          <div class="label">Show major UK airports</div>
        </div>
        <label class="switch" title="Toggle airports">
          <input type="checkbox" id="toggleAirports">
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-row">
        <div>
          <div style="font-weight:650;font-size:13px">Military bases</div>
          <div class="label">Show RAF/Army/Navy bases</div>
        </div>
        <label class="switch" title="Toggle military bases">
          <input type="checkbox" id="toggleBases">
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-row">
        <div>
          <div style="font-weight:650;font-size:13px">Flight paths</div>
          <div class="label">Show common passenger flight corridors (approx)</div>
        </div>
        <label class="switch" title="Toggle flight paths">
          <input type="checkbox" id="toggleFlightPaths">
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-row">
        <div>
          <div class="help-wrap">
  <div style="font-weight:650;font-size:13px">Heatmap</div>
  <button type="button" class="help-icon" id="heatmapHelpBtn" aria-label="Heatmap info" aria-expanded="false">?</button>
  <div class="help-bubble" id="heatmapHelpBubble" role="tooltip">
    Reports with generalised locations such as "London" may cause a cluster on the heatmap. Keep this in mind when viewing the data.
  </div>
</div>
          <div class="label">Show sightings as a heatmap (hides markers)</div>
        </div>
        <label class="switch" title="Toggle density heatmap">
          <input type="checkbox" id="toggleDensity">
          <span class="slider"></span>
        </label>
      </div>

      <div class="layer-hint">These layers are optional references and won‚Äôt affect your sightings filters.</div>
    </div>


    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:baseline">
        <div style="flex:1">
          <div style="font-weight:700;margin-bottom:6px">Highlights</div>
          <div class="hint" id="resultsHint">Tap an item to zoom and open its popup.</div>
        </div>
      </div>
      <div style="height:8px"></div>
      <div id="list"></div>
    </div>


    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">Make it more interesting (ideas)</div>
      <div class="hint">
        ‚Ä¢ Add a ‚Äúcase page‚Äù route (e.g. <span class="pill">/case/rendlesham</span>) with longer write‚Äëups and images.<br/>
        ‚Ä¢ Add ‚Äúwitness types‚Äù icons and a ‚Äúcase strength‚Äù score breakdown.<br/>
        ‚Ä¢ Add a timeline ‚Äúplay‚Äù mode that animates sightings by year.<br/>
        ‚Ä¢ Add an ‚Äúinvestigation view‚Äù showing MoD/National Archives file references and document thumbnails.
      </div>
    </div>
  </aside>

  <main>
    <div id="map"></div>
  </main>
</div>

<script>
(function(){
  // ==== CONFIG ====
  // Your published Google Sheets CSV URL (Publish to the web ‚Üí CSV):
  const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7sia344gHoW613Mc1jQSYR4w_rMv2CcDtc-v1eJrbggnWrdu0FpgRIMMtwCOXULgmoU7UEUHNK-Ib/pub?output=csv';

  const els = {
    statusDot: document.getElementById('statusDot'),
    statusText: document.getElementById('statusText'),
    progBar: document.getElementById('progBar'),
    kpiTotal: document.getElementById('kpiTotal'),
    kpiShown: document.getElementById('kpiShown'),
    region: document.getElementById('region'),
    minCred: document.getElementById('minCred'),
    search: document.getElementById('search'),
    list: document.getElementById('list'),
    fitBtn: document.getElementById('fitBtn'),
    resetBtn: document.getElementById('resetBtn'),
    yearSlider: document.getElementById('yearSlider'),
    yearMin: document.getElementById('yearMin'),
    yearMax: document.getElementById('yearMax'),
    encounter: document.getElementById('encounter'),
    toggleAirports: document.getElementById('toggleAirports'),
    toggleBases: document.getElementById('toggleBases'),
    toggleFlightPaths: document.getElementById('toggleFlightPaths'),
    toggleDensity: document.getElementById('toggleDensity')
  };
// Heatmap help tooltip
const heatmapHelpBtn = document.getElementById('heatmapHelpBtn');
const heatmapHelpBubble = document.getElementById('heatmapHelpBubble');

function setHeatmapHelpOpen(open){
  if(!heatmapHelpBtn || !heatmapHelpBubble) return;
  heatmapHelpBubble.classList.toggle('is-open', !!open);
  heatmapHelpBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
}

if(heatmapHelpBtn && heatmapHelpBubble){
  heatmapHelpBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    const isOpen = heatmapHelpBubble.classList.contains('is-open');
    setHeatmapHelpOpen(!isOpen);
  });

  heatmapHelpBubble.addEventListener('click', (e) => {
    // Allow selecting/copying text without closing
    e.stopPropagation();
  });

  document.addEventListener('click', () => setHeatmapHelpOpen(false));
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape') setHeatmapHelpOpen(false);
  });
}


  // Map
  const map = L.map('map', { zoomControl: true }).setView([54.5, -3.0], 6);
  // Pane for flight paths so lines sit above tiles/markers and stay visible
  map.createPane('flightPathsPane');
  map.getPane('flightPathsPane').style.zIndex = 450;
  map.getPane('flightPathsPane').style.pointerEvents = 'auto';
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    subdomains: 'abcd',
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
  }).addTo(map);

  // Mobile: collapsible filter panel (off-canvas drawer)
  const mqPanel = window.matchMedia('(max-width: 960px)');
  const panelToggleBtn = document.getElementById('panelToggle');
  const panelOverlay = document.getElementById('panelOverlay');
  const panelTabBtn = document.getElementById('panelTab');

  function setPanelOpen(isOpen){
    if(!mqPanel.matches){
      // Desktop: panel is always visible, no overlay
      document.body.classList.remove('panel-open');
      if(panelOverlay) panelOverlay.setAttribute('hidden','');
      if(panelToggleBtn) panelToggleBtn.setAttribute('aria-expanded','true');
      if(panelTabBtn){
        panelTabBtn.setAttribute('aria-expanded','true');
        panelTabBtn.style.left = '0px';
      }
      return;
    }

    if(isOpen){
      document.body.classList.add('panel-open');
      if(panelOverlay) panelOverlay.removeAttribute('hidden');
      if(panelToggleBtn) panelToggleBtn.setAttribute('aria-expanded','true');
      if(panelTabBtn){
        panelTabBtn.textContent = '‚Äπ';
        panelTabBtn.setAttribute('aria-expanded','true');
        panelTabBtn.setAttribute('aria-label','Hide filters');
        const w = document.getElementById('panel')?.getBoundingClientRect?.().width || 0;
        panelTabBtn.style.left = Math.max(0, Math.round(w - 1)) + 'px';
      }
    } else {
      document.body.classList.remove('panel-open');
      if(panelOverlay) panelOverlay.setAttribute('hidden','');
      if(panelToggleBtn) panelToggleBtn.setAttribute('aria-expanded','false');
      if(panelTabBtn){
        panelTabBtn.textContent = '‚Ä∫';
        panelTabBtn.setAttribute('aria-expanded','false');
        panelTabBtn.setAttribute('aria-label','Show filters');
        panelTabBtn.style.left = '0px';
      }
    }

    // Leaflet needs this after layout changes (drawer transition)
    window.setTimeout(() => {
      try { map.invalidateSize(); } catch (e) {}
    }, 280);
  }

  // Default: open on mobile so users can start filtering immediately; on desktop the panel is always visible
  setPanelOpen(mqPanel.matches);

  if(panelToggleBtn){
    panelToggleBtn.addEventListener('click', () => {
      const open = document.body.classList.contains('panel-open');
      setPanelOpen(!open);
    });
  }
  if(panelTabBtn){
    panelTabBtn.addEventListener('click', () => {
      const open = document.body.classList.contains('panel-open');
      setPanelOpen(!open);
    });
  }
  if(panelOverlay){
    panelOverlay.addEventListener('click', () => setPanelOpen(false));
  }
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape') setPanelOpen(false);
  });
  mqPanel.addEventListener('change', () => setPanelOpen(false));


  const cluster = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 50 });
  const heatLayer = (L.heatLayer ? L.heatLayer([], { radius: 18, blur: 22, maxZoom: 12, minOpacity: 0.25 }) : null);
  let lastShownLatLngs = [];

  function isDensityOn(){
    return !!(els.toggleDensity && els.toggleDensity.checked);
  }

  function applyDensityMode(){
    if(!heatLayer) return;
    const on = isDensityOn();
    if(on){
      if(map.hasLayer(cluster)) map.removeLayer(cluster);
      if(!map.hasLayer(heatLayer)) map.addLayer(heatLayer);
    } else {
      if(map.hasLayer(heatLayer)) map.removeLayer(heatLayer);
      if(!map.hasLayer(cluster)) map.addLayer(cluster);
    }
  }

  map.addLayer(cluster);

  // Optional reference layers
  // Optional reference layers (clustered so they don't overwhelm the map)
  const airportsLayer = L.markerClusterGroup({
    showCoverageOnHover: false,
    spiderfyOnMaxZoom: true,
    disableClusteringAtZoom: 9,
    maxClusterRadius: 50,
    iconCreateFunction: (cluster) => L.divIcon({
      html: `<div class="poi-cluster airports">${cluster.getChildCount()}</div>`,
      className: '',
      iconSize: [34,34]
    })
  });

  const basesLayer = L.markerClusterGroup({
    showCoverageOnHover: false,
    spiderfyOnMaxZoom: true,
    disableClusteringAtZoom: 9,
    maxClusterRadius: 55,
    iconCreateFunction: (cluster) => L.divIcon({
      html: `<div class="poi-cluster bases">${cluster.getChildCount()}</div>`,
      className: '',
      iconSize: [34,34]
    })
  });


  // Common flight paths (reference layer)
  // NOTE: This is intentionally "approx" and local so the map works without any external aviation API.
  // You can swap this to a real dataset later (e.g., your own precomputed GeoJSON).
  const FLIGHT_PATHS_GEOJSON = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"name":"LHR ‚ÜîÔ∏é EDI"},"geometry":{"type":"LineString","coordinates":[[-0.4543,51.47],[-3.3725,55.95]]}},{"type":"Feature","properties":{"name":"LHR ‚ÜîÔ∏é GLA"},"geometry":{"type":"LineString","coordinates":[[-0.4543,51.47],[-4.4331,55.8719]]}},{"type":"Feature","properties":{"name":"LHR ‚ÜîÔ∏é MAN"},"geometry":{"type":"LineString","coordinates":[[-0.4543,51.47],[-2.275,53.3537]]}},{"type":"Feature","properties":{"name":"LGW ‚ÜîÔ∏é EDI"},"geometry":{"type":"LineString","coordinates":[[-0.1821,51.1537],[-3.3725,55.95]]}},{"type":"Feature","properties":{"name":"MAN ‚ÜîÔ∏é BFS"},"geometry":{"type":"LineString","coordinates":[[-2.275,53.3537],[-6.2158,54.6575]]}},{"type":"Feature","properties":{"name":"BHX ‚ÜîÔ∏é BFS"},"geometry":{"type":"LineString","coordinates":[[-1.748,52.4539],[-6.2158,54.6575]]}},{"type":"Feature","properties":{"name":"BRS ‚ÜîÔ∏é EDI"},"geometry":{"type":"LineString","coordinates":[[-2.7191,51.3827],[-3.3725,55.95]]}},{"type":"Feature","properties":{"name":"STN ‚ÜîÔ∏é EDI"},"geometry":{"type":"LineString","coordinates":[[0.235,51.885],[-3.3725,55.95]]}},{"type":"Feature","properties":{"name":"LTN ‚ÜîÔ∏é GLA"},"geometry":{"type":"LineString","coordinates":[[-0.3683,51.8747],[-4.4331,55.8719]]}},{"type":"Feature","properties":{"name":"LCY ‚ÜîÔ∏é EDI"},"geometry":{"type":"LineString","coordinates":[[0.0553,51.5053],[-3.3725,55.95]]}},{"type":"Feature","properties":{"name":"LPL ‚ÜîÔ∏é BFS"},"geometry":{"type":"LineString","coordinates":[[-2.8497,53.3336],[-6.2158,54.6575]]}},{"type":"Feature","properties":{"name":"NCL ‚ÜîÔ∏é LHR"},"geometry":{"type":"LineString","coordinates":[[-1.6917,55.0375],[-0.4543,51.47]]}},{"type":"Feature","properties":{"name":"LBA ‚ÜîÔ∏é LHR"},"geometry":{"type":"LineString","coordinates":[[-1.6606,53.8659],[-0.4543,51.47]]}},{"type":"Feature","properties":{"name":"ABZ ‚ÜîÔ∏é LHR"},"geometry":{"type":"LineString","coordinates":[[-2.1978,57.2019],[-0.4543,51.47]]}},{"type":"Feature","properties":{"name":"CWL ‚ÜîÔ∏é MAN"},"geometry":{"type":"LineString","coordinates":[[-3.3433,51.3967],[-2.275,53.3537]]}},{"type":"Feature","properties":{"name":"MAN ‚ÜîÔ∏é EDI"},"geometry":{"type":"LineString","coordinates":[[-2.275,53.3537],[-3.3725,55.95]]}},{"type":"Feature","properties":{"name":"BHX ‚ÜîÔ∏é EDI"},"geometry":{"type":"LineString","coordinates":[[-1.748,52.4539],[-3.3725,55.95]]}},{"type":"Feature","properties":{"name":"LGW ‚ÜîÔ∏é GLA"},"geometry":{"type":"LineString","coordinates":[[-0.1821,51.1537],[-4.4331,55.8719]]}},{"type":"Feature","properties":{"name":"BRS ‚ÜîÔ∏é MAN"},"geometry":{"type":"LineString","coordinates":[[-2.7191,51.3827],[-2.275,53.3537]]}}]};
  // Style and render (as GeoJSON so it's easy to replace later)
  // Sleek "cased" flight paths: soft glow underlay + crisp top line
  const flightPathsGlow = L.geoJSON(FLIGHT_PATHS_GEOJSON, {
    pane: 'flightPathsPane',
    style: () => ({
      color: 'rgba(59, 130, 246, 0.22)',  // glow underlay
      weight: 6,
      opacity: 1,
      dashArray: '8 10',
      lineCap: 'round',
      lineJoin: 'round'
    }),
    interactive: false
  });

  const flightPathsLine = L.geoJSON(FLIGHT_PATHS_GEOJSON, {
    pane: 'flightPathsPane',
    style: () => ({
      color: 'rgba(59, 130, 246, 0.95)',   // crisp top
      weight: 2.2,
      opacity: 1,
      dashArray: '8 10',
      lineCap: 'round',
      lineJoin: 'round'
    }),
    onEachFeature: (feature, layer) => {
      const name = (feature && feature.properties && feature.properties.name) ? feature.properties.name : 'Flight path';
      layer.bindTooltip(name, { sticky: true, opacity: 0.9 });
    }
  });


  // Airports
// By default we keep a small fallback list so the map still works offline.
// If the page is served over HTTP/HTTPS, we'll try to load *all UK airports* from the OurAirports open dataset.
// Data source (CSV): https://ourairports.com/data/ (airports.csv)
const AIRPORTS_FALLBACK = [
  { name: "London Heathrow (LHR)", lat: 51.4700, lon: -0.4543 },
  { name: "London Gatwick (LGW)", lat: 51.1537, lon: -0.1821 },
  { name: "London Stansted (STN)", lat: 51.8850, lon: 0.2350 },
  { name: "London Luton (LTN)", lat: 51.8747, lon: -0.3683 },
  { name: "London City (LCY)", lat: 51.5053, lon: 0.0553 },
  { name: "Manchester (MAN)", lat: 53.3537, lon: -2.2750 },
  { name: "Birmingham (BHX)", lat: 52.4539, lon: -1.7480 },
  { name: "Bristol (BRS)", lat: 51.3827, lon: -2.7191 },
  { name: "Liverpool John Lennon (LPL)", lat: 53.3336, lon: -2.8497 },
  { name: "Newcastle (NCL)", lat: 55.0375, lon: -1.6917 },
  { name: "Leeds Bradford (LBA)", lat: 53.8659, lon: -1.6606 },
  { name: "Edinburgh (EDI)", lat: 55.9500, lon: -3.3725 },
  { name: "Glasgow (GLA)", lat: 55.8719, lon: -4.4331 },
  { name: "Aberdeen (ABZ)", lat: 57.2019, lon: -2.1978 },
  { name: "Belfast International (BFS)", lat: 54.6575, lon: -6.2158 },
  { name: "Cardiff (CWL)", lat: 51.3967, lon: -3.3433 }
];
let AIRPORTS = AIRPORTS_FALLBACK;

// Robust-enough CSV row parser (handles quotes/commas)
function parseCsvLine(line) {
  const out = [];
  let cur = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (ch === ',' && !inQuotes) {
      out.push(cur);
      cur = '';
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}

async function loadUKAirportsFromOurAirports() {
  // IMPORTANT: This will generally NOT work when opened as a local file (file://) due to browser CORS rules.
  // Serve the HTML via a simple local web server for best results.
  const url = "https://ourairports.com/data/airports.csv";
  const res = await fetch(url, { cache: "force-cache" });
  if (!res.ok) throw new Error("Failed to fetch airports.csv (" + res.status + ")");
  const text = await res.text();

  const lines = text.split(/\r?\n/).filter(Boolean);
  if (lines.length < 2) throw new Error("airports.csv is empty");

  const headers = parseCsvLine(lines[0]);
  const idx = (name) => headers.indexOf(name);

  const iType = idx("type");
  const iName = idx("name");
  const iLat  = idx("latitude_deg");
  const iLon  = idx("longitude_deg");
  const iIso  = idx("iso_country");
  const iIata = idx("iata_code");
  const iIdent = idx("ident");
  const iServ = idx("scheduled_service");

  const allowedTypes = new Set(["large_airport","medium_airport","small_airport"]);
  const out = [];

  for (let li = 1; li < lines.length; li++) {
    const row = parseCsvLine(lines[li]);
    if (row.length !== headers.length) continue;

    if (row[iIso] !== "GB") continue; // United Kingdom (ISO 3166-1 alpha-2)
    const t = row[iType];
    if (!allowedTypes.has(t)) continue;

    const lat = parseFloat(row[iLat]);
    const lon = parseFloat(row[iLon]);
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;

    const code = (row[iIata] || row[iIdent] || "").trim();
    const airportName = (row[iName] || "").trim();
    if (!airportName) continue;

    // Keep label short + consistent with your current style
    const label = code ? `${airportName} (${code})` : airportName;

    // Optional: prioritize airports with scheduled service, but still include the rest.
    // (OurAirports uses "yes"/"" here)
    const scheduled = (iServ >= 0 ? row[iServ] : "");

    out.push({ name: label, lat, lon, _type: t, _scheduled: scheduled });
  }

  // Sort: scheduled service first, then by size (large ‚Üí medium ‚Üí small), then name
  const rank = { large_airport: 0, medium_airport: 1, small_airport: 2 };
  out.sort((a,b) => {
    const as = (a._scheduled === "yes") ? 0 : 1;
    const bs = (b._scheduled === "yes") ? 0 : 1;
    if (as !== bs) return as - bs;
    const ar = rank[a._type] ?? 99;
    const br = rank[b._type] ?? 99;
    if (ar !== br) return ar - br;
    return a.name.localeCompare(b.name);
  });

  // Strip internal fields
  return out.map(a => ({ name: a.name, lat: a.lat, lon: a.lon }));
}

async function loadUKAirportsAndRebuild() {
  try {
    const list = await loadUKAirportsFromOurAirports();
    if (Array.isArray(list) && list.length) {
      AIRPORTS = list;
    }
  } catch (e) {
    // Silent fallback ‚Äî the map still works with the curated list.
    console.warn("[airports] Using fallback list:", e);
    AIRPORTS = AIRPORTS_FALLBACK;
  }
  buildPoiLayers();
}

  const BASES = [
    { name: "RAF Brize Norton", lat: 51.7500, lon: -1.5830 },
    { name: "RAF Fairford", lat: 51.6820, lon: -1.7900 },
    { name: "RAF Lakenheath", lat: 52.4090, lon: 0.5610 },
    { name: "RAF Mildenhall", lat: 52.3610, lon: 0.4860 },
    { name: "RAF Coningsby", lat: 53.0930, lon: -0.1660 },
    { name: "RAF Marham", lat: 52.6500, lon: 0.5500 },
    { name: "RAF Lossiemouth", lat: 57.7050, lon: -3.3390 },
    { name: "RAF Leeming", lat: 54.2950, lon: -1.5330 },
    { name: "RAF Valley (Anglesey)", lat: 53.2520, lon: -4.5350 },
    { name: "RAF Shawbury", lat: 52.7980, lon: -2.6680 },
    { name: "RAF Waddington", lat: 53.1670, lon: -0.5240 },
    { name: "Army: Salisbury Plain Training Area", lat: 51.2000, lon: -1.8000 },
    { name: "HMNB Portsmouth", lat: 50.8010, lon: -1.1100 },
    { name: "HMNB Clyde (Faslane)", lat: 56.0520, lon: -4.8250 },
    { name: "Cawdor Barracks (Brawdy, Pembrokeshire)", lat: 51.8770, lon: -5.1230 },
    { name: "MOD St Athan", lat: 51.4040, lon: -3.4350 }
  ];

  function makePoiIcon(emoji, kind){
    const cls = kind === 'airport' ? 'poi-icon poi-airport' : 'poi-icon poi-base';
    return L.divIcon({
      className: '',
      html: `<div class="${cls}">${emoji}</div>`,
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });
  }

  const airportIcon = makePoiIcon("‚úàÔ∏è", "airport");
  const baseIcon = makePoiIcon("üõ°Ô∏è", "base");

  function buildPoiLayers(){
    airportsLayer.clearLayers();
    basesLayer.clearLayers();

    const esc = (str) => String(str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));

    AIRPORTS.forEach(a => {
      const mk = L.marker([a.lat, a.lon], { icon: airportIcon, title: a.name })
        .bindPopup(`<div class="poi-popup-wrap"><div class="poi-popup-title">${esc(a.name)}</div><div class="poi-popup-sub">Airport</div><div class="poi-popup-meta">Lat ${Number(a.lat).toFixed(4)}, Lon ${Number(a.lon).toFixed(4)}</div><div class="poi-popup-actions"><a class="poi-popup-btn" href="https://www.google.com/maps?q=${encodeURIComponent(a.lat + ',' + a.lon)}" target="_blank" rel="noopener">Open in Google Maps</a></div></div>`, { className: 'poi-popup', closeButton: true, autoPanPadding: [18,18], maxWidth: 260 })
        .bindTooltip(esc(a.name), { className: 'poi-tip', direction: 'top', offset: [0, -10], opacity: 0.95 });
      airportsLayer.addLayer(mk);
    });

    BASES.forEach(b => {
      const mk = L.marker([b.lat, b.lon], { icon: baseIcon, title: b.name })
        .bindPopup(`<div class="poi-popup-wrap"><div class="poi-popup-title">${esc(b.name)}</div><div class="poi-popup-sub">Military base</div><div class="poi-popup-meta">Lat ${Number(b.lat).toFixed(4)}, Lon ${Number(b.lon).toFixed(4)}</div><div class="poi-popup-actions"><a class="poi-popup-btn" href="https://www.google.com/maps?q=${encodeURIComponent(b.lat + ',' + b.lon)}" target="_blank" rel="noopener">Open in Google Maps</a></div></div>`, { className: 'poi-popup', closeButton: true, autoPanPadding: [18,18], maxWidth: 260 })
        .bindTooltip(esc(b.name), { className: 'poi-tip', direction: 'top', offset: [0, -10], opacity: 0.95 });
      basesLayer.addLayer(mk);
    });
  }

  buildPoiLayers();

  loadUKAirportsAndRebuild();

  // Fix occasional "map misalignment" (Leaflet needs a resize invalidate after layout settles)
  function fixMapSizeSoon(){
    setTimeout(() => { try { map.invalidateSize(true); } catch(e){} }, 50);
    setTimeout(() => { try { map.invalidateSize(true); } catch(e){} }, 300);
    setTimeout(() => { try { map.invalidateSize(true); } catch(e){} }, 900);
  }
  window.addEventListener('resize', () => fixMapSizeSoon());


  // State
  let records = [];
  let markersById = new Map();
  let currentYearMin = 1900, currentYearMax = 2100;

  // UK-ish bounds (used to detect swapped coordinates / bad geocodes)
  const UK_SOFT_BOUNDS = { minLat: 45.0, maxLat: 65.0, minLon: -12.0, maxLon: 6.0 };

  function isWithinBounds(lat, lon, b){
    return Number.isFinite(lat) && Number.isFinite(lon) &&
           lat >= b.minLat && lat <= b.maxLat && lon >= b.minLon && lon <= b.maxLon;
  }

  // If a row has lat/lon swapped (common), detect and fix it.
  function normaliseCoords(lat, lon){
    const la = Number(lat), lo = Number(lon);
    if(!Number.isFinite(la) || !Number.isFinite(lo)) return { lat: la, lon: lo, fixed: false };

    // Correct if it looks swapped: lat is UK-ish longitude range and lon is UK-ish latitude range
    if(la >= UK_SOFT_BOUNDS.minLon && la <= UK_SOFT_BOUNDS.maxLon &&
       lo >= UK_SOFT_BOUNDS.minLat && lo <= UK_SOFT_BOUNDS.maxLat){
      return { lat: lo, lon: la, fixed: true };
    }
    return { lat: la, lon: lo, fixed: false };
  }

  function setStatus(type, text){
    els.statusDot.classList.remove('ok','warn','bad');
    els.statusDot.classList.add(type);
    els.statusText.textContent = text;
  }
  function setProgress(done, total){
    const pct = total ? Math.round((done/total)*100) : 0;
    els.progBar.style.width = pct + '%';
  }

  function safeYear(dateStr){
    if(!dateStr) return null;
    const m = String(dateStr).match(/\b(18\d{2}|19\d{2}|20\d{2})\b/);
    return m ? parseInt(m[1],10) : null;
  }

  function parseSources(src){
    if(!src) return [];
    return String(src).split(/[\n;]+/).map(s=>s.trim()).filter(Boolean);
  }

  function parseVideos(v){
    if(!v) return [];
    return String(v).split(/[\n;]+/).map(s=>s.trim()).filter(Boolean);
  }


  
  // Case-insensitive, trimmed header lookup (handles 'Weather ', 'weather summary', etc.)
  function getField(row, names){
    if(!row) return '';
    const keys = Object.keys(row);
    for(const n of names){
      const target = String(n).trim().toLowerCase();
      // direct
      for(const k of keys){
        if(String(k).trim().toLowerCase() === target){
          return row[k];
        }
      }
    }
    return '';
  }

function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"']/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[s]));
  }

  function isTruthyYes(v){
    const raw = String(v || '').trim().toLowerCase();
    // Accept values like: "yes", "yes (featured)", "y", "true", "1"
    if(['y','yes','true','1'].includes(raw)) return true;
    if(raw.startsWith('yes')) return true;
    if(raw.startsWith('y')) return true;
    if(raw.includes('yes')) return true;
    return false;
  }

    function makePopupHTML(r){
    const sources = parseSources(r.sources);
    const videos = parseVideos(r.videos);

    const sourcesBlock = sources.length
      ? `<div style="font-weight:800;margin-bottom:6px">Sources</div>
         ${sources.map((u,i) => {
            const label = `Source ${i+1}`;
            return `<div style="margin:4px 0">
                      <a href="${escapeHtml(u)}" target="_blank" rel="noopener">${label}</a>
                    </div>`;
          }).join('')}`
      : '';

    const videosBlock = videos.length
      ? `<div style="font-weight:800;margin-bottom:6px">Videos</div>
         ${videos.map((u,i) => {
            const label = `Video ${i+1}`;
            return `<div style="margin:4px 0">
                      <a href="${escapeHtml(u)}" target="_blank" rel="noopener">${label}</a>
                    </div>`;
          }).join('')}`
      : '';

    const isFeatured = isTruthyYes(r.highlight);

    // Prefer a provided "slug" column; otherwise derive from the case title.
    function slugify(v){
      return String(v || '')
        .trim()
        .toLowerCase()
        .replace(/['"]/g,'')
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/^-+|-+$/g,'');
    }
    // Prefer a provided "slug" column; otherwise derive from the case title.
    // You can override specific cases via the alias map below.
    const aliasSlugs = {
      'rendlesham forest incident': 'rendlesham'
    };
    const baseTitle = (r.case || '').toString().trim().toLowerCase();
    const slug = (r.slug && String(r.slug).trim())
      ? String(r.slug).trim().toLowerCase()
      : (aliasSlugs[baseTitle] || slugify(r.case || 'case'));
    const readMoreHref = `case/${encodeURIComponent(slug)}/`;
    const readMoreTag = isFeatured ? ` <a class="tag tag-readmore" href="${readMoreHref}">Read more</a>` : '';

    let linksHtml = '';
    if(sources.length || videos.length){
      if(sources.length && videos.length){
        linksHtml = `<div class="divider"></div>
          <div style="display:flex;gap:14px;align-items:flex-start">
            <div style="flex:1;min-width:0">${sourcesBlock}</div>
            <div style="flex:1;min-width:0">${videosBlock}</div>
          </div>`;
      }else if(sources.length){
        linksHtml = `<div class="divider"></div>${sourcesBlock}`;
      }else{
        linksHtml = `<div class="divider"></div>${videosBlock}`;
      }
    }

    const tags = `
      <div class="tags">
        <span class="tag">${escapeHtml(r.region || '‚Äî')}</span>
        <span class="tag">Credibility: ${escapeHtml(String(r.cred || '‚Äî'))}</span>
        ${r.status ? `<span class="tag">${escapeHtml(r.status)}</span>` : ''}
        ${(() => {
          const raw = String(r.encounter || '').trim().toLowerCase();
          const isYes = ['yes','y','true','1'].includes(raw);
          const enc = raw ? (isYes ? 'Yes' : 'No') : 'No';
          return `<span class="tag">Encounter: ${enc}</span>`;
        })()}
      ${readMoreTag}
      </div>`;

    const weatherBlock = (r.weather && String(r.weather).trim())
      ? `<div style="margin:10px 0 12px;padding:10px 12px;border:1px solid rgba(0,0,0,.08);border-radius:14px;background:#f9fafb">
           <div style="font-weight:800;margin-bottom:6px">Weather</div>
           <div style="font-size:13px;line-height:1.35">${escapeHtml(r.weather)}</div>
           ${r.weather_source ? `<div style="font-size:11px;color:#6b7280;margin-top:6px">Source: ${escapeHtml(r.weather_source)}</div>` : ''}
         </div>`
      : '';

    return `
      <div class="popup-inner">
        <h3>${escapeHtml(r.case)}</h3>
        <p class="popup-date">${escapeHtml(r.date || '')}${r.time ? ` ‚Ä¢ ${escapeHtml(r.time)}` : ''}</p>
        ${tags}
        ${weatherBlock}
        <div style="font-size:13px;line-height:1.45">
          <div><span class="k">Location:</span> ${escapeHtml(r.location || '‚Äî')}</div>
          <div style="margin-top:8px"><span class="k">Witness:</span> ${escapeHtml(r.witness || '‚Äî')}</div>
          <div style="margin-top:8px"><span class="k">Evidence:</span> ${escapeHtml(r.evidence || '‚Äî')}</div>
          ${r.summary ? `<div class="summary">${escapeHtml(r.summary)}</div>` : ''}
          ${r.why ? `<div style="margin-top:10px;color:#6b7280">${escapeHtml(r.why)}</div>` : ''}
          ${linksHtml}
        </div>
      </div>
    `;
  }

  function markerColorByCred(cred){
    const c = Number(cred || 0);
    if(c >= 4) return '#22c55e';
    if(c >= 3) return '#60a5fa';
    return '#f59e0b';
  }

  function makeCircleMarker(lat, lon, cred){
    const color = markerColorByCred(cred);
    return L.circleMarker([lat, lon], {
      radius: 7,
      weight: 2,
      color: color,
      fillColor: color,
      fillOpacity: 0.25
    });
  }

  function clearMarkers(){
    cluster.clearLayers();
    markersById.clear();
    if(heatLayer) heatLayer.setLatLngs([]);
  }

  function matchesFilters(r){
    const q = els.search.value.trim().toLowerCase();
    const reg = els.region.value;
    const minCred = parseInt(els.minCred.value, 10);
    const y = r.year || 0;
    const enc = (els.encounter && els.encounter.value) ? els.encounter.value : '';

    if(q){
      const hay = [r.case,r.location,r.region,r.summary,r.witness,r.evidence,r.status,r.weather].join(' ').toLowerCase();
      if(!hay.includes(q)) return false;
    }
    if(reg && (r.region || '') !== reg) return false;
    if((r.cred || 0) < minCred) return false;
    if(y && (y < currentYearMin || y > currentYearMax)) return false;

    if(enc){
      const raw = String(r.encounter || '').trim().toLowerCase();
      const isYes = ['yes','y','true','1'].includes(raw);
      const rowEnc = raw ? (isYes ? 'yes' : 'no') : 'no';
      if(rowEnc !== enc) return false;
    }

    return true;
  }

  function render(){
    clearMarkers();
    els.list.innerHTML = '';

    const shown = records.filter(matchesFilters);
    els.kpiShown.textContent = shown.length;

    for(const r of shown){
      if(!Number.isFinite(r.lat) || !Number.isFinite(r.lon)) continue;

      if(isDensityOn()){
        // Weight: credibility (1..5) mapped to 0.6..1.2 so higher-cred cases glow a bit more
        const w = Math.max(0.6, Math.min(1.2, (Number(r.cred || 1) / 5) * 1.2));
        // Leaflet.heat accepts [lat, lng, intensity]
        heatLayer && heatLayer.addLatLng([r.lat, r.lon, w]);
      } else {
        const m = makeCircleMarker(r.lat, r.lon, r.cred);
        m.bindPopup(makePopupHTML(r), { maxWidth: 420 });
        m.on('click', () => highlightListItem(r.id));
        cluster.addLayer(m);
        markersById.set(r.id, m);
      }
    }

    lastShownLatLngs = shown.filter(r => Number.isFinite(r.lat) && Number.isFinite(r.lon)).map(r => [r.lat, r.lon]);
    applyDensityMode();

    const featured = shown.filter(r => isTruthyYes(r.highlight));

    // List: show highlighted cases only (featured)
    for(const r of featured.slice(0, 1000)){
      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.id = r.id;
      div.innerHTML = `
        <p class="title">${escapeHtml(r.case)}</p>
        <p class="meta">${escapeHtml(r.location)} ‚Ä¢ ${escapeHtml(r.date || '')}</p>
        ${r.weather ? `<p class="meta" style="margin-top:6px; color:#6b7280">Weather: ${escapeHtml(r.weather).slice(0, 90)}${(String(r.weather).length>90?'‚Ä¶':'')}</p>` : ''}
        <div style="margin-top:8px">
          <span class="pill">${escapeHtml(r.region || '‚Äî')}</span>
          <span class="pill">Cred: ${escapeHtml(String(r.cred || '‚Äî'))}</span>
          <span class="pill">${escapeHtml(r.status || '‚Äî')}</span>
        </div>
      `;
      div.addEventListener('click', () => {
        const mk = markersById.get(r.id);
        if(mk){
          const targetZoom = Math.max(map.getZoom(), 12);
          // If marker clustering is enabled, ensure the marker is visible before opening its popup
          if (cluster && typeof cluster.zoomToShowLayer === 'function') {
            cluster.zoomToShowLayer(mk, () => {
              map.flyTo(mk.getLatLng(), targetZoom, { animate: true, duration: 0.6 });
              mk.openPopup();
              highlightListItem(r.id);
            });
          } else {
            map.flyTo(mk.getLatLng(), targetZoom, { animate: true, duration: 0.6 });
            mk.openPopup();
            highlightListItem(r.id);
          }
        }
      });
      els.list.appendChild(div);
    }

    if(shown.length === 0){
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.textContent = 'No results match your filters.';
      els.list.appendChild(empty);
    } else if(featured.length === 0){
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.textContent = 'No highlighted cases in the current selection.';
      els.list.appendChild(empty);
    }
  }

function highlightListItem(id){
  const el = els.list.querySelector(`.item[data-id="${id}"]`);
  if(!el) return;

  // Scroll ONLY inside the results container (prevents page jumping)
  const container = els.list; // this is the scrollable area
  const top = el.offsetTop - (container.clientHeight / 2) + (el.clientHeight / 2);

  container.scrollTo({
    top: Math.max(0, top),
    behavior: 'smooth'
  });
}


  function fitToMarkers(){
    const density = isDensityOn();
    const layers = density ? [] : cluster.getLayers();
    const llArr = density ? lastShownLatLngs : null;

    if(density){
      if(!llArr || !llArr.length) return;
    } else {
      if(!layers.length) return;
    }

    // If a few outliers are far outside the UK, they can blow up bounds and trigger a false warning.
    // So we fit to UK-ish points first, and only warn if most markers look non-UK.
    const within = [];
    let outsideCount = 0;

    for(const lyr of (isDensityOn() ? lastShownLatLngs.map(ll => ({getLatLng:()=>({lat:ll[0],lng:ll[1]})})) : layers)){
      if(!lyr || !lyr.getLatLng) continue;
      const ll = lyr.getLatLng();
      if(isWithinBounds(ll.lat, ll.lng, UK_SOFT_BOUNDS)){
        within.push(lyr);
      } else {
        outsideCount += 1;
      }
    }

    const total = within.length + outsideCount;

    // Nothing usable to fit
    if(!within.length){
      setStatus('warn', 'Loaded data, but none of the plotted coordinates look UK-based. Check your lat/lon columns (or rely on Location geocoding).');
      map.setView([54.5, -3.0], 6);
      return;
    }

    // Warn only if a majority look outside the UK (swapped coords / wrong units / bad geocodes).
    if(total && (outsideCount / total) > 0.5){
      setStatus('warn', 'Data loaded, but many marker coordinates look outside the UK. Check your lat/lon columns (or rely on Location geocoding).');
    }

    const group = L.featureGroup(within);
    const b = group.getBounds();
    map.fitBounds(b.pad(0.2));
  }


  function initYearSlider(minY, maxY){
    currentYearMin = minY;
    currentYearMax = maxY;

    if(els.yearSlider.noUiSlider){
      els.yearSlider.noUiSlider.destroy();
    }
    noUiSlider.create(els.yearSlider, {
      start: [minY, maxY],
      connect: true,
      step: 1,
      range: { min: minY, max: maxY },
      format: { to: v => Math.round(v), from: v => parseInt(v,10) }
    });
    els.yearMin.textContent = minY;
    els.yearMax.textContent = maxY;

    els.yearSlider.noUiSlider.on('update', (values) => {
      currentYearMin = parseInt(values[0],10);
      currentYearMax = parseInt(values[1],10);
      els.yearMin.textContent = currentYearMin;
      els.yearMax.textContent = currentYearMax;
      render();
    });
  }

  function populateRegionOptions(){
    const set = new Set(records.map(r => r.region).filter(Boolean));
    const regions = Array.from(set).sort();
    els.region.innerHTML = '<option value="">All</option>' + regions.map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join('');
  }

  // Accept these coordinate headers:
  //  - lat/lon  (preferred)
  //  - Latitude/Longitude
  //  - Lat/Long  (your current sheet)
  function normaliseRow(r, idx){
    const latRaw = getField(r, ['lat','latitude','Lat','LAT']);
    const lonRaw = getField(r, ['lon','longitude','Long','LONG','lng','Lng']);

    const out = {
      id: idx,
      case: getField(r, ['Case','case']),
      date: getField(r, ['Date','date']),
      time: getField(r, ['Time','time']),
      date_iso: getField(r, ['Date_ISO','date_iso','Date ISO','Date (ISO)','ISO Date']),
      location: getField(r, ['Location','location']),
      region: getField(r, ['Region','region']),
      witness: getField(r, ['Witness profile','Witness','witness']),
      evidence: getField(r, ['Evidence','evidence']),
      summary: getField(r, ['Summary','summary']),
      status: getField(r, ['Status','status']),
      highlight: getField(r, ['Highlights','Highlight','highlights','highlight']),
      slug: getField(r, ['Slug','slug']),
      cred: Number(getField(r, ['Credibility (1-5)','Credibility','credibility']) || 0),
      why: getField(r, ['Why considered reputable','Why','why']),
      // Weather columns (support your new naming variations)
     weather: (() => {
  const w = String(getField(r, ['Weather','weather','Weather summary','Weather Summary','Historical weather','Historic weather','Weather (historic)','Weather (historical)']) || '').trim();
  // If it looks like a date/date-range, ignore it (prevents Date_ISO being shown as Weather)
  if (/^\d{4}-\d{2}(-\d{2})?(?:\s+to\s+\d{4}-\d{2}(-\d{2})?)?$/i.test(w)) return '';
  if (/^\d{1,2}\/\d{1,2}\/\d{4}(?:\s+to\s+\d{1,2}\/\d{1,2}\/\d{4})?$/i.test(w)) return '';
  return w;
})(),

      weather_source: getField(r, ['Weather source','weather source','Weather Source','Weather data source','Weather Data Source']),
      sources: getField(r, ['Sources','sources']),
      videos: getField(r, ['Videos','videos','Video','video','Video links','video links']),
      encounter: getField(r, ['Encounter','encounter']),
      year: safeYear(getField(r, ['Date_ISO','date_iso','Date','date'])),
      lat: Number(latRaw),
      lon: Number(lonRaw)
    };

    const fixed = normaliseCoords(out.lat, out.lon);
    out.lat = fixed.lat;
    out.lon = fixed.lon;

    return out;
  }

  // ==== Optional fallback geocoding (only if lat/lon missing) ====
  // Uses OpenStreetMap Nominatim. Please be considerate (rate-limited + cached).
  const GEO_CACHE_KEY = 'ufo_geo_cache_v1';
  const GEO_DELAY_MS = 1100; // ~1 req/sec
  const GEO_EMAIL = ''; // optional

  function loadGeoCache(){
    try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || '{}'); }
    catch { return {}; }
  }
  function saveGeoCache(cache){
    try { localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache)); } catch {}
  }
  function cacheKeyForLocation(loc){
    return String(loc || '').trim().toLowerCase();
  }
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  async function geocodeLocation(loc){
    const q = String(loc || '').trim();
    if(!q) return null;

    const params = new URLSearchParams({ format: 'json', q, limit: '1', addressdetails: '0' });
    if (GEO_EMAIL) params.set('email', GEO_EMAIL);

    const url = 'https://nominatim.openstreetmap.org/search?' + params.toString();
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if(!res.ok) throw new Error('Geocoding HTTP ' + res.status);
    const data = await res.json();
    if(!Array.isArray(data) || !data.length) return null;

    const hit = data[0];
    const lat = Number(hit.lat);
    const lon = Number(hit.lon);
    if(!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
    return { lat, lon };
  }

  async function geocodeMissingCoords(){
    const cache = loadGeoCache();

    // Apply cache first
    for(const r of records){
      if(Number.isFinite(r.lat) && Number.isFinite(r.lon)) continue;
      const key = cacheKeyForLocation(r.location);
      if(key && cache[key]){
        r.lat = Number(cache[key].lat);
        r.lon = Number(cache[key].lon);
      }
    }

    const queue = records.filter(r => (!Number.isFinite(r.lat) || !Number.isFinite(r.lon)) && String(r.location || '').trim());
    if(!queue.length) return;

    setStatus('warn', `Geocoding ${queue.length} location(s)‚Ä¶ (cached where possible)`);
    setProgress(0, queue.length);

    let done = 0;
    for(const r of queue){
      try{
        const key = cacheKeyForLocation(r.location);
        if(key && cache[key]){
          r.lat = Number(cache[key].lat);
          r.lon = Number(cache[key].lon);
        } else {
          const got = await geocodeLocation(r.location);
          if(got){
            r.lat = got.lat;
            r.lon = got.lon;
            if(key) cache[key] = got;
            saveGeoCache(cache);
          }
          await sleep(GEO_DELAY_MS);
        }
      } catch(e){
        console.warn('Geocode failed for:', r.location, e);
        await sleep(GEO_DELAY_MS);
      } finally {
        done += 1;
        setProgress(done, queue.length);
        render();
      }
    }

    const stillMissing = records.filter(r => !Number.isFinite(r.lat) || !Number.isFinite(r.lon)).length;
    if(stillMissing){
      setStatus('warn', `Loaded ${records.length} rows. ${stillMissing} still missing lat/lon (won‚Äôt plot).`);
    } else {
      setStatus('ok', `Loaded ${records.length} rows. Ready.`);
    }
  }

  async function loadFromGoogleSheets(){
    setStatus('warn','Loading cases‚Ä¶');
    setProgress(0, 1);

    const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes('?') ? '&' : '?') + 't=' + Date.now();

    return new Promise((resolve, reject) => {
      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const raw = Array.isArray(results.data) ? results.data : [];
          records = raw.map((row, idx) => normaliseRow(row, idx)).filter(r => (r.case || r.location || r.summary));
          els.kpiTotal.textContent = records.length;

          const years = records.map(r => r.year).filter(Boolean);
          const minY = years.length ? Math.min(...years) : 1950;
          const maxY = years.length ? Math.max(...years) : new Date().getFullYear();
          initYearSlider(minY, maxY);

          populateRegionOptions();

          // Default progress fill
          setProgress(1, 1);

          const missingCoords = records.filter(r => !Number.isFinite(r.lat) || !Number.isFinite(r.lon)).length;
          if(missingCoords){
            setStatus('warn', `Loaded ${records.length} rows. ${missingCoords} missing lat/lon (won't plot) ‚Äî using Location geocoding as a fallback.`);
          } else {
            setStatus('ok', `Loaded ${records.length} rows. Ready.`);
          }

          render();
          fitToMarkers();
          fixMapSizeSoon();

          // Fallback: geocode rows missing lat/lon (rate-limited + cached)
          geocodeMissingCoords().finally(() => resolve());
        },
        error: (err) => reject(err)
      });
    });
  }

  ['input','change'].forEach(evt => {
    els.search.addEventListener(evt, () => render());
    els.region.addEventListener(evt, () => render());
    els.minCred.addEventListener(evt, () => render());
    if(els.encounter) els.encounter.addEventListener(evt, () => render());
  });

  els.fitBtn.addEventListener('click', () => { fitToMarkers(); fixMapSizeSoon(); });
  els.resetBtn.addEventListener('click', () => {
    els.search.value = '';
    els.region.value = '';
    els.minCred.value = '1';
    if(els.encounter) els.encounter.value = '';
    const slider = els.yearSlider.noUiSlider;
    if(slider){
      const r = slider.options.range;
      slider.set([r.min, r.max]);
    }
    render();
    fitToMarkers();
  });


  // Layer toggles (airports / bases)
  function syncLayerToggles(){
    if(els.toggleAirports){
      if(els.toggleAirports.checked){
        airportsLayer.addTo(map);
        updatePoiTooltipMode();
      } else {
        map.removeLayer(airportsLayer);
      }
    }
    if(els.toggleBases){
      if(els.toggleBases.checked){
        basesLayer.addTo(map);
        updatePoiTooltipMode();
      } else {
        map.removeLayer(basesLayer);
      }
    }
    if(els.toggleFlightPaths){
      if(els.toggleFlightPaths.checked){
        flightPathsGlow.addTo(map);
        flightPathsLine.addTo(map);
      } else {
        map.removeLayer(flightPathsGlow);
        map.removeLayer(flightPathsLine);
      }
    }
  }

  // Make POI labels "stick" only when zoomed in (reduces clutter when zoomed out)
  function updatePoiTooltipMode(){
    const z = map.getZoom();
    const permanent = z >= 10;
    const upd = (layer) => {
      if(!layer) return;
      layer.eachLayer(mk => {
        if(!mk || !mk.getTooltip) return;
        const tt = mk.getTooltip();
        if(!tt) return;
        // Leaflet tooltips don't support toggling permanent directly; rebind when mode changes.
        const name = (tt.getContent && tt.getContent()) ? tt.getContent() : '';
        mk.unbindTooltip();
        mk.bindTooltip(name, { className: 'poi-tip', direction: 'top', offset: [0, -10], opacity: 0.95, permanent });
      });
    };
    if(map.hasLayer(airportsLayer)) upd(airportsLayer);
    if(map.hasLayer(basesLayer)) upd(basesLayer);
  }
  map.on('zoomend', () => updatePoiTooltipMode());


  if(els.toggleAirports) els.toggleAirports.addEventListener('change', syncLayerToggles);
  if(els.toggleBases) els.toggleBases.addEventListener('change', syncLayerToggles);
  if(els.toggleFlightPaths) els.toggleFlightPaths.addEventListener('change', syncLayerToggles);
  if(els.toggleDensity) els.toggleDensity.addEventListener('change', () => { render(); });


  loadFromGoogleSheets().catch(err => {
    console.error(err);
    setStatus('bad', (err && err.message) ? err.message : String(err));
  });
})();
</script>

</body>
</html>