<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UK UFO / Alien Sightings Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<!-- PapaParse (CSV) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- noUiSlider -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

  <style>
    :root{
      --bg:#0b0f19;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:rgba(255,255,255,.08);
      --accent:#60a5fa;
      --danger:#ef4444;
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      position:sticky;top:0;z-index:10;
    }
    header .left{display:flex;flex-direction:column;gap:2px}
    header h1{font-size:16px;margin:0;letter-spacing:.2px}
    header p{font-size:12px;margin:0;color:var(--muted)}
    header .right{display:flex;gap:8px;align-items:center}
    .btn{
      appearance:none;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);
      padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px;
    }
    .btn:hover{background:rgba(255,255,255,.07)}
    .wrap{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 58px)}
    #panel{
      border-right:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      padding:14px;
      height:calc(100vh - 58px);
      overflow-y:auto;
      overflow-x:hidden;
      min-height:0;
      -webkit-overflow-scrolling:touch;
    }
    #map{height:100%;width:100%}
    .card{background:rgba(17,24,39,.7);border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select{
      width:100%;padding:9px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);color:var(--text);outline:none;
    }
    input::placeholder{color:#6b7280}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{border:1px solid var(--border);border-radius:14px;padding:10px;background:rgba(0,0,0,.18)}
    .kpi .big{font-size:18px;font-weight:700}
    .kpi .small{font-size:12px;color:var(--muted)}
    .status{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:#f59e0b}
    .dot.bad{background:var(--danger)}
    #list{max-height:48vh;overflow:auto;padding-right:4px}
    .item{padding:10px;border:1px solid var(--border);border-radius:14px;background:rgba(0,0,0,.18);margin-bottom:10px;cursor:pointer}
    .item:hover{background:rgba(0,0,0,.28)}
    .item .title{font-weight:650;font-size:13px;margin:0 0 4px 0}
    .item .meta{font-size:12px;color:var(--muted);margin:0}
    .pill{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);margin-right:6px}
    .slider-wrap{padding:6px 2px 2px}
    .slider-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:8px}
    .progress{
      height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid var(--border)
    }
    .progress > div{height:100%;width:0;background:linear-gradient(90deg, var(--accent), #a78bfa)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    .smallbtn{font-size:11px;padding:6px 8px;border-radius:10px}
	
	/* Leaflet popups: match the neon HUD theme */
.leaflet-popup-content-wrapper,
.leaflet-popup-tip{
  background: rgba(7, 12, 24, 0.92) !important;
  color: var(--text) !important;
  border: 1px solid rgba(96,165,250,0.45) !important;
  border-radius: 18px !important;
  box-shadow:
    0 20px 60px rgba(0,0,0,0.55),
    0 0 0 1px rgba(96,165,250,0.16),
    0 0 34px rgba(96,165,250,0.18) !important;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

/* Ensure popup text inherits our dark theme */
.leaflet-popup-content{
  color: var(--text) !important;
}
.leaflet-popup-content *{
  color: inherit !important;
}
.leaflet-popup-content a{
  color: #7dd3fc !important;
  text-decoration: none !important;
  word-break: break-word;
}
.leaflet-popup-content a:hover{
  text-decoration: underline !important;
}

.leaflet-popup-close-button{
  color: rgba(229,231,235,0.9) !important;
}
.leaflet-popup-close-button:hover{
  color: #ffffff !important;
}

html, body {
  height: 100%;
  margin: 0;
  overflow: hidden;
}
	
/* Slimmer year-range slider (noUiSlider) */
#yearSlider {
  margin-top: 10px;
  margin-bottom: 6px;
}

#yearSlider .noUi-target {
  border: none;
  box-shadow: none;
  height: 8px;              /* track height */
  border-radius: 999px;
}

#yearSlider .noUi-base,
#yearSlider .noUi-connects {
  height: 8px;
  border-radius: 999px;
}

#yearSlider .noUi-connect {
  border-radius: 999px;
}

#yearSlider .noUi-handle {
  width: 18px;              /* handle size */
  height: /* --- Leaflet popup layout (neon card) --- */
.leaflet-popup-content{
  margin: 0 !important;
  width: 360px !important;
  max-width: 360px !important;
  font-family: inherit;
}

.leaflet-popup-content .popup-inner{
  padding: 16px 16px 14px 16px;
  max-height: 70vh;
  overflow: auto;
}

.leaflet-popup-content h3{
  margin: 0 0 6px 0;
  font-size: 18px;
  line-height: 1.2;
  letter-spacing: -0.01em;
}

.leaflet-popup-content .popup-date{
  color: rgba(229,231,235,0.72);
  font-size: 13px;
  margin: 0 0 12px 0;
}

.leaflet-popup-content .k{ font-weight: 800; }

.leaflet-popup-content .divider{
  height: 1px;
  background: rgba(255,255,255,0.12);
  margin: 12px 0;
}

.leaflet-popup-content .tags{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin: 8px 0 10px;
}
.leaflet-popup-content .tag{
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 999px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  color: rgba(229,231,235,0.88);
}

.leaflet-popup-content a:hover{
  text-decoration: underline;
}

/* Little tag pills */
.leaflet-popup-content .tags{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin: 8px 0 10px;
}
.leaflet-popup-content .tag{
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 999px;
  background: rgba(0,0,0,0.05);
  border: 1px solid rgba(0,0,0,0.06);
  color: #111827;
}

/* --- Dark dropdowns (select + options) --- */
select, option {
  background: #0b1220;
  color: #e5e7eb;
}

select {
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 14px;
  padding: 10px 12px;
  outline: none;
  box-shadow: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

/* Custom arrow (so it still looks like a dropdown) */
.select-wrap {
  position: relative;
}
.select-wrap::after {
  content: "▾";
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: rgba(229,231,235,0.8);
  font-size: 14px;
}

/* Hover / focus */
select:hover {
  border-color: rgba(255,255,255,0.22);
}
select:focus {
  border-color: rgba(96,165,250,0.7);
  box-shadow: 0 0 0 4px rgba(96,165,250,0.12);
}

</style>
</head>

<body>
<header>
  <div class="left">
    <h1>UK UFO / “Alien” Sightings (Curated)</h1>
    <p>Data source: <strong>Google Sheets (published CSV)</strong> (edit the sheet, refresh the page).</p>
  </div>
  <div class="right">
    <button class="btn" id="fitBtn">Fit to markers</button>
    <button class="btn" id="resetBtn">Reset filters</button>
  </div>
</header>

<div class="wrap">
  <aside id="panel">
    <div class="card">
      <div class="kpis">
        <div class="kpi">
          <div class="big" id="kpiTotal">—</div>
          <div class="small">Records loaded</div>
        </div>
        <div class="kpi">
          <div class="big" id="kpiShown">—</div>
          <div class="small">Matching filters</div>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="status">
        <span class="dot warn" id="statusDot"></span>
        <span id="statusText">Loading spreadsheet…</span>
      </div>
      <div style="height:10px"></div>
      <div class="progress" title="Load progress">
        <div id="progBar"></div>
      </div>
      <div style="height:10px"></div>
      <div class="hint">
        Markers plot from <b>lat</b>/<b>lon</b> columns in your Google Sheet. If a row is missing coordinates, the site will try to geocode the <b>Location</b> and cache the result in your browser.
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label for="search">Search</label>
          <input id="search" placeholder="e.g., Rendlesham, Warwick, triangle…" />
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row">
        <div>
          <label for="region">Region</label>
          <select id="region">
            <option value="">All</option>
          </select>
        </div>
        <div>
          <label for="minCred">Min credibility</label>
          <select id="minCred">
            <option value="1">1+</option>
            <option value="2">2+</option>
            <option value="3" selected>3+</option>
            <option value="4">4+</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>

      <div style="height:12px"></div>
      <label>Year range</label>
      <div class="slider-wrap"><div id="yearSlider"></div></div>
      <div class="slider-meta"><span id="yearMin">—</span><span id="yearMax">—</span></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:baseline">
        <div style="flex:1">
          <div style="font-weight:700;margin-bottom:6px">Results</div>
          <div class="hint" id="resultsHint">Click an item to zoom and open its popup.</div>
        </div>
      </div>
      <div style="height:8px"></div>
      <div id="list"></div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">Make it more interesting (ideas)</div>
      <div class="hint">
        • Add a “case page” route (e.g. <span class="pill">/case/rendlesham</span>) with longer write‑ups and images.<br/>
        • Add “witness types” icons and a “case strength” score breakdown.<br/>
        • Add a timeline “play” mode that animates sightings by year.<br/>
        • Add an “investigation view” showing MoD/National Archives file references and document thumbnails.
      </div>
    </div>
  </aside>

  <main>
    <div id="map"></div>
  </main>
</div>

<script>
(function(){
  // ==== CONFIG ====
  // Your published Google Sheets CSV URL (Publish to the web → CSV):
  const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7sia344gHoW613Mc1jQSYR4w_rMv2CcDtc-v1eJrbggnWrdu0FpgRIMMtwCOXULgmoU7UEUHNK-Ib/pub?output=csv';

  const els = {
    statusDot: document.getElementById('statusDot'),
    statusText: document.getElementById('statusText'),
    progBar: document.getElementById('progBar'),
    kpiTotal: document.getElementById('kpiTotal'),
    kpiShown: document.getElementById('kpiShown'),
    region: document.getElementById('region'),
    minCred: document.getElementById('minCred'),
    search: document.getElementById('search'),
    list: document.getElementById('list'),
    fitBtn: document.getElementById('fitBtn'),
    resetBtn: document.getElementById('resetBtn'),
    yearSlider: document.getElementById('yearSlider'),
    yearMin: document.getElementById('yearMin'),
    yearMax: document.getElementById('yearMax')
  };

  // Map
  const map = L.map('map', { zoomControl: true }).setView([54.5, -3.0], 6);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    subdomains: 'abcd',
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
  }).addTo(map);

  const cluster = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 50 });
  map.addLayer(cluster);

  // Fix occasional "map misalignment" (Leaflet needs a resize invalidate after layout settles)
  function fixMapSizeSoon(){
    setTimeout(() => { try { map.invalidateSize(true); } catch(e){} }, 50);
    setTimeout(() => { try { map.invalidateSize(true); } catch(e){} }, 300);
    setTimeout(() => { try { map.invalidateSize(true); } catch(e){} }, 900);
  }
  window.addEventListener('resize', () => fixMapSizeSoon());


  // State
  let records = [];
  let markersById = new Map();
  let currentYearMin = 1900, currentYearMax = 2100;

  // UK-ish bounds (used to detect swapped coordinates / bad geocodes)
  const UK_SOFT_BOUNDS = { minLat: 45.0, maxLat: 65.0, minLon: -12.0, maxLon: 6.0 };

  function isWithinBounds(lat, lon, b){
    return Number.isFinite(lat) && Number.isFinite(lon) &&
           lat >= b.minLat && lat <= b.maxLat && lon >= b.minLon && lon <= b.maxLon;
  }

  // If a row has lat/lon swapped (common), detect and fix it.
  function normaliseCoords(lat, lon){
    const la = Number(lat), lo = Number(lon);
    if(!Number.isFinite(la) || !Number.isFinite(lo)) return { lat: la, lon: lo, fixed: false };

    // Correct if it looks swapped: lat is UK-ish longitude range and lon is UK-ish latitude range
    if(la >= UK_SOFT_BOUNDS.minLon && la <= UK_SOFT_BOUNDS.maxLon &&
       lo >= UK_SOFT_BOUNDS.minLat && lo <= UK_SOFT_BOUNDS.maxLat){
      return { lat: lo, lon: la, fixed: true };
    }
    return { lat: la, lon: lo, fixed: false };
  }

  function setStatus(type, text){
    els.statusDot.classList.remove('ok','warn','bad');
    els.statusDot.classList.add(type);
    els.statusText.textContent = text;
  }
  function setProgress(done, total){
    const pct = total ? Math.round((done/total)*100) : 0;
    els.progBar.style.width = pct + '%';
  }

  function safeYear(dateStr){
    if(!dateStr) return null;
    const m = String(dateStr).match(/\b(18\d{2}|19\d{2}|20\d{2})\b/);
    return m ? parseInt(m[1],10) : null;
  }

  function parseSources(src){
    if(!src) return [];
    return String(src).split(/[\n;]+/).map(s=>s.trim()).filter(Boolean);
  }

  
  // Case-insensitive, trimmed header lookup (handles 'Weather ', 'weather summary', etc.)
  function getField(row, names){
    if(!row) return '';
    const keys = Object.keys(row);
    for(const n of names){
      const target = String(n).trim().toLowerCase();
      // direct
      for(const k of keys){
        if(String(k).trim().toLowerCase() === target){
          return row[k];
        }
      }
    }
    return '';
  }

function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"']/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[s]));
  }

  function makePopupHTML(r){
    const sources = parseSources(r.sources);

    // Build sources list with short labels (Source 1, Source 2...) but keep real URLs
    const srcHtml = sources.length
      ? `<div class="divider"></div>
         <div style="font-weight:800;margin-bottom:6px">Sources</div>
         ${sources.map((u,i) => {
            const label = `Source ${i+1}`;
            return `<div style="margin:4px 0">
                      <a href="${escapeHtml(u)}" target="_blank" rel="noopener">${label}</a>
                    </div>`;
          }).join('')}`
      : '';

    const tags = `
      <div class="tags">
        <span class="tag">${escapeHtml(r.region || '—')}</span>
        <span class="tag">Credibility: ${escapeHtml(String(r.cred || '—'))}</span>
        ${r.status ? `<span class="tag">${escapeHtml(r.status)}</span>` : ''}
      </div>`;

    const weatherBlock = (r.weather && String(r.weather).trim())
      ? `<div style="margin:10px 0 12px;padding:10px 12px;border:1px solid rgba(255,255,255,0.12);border-radius:14px;background:rgba(255,255,255,0.04)">
           <div style="font-weight:800;margin-bottom:6px">Weather</div>
           <div style="font-size:13px;line-height:1.35">${escapeHtml(r.weather)}</div>
           ${r.weather_source ? `<div style="font-size:11px;color:rgba(229,231,235,0.68);margin-top:6px">Source: ${escapeHtml(r.weather_source)}</div>` : ''}
         </div>`
      : '';

    return `
      <div class="popup-inner">
        <h3>${escapeHtml(r.case)}</h3>
        <p class="popup-date">${escapeHtml(r.date || '')}${r.time ? ` • ${escapeHtml(r.time)}` : ''}</p>
        ${tags}
        ${weatherBlock}
        <div style="font-size:13px;line-height:1.45">
          <div><span class="k">Location:</span> ${escapeHtml(r.location || '—')}</div>
          <div style="margin-top:8px"><span class="k">Witness:</span> ${escapeHtml(r.witness || '—')}</div>
          <div style="margin-top:8px"><span class="k">Evidence:</span> ${escapeHtml(r.evidence || '—')}</div>
          ${r.summary ? `<div style="margin-top:10px">${escapeHtml(r.summary)}</div>` : ''}
          ${r.why ? `<div style="margin-top:10px;color:#6b7280">${escapeHtml(r.why)}</div>` : ''}
          ${srcHtml}
        </div>
      </div>
    `;
  }

  function markerColorByCred(cred){
    const c = Number(cred || 0);
    if(c >= 4) return '#22c55e';
    if(c >= 3) return '#60a5fa';
    return '#f59e0b';
  }

  function makeCircleMarker(lat, lon, cred){
    const color = markerColorByCred(cred);
    return L.circleMarker([lat, lon], {
      radius: 7,
      weight: 2,
      color: color,
      fillColor: color,
      fillOpacity: 0.25
    });
  }

  function clearMarkers(){
    cluster.clearLayers();
    markersById.clear();
  }

  function matchesFilters(r){
    const q = els.search.value.trim().toLowerCase();
    const reg = els.region.value;
    const minCred = parseInt(els.minCred.value, 10);
    const y = r.year || 0;

    if(q){
      const hay = [r.case,r.location,r.region,r.summary,r.witness,r.evidence,r.status,r.weather].join(' ').toLowerCase();
      if(!hay.includes(q)) return false;
    }
    if(reg && (r.region || '') !== reg) return false;
    if((r.cred || 0) < minCred) return false;
    if(y && (y < currentYearMin || y > currentYearMax)) return false;

    return true;
  }

  function render(){
    clearMarkers();
    els.list.innerHTML = '';

    const shown = records.filter(matchesFilters);
    els.kpiShown.textContent = shown.length;

    for(const r of shown){
      if(!Number.isFinite(r.lat) || !Number.isFinite(r.lon)) continue;
      const m = makeCircleMarker(r.lat, r.lon, r.cred);
      m.bindPopup(makePopupHTML(r), { maxWidth: 420 });
      m.on('click', () => highlightListItem(r.id));
      cluster.addLayer(m);
      markersById.set(r.id, m);
    }

    for(const r of shown.slice(0, 250)){
      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.id = r.id;
      div.innerHTML = `
        <p class="title">${escapeHtml(r.case)}</p>
        <p class="meta">${escapeHtml(r.location)} • ${escapeHtml(r.date || '')}</p>
        ${r.weather ? `<p class="meta" style="margin-top:6px; color:#6b7280">Weather: ${escapeHtml(r.weather).slice(0, 90)}${(String(r.weather).length>90?'…':'')}</p>` : ''}
        <div style="margin-top:8px">
          <span class="pill">${escapeHtml(r.region || '—')}</span>
          <span class="pill">Cred: ${escapeHtml(String(r.cred || '—'))}</span>
          <span class="pill">${escapeHtml(r.status || '—')}</span>
        </div>
      `;
      div.addEventListener('click', () => {
        const mk = markersById.get(r.id);
        if(mk){
          map.setView(mk.getLatLng(), Math.max(map.getZoom(), 9));
          mk.openPopup();
        }
      });
      els.list.appendChild(div);
    }

    if(shown.length === 0){
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.textContent = 'No results match your filters.';
      els.list.appendChild(empty);
    }
  }

function highlightListItem(id){
  const el = els.list.querySelector(`.item[data-id="${id}"]`);
  if(!el) return;

  // Scroll ONLY inside the results container (prevents page jumping)
  const container = els.list; // this is the scrollable area
  const top = el.offsetTop - (container.clientHeight / 2) + (el.clientHeight / 2);

  container.scrollTo({
    top: Math.max(0, top),
    behavior: 'smooth'
  });
}


  function fitToMarkers(){
    const layers = cluster.getLayers();
    if(!layers.length) return;
    const group = L.featureGroup(layers);
    const b = group.getBounds();
    const center = b.getCenter();

    if(!isWithinBounds(center.lat, center.lng, UK_SOFT_BOUNDS)){
      setStatus('warn', 'Data loaded, but marker coordinates look outside the UK. Check your lat/lon columns (or rely on Location geocoding).');
      map.setView([54.5, -3.0], 6);
      return;
    }
    map.fitBounds(b.pad(0.2));
  }

  function initYearSlider(minY, maxY){
    currentYearMin = minY;
    currentYearMax = maxY;

    if(els.yearSlider.noUiSlider){
      els.yearSlider.noUiSlider.destroy();
    }
    noUiSlider.create(els.yearSlider, {
      start: [minY, maxY],
      connect: true,
      step: 1,
      range: { min: minY, max: maxY },
      format: { to: v => Math.round(v), from: v => parseInt(v,10) }
    });
    els.yearMin.textContent = minY;
    els.yearMax.textContent = maxY;

    els.yearSlider.noUiSlider.on('update', (values) => {
      currentYearMin = parseInt(values[0],10);
      currentYearMax = parseInt(values[1],10);
      els.yearMin.textContent = currentYearMin;
      els.yearMax.textContent = currentYearMax;
      render();
    });
  }

  function populateRegionOptions(){
    const set = new Set(records.map(r => r.region).filter(Boolean));
    const regions = Array.from(set).sort();
    els.region.innerHTML = '<option value="">All</option>' + regions.map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join('');
  }

  // Accept these coordinate headers:
  //  - lat/lon  (preferred)
  //  - Latitude/Longitude
  //  - Lat/Long  (your current sheet)
  function normaliseRow(r, idx){
    const latRaw = getField(r, ['lat','latitude','Lat','LAT']);
    const lonRaw = getField(r, ['lon','longitude','Long','LONG','lng','Lng']);

    const out = {
      id: idx,
      case: getField(r, ['Case','case']),
      date: getField(r, ['Date','date']),
      time: getField(r, ['Time','time']),
      date_iso: getField(r, ['Date_ISO','date_iso','Date ISO','Date (ISO)','ISO Date']),
      location: getField(r, ['Location','location']),
      region: getField(r, ['Region','region']),
      witness: getField(r, ['Witness profile','Witness','witness']),
      evidence: getField(r, ['Evidence','evidence']),
      summary: getField(r, ['Summary','summary']),
      status: getField(r, ['Status','status']),
      cred: Number(getField(r, ['Credibility (1-5)','Credibility','credibility']) || 0),
      why: getField(r, ['Why considered reputable','Why','why']),
      // Weather columns (support your new naming variations)
     weather: (() => {
  const w = String(getField(r, ['Weather','weather','Weather summary','Weather Summary','Historical weather','Historic weather','Weather (historic)','Weather (historical)']) || '').trim();
  // If it looks like a date/date-range, ignore it (prevents Date_ISO being shown as Weather)
  if (/^\d{4}-\d{2}(-\d{2})?(?:\s+to\s+\d{4}-\d{2}(-\d{2})?)?$/i.test(w)) return '';
  if (/^\d{1,2}\/\d{1,2}\/\d{4}(?:\s+to\s+\d{1,2}\/\d{1,2}\/\d{4})?$/i.test(w)) return '';
  return w;
})(),

      weather_source: getField(r, ['Weather source','weather source','Weather Source','Weather data source','Weather Data Source']),
      sources: getField(r, ['Sources','sources']),
      year: safeYear(getField(r, ['Date_ISO','date_iso','Date','date'])),
      lat: Number(latRaw),
      lon: Number(lonRaw)
    };

    const fixed = normaliseCoords(out.lat, out.lon);
    out.lat = fixed.lat;
    out.lon = fixed.lon;

    return out;
  }

  // ==== Optional fallback geocoding (only if lat/lon missing) ====
  // Uses OpenStreetMap Nominatim. Please be considerate (rate-limited + cached).
  const GEO_CACHE_KEY = 'ufo_geo_cache_v1';
  const GEO_DELAY_MS = 1100; // ~1 req/sec
  const GEO_EMAIL = ''; // optional

  function loadGeoCache(){
    try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || '{}'); }
    catch { return {}; }
  }
  function saveGeoCache(cache){
    try { localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache)); } catch {}
  }
  function cacheKeyForLocation(loc){
    return String(loc || '').trim().toLowerCase();
  }
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  async function geocodeLocation(loc){
    const q = String(loc || '').trim();
    if(!q) return null;

    const params = new URLSearchParams({ format: 'json', q, limit: '1', addressdetails: '0' });
    if (GEO_EMAIL) params.set('email', GEO_EMAIL);

    const url = 'https://nominatim.openstreetmap.org/search?' + params.toString();
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if(!res.ok) throw new Error('Geocoding HTTP ' + res.status);
    const data = await res.json();
    if(!Array.isArray(data) || !data.length) return null;

    const hit = data[0];
    const lat = Number(hit.lat);
    const lon = Number(hit.lon);
    if(!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
    return { lat, lon };
  }

  async function geocodeMissingCoords(){
    const cache = loadGeoCache();

    // Apply cache first
    for(const r of records){
      if(Number.isFinite(r.lat) && Number.isFinite(r.lon)) continue;
      const key = cacheKeyForLocation(r.location);
      if(key && cache[key]){
        r.lat = Number(cache[key].lat);
        r.lon = Number(cache[key].lon);
      }
    }

    const queue = records.filter(r => (!Number.isFinite(r.lat) || !Number.isFinite(r.lon)) && String(r.location || '').trim());
    if(!queue.length) return;

    setStatus('warn', `Geocoding ${queue.length} location(s)… (cached where possible)`);
    setProgress(0, queue.length);

    let done = 0;
    for(const r of queue){
      try{
        const key = cacheKeyForLocation(r.location);
        if(key && cache[key]){
          r.lat = Number(cache[key].lat);
          r.lon = Number(cache[key].lon);
        } else {
          const got = await geocodeLocation(r.location);
          if(got){
            r.lat = got.lat;
            r.lon = got.lon;
            if(key) cache[key] = got;
            saveGeoCache(cache);
          }
          await sleep(GEO_DELAY_MS);
        }
      } catch(e){
        console.warn('Geocode failed for:', r.location, e);
        await sleep(GEO_DELAY_MS);
      } finally {
        done += 1;
        setProgress(done, queue.length);
        render();
      }
    }

    const stillMissing = records.filter(r => !Number.isFinite(r.lat) || !Number.isFinite(r.lon)).length;
    if(stillMissing){
      setStatus('warn', `Loaded ${records.length} rows. ${stillMissing} still missing lat/lon (won’t plot).`);
    } else {
      setStatus('ok', `Loaded ${records.length} rows. Ready.`);
    }
  }

  async function loadFromGoogleSheets(){
    setStatus('warn','Loading Google Sheet…');
    setProgress(0, 1);

    const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes('?') ? '&' : '?') + 't=' + Date.now();

    return new Promise((resolve, reject) => {
      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const raw = Array.isArray(results.data) ? results.data : [];
          records = raw.map((row, idx) => normaliseRow(row, idx)).filter(r => (r.case || r.location || r.summary));
          els.kpiTotal.textContent = records.length;

          const years = records.map(r => r.year).filter(Boolean);
          const minY = years.length ? Math.min(...years) : 1950;
          const maxY = years.length ? Math.max(...years) : new Date().getFullYear();
          initYearSlider(minY, maxY);

          populateRegionOptions();

          // Default progress fill
          setProgress(1, 1);

          const missingCoords = records.filter(r => !Number.isFinite(r.lat) || !Number.isFinite(r.lon)).length;
          if(missingCoords){
            setStatus('warn', `Loaded ${records.length} rows. ${missingCoords} missing lat/lon (won't plot) — using Location geocoding as a fallback.`);
          } else {
            setStatus('ok', `Loaded ${records.length} rows. Ready.`);
          }

          render();
          fitToMarkers();
          fixMapSizeSoon();

          // Fallback: geocode rows missing lat/lon (rate-limited + cached)
          geocodeMissingCoords().finally(() => resolve());
        },
        error: (err) => reject(err)
      });
    });
  }

  ['input','change'].forEach(evt => {
    els.search.addEventListener(evt, () => render());
    els.region.addEventListener(evt, () => render());
    els.minCred.addEventListener(evt, () => render());
  });

  els.fitBtn.addEventListener('click', () => { fitToMarkers(); fixMapSizeSoon(); });
  els.resetBtn.addEventListener('click', () => {
    els.search.value = '';
    els.region.value = '';
    els.minCred.value = '3';
    const slider = els.yearSlider.noUiSlider;
    if(slider){
      const r = slider.options.range;
      slider.set([r.min, r.max]);
    }
    render();
    fitToMarkers();
  });

  loadFromGoogleSheets().catch(err => {
    console.error(err);
    setStatus('bad', (err && err.message) ? err.message : String(err));
  });
})();
</script>

</body>
</html>